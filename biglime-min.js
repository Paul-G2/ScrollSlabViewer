(function(c,t){c.Ui=function(){};c.Ui.DefaultFontFamily="verdana";c.Ui.Background="#7092BE";c.Ui.Foreground="#CCEEFE";c.Ui.UidCounter=1;c.Ui.CreateElement=function(d,a,e,b,f,g=!0){d=document.createElement(d);d.id=a;e&&e.append(d);c.Ui.StyleElement(d,b,f,g);return d};c.Ui.StyleElement=function(d,a,e,b=!0){if(a)for(var f in a)if(Object.prototype.hasOwnProperty.call(a,f)){var g=a[f];"number"===typeof g?g=g.toString()+"px":"string"===typeof g&&1<g.trim().length&&!isNaN(Number(g.slice(0,-1)))&&g.endsWith("n")&&
(g=Number(g.slice(0,-1)));d.style[f]=g}if(e)for(var h in e)Object.prototype.hasOwnProperty.call(e,h)&&(d[h]=e[h]);b&&(a&&a.hasOwnProperty("position")||(d.style.position="absolute"),a&&a.hasOwnProperty("margin")||(d.style.margin="0px"),a&&a.hasOwnProperty("padding")||(d.style.padding="0px"));return d};c.Ui.CreateButton=function(d,a,e){e=e||c.Ui.Foreground;var b="button_"+(c.Ui.UidCounter++).toString();d=c.Ui.CreateElement("div","button_div",d);c.Ui.CreateElement("button",b,d,{width:"100%",height:"100%",
border:"0",outline:"none",boxShadow:"none",fontSize:"14px",fontFamily:c.Ui.DefaultFontFamily,backgroundColor:e},{innerHTML:a});return d};c.Ui.CreateLoadButton=function(d={}){function a(h={}){return new Promise(k=>{const m=document.createElement("input");m.type="file";m.multiple=!!h.multiple;m.accept=h.types?.map(n=>n.accept).flatMap(n=>Object.keys(n).flatMap(l=>n[l])).join(",");m.files=null;m.addEventListener("change",()=>{k([...m.files])});m.addEventListener("cancel",()=>{k([])});m.click()})}"function"!==
typeof window.showOpenFilePicker&&(window.showOpenFilePicker=a);var e=d.styles||{};e.display=e.display||"flex";e.flexDirection=e.flexDirection||"row";e.textAlign=e.textAlign||"center";e.alignItems=e.alignItems||"center";e.justifyContent=e.justifyContent||"center";e.fontSize=e.fontSize||14;e.fontFamily=e.fontFamily||c.Ui.DefaultFontFamily;e.borderWidth=e.borderWidth||"0px";d.flatStyle&&(e.border=0,e.boxShadow="none",e.borderRadius="0px");d.text=d.text||"Load...";var b=c.Ui.CreateElement("button",d.id,
d.parent,e,{innerHTML:d.text});b.readyText=d.text;var f=d.dbTag||"biglimeRecentDirHandle",g=c.UtilityDb.Instance();g.get(f).then(h=>{b.mruDir=h?h.value:t});b.addEventListener(c.Utils.isTouchDevice()?"touchend":"click",async function(){if(!b.ignoreClicks){b.ignoreClicks=!0;try{var h=await showOpenFilePicker({multiple:d.multiple,startIn:b.mruDir instanceof FileSystemFileHandle?b.mruDir:t});b.ignoreClicks=!1;h&&0<h.length&&(g.put(f,h[0]),b.mruDir=h[0]);if(d.callback){let k=t;if(d.provideLoader){const m=
h.filter(n=>n.name.toLowerCase().endsWith(".tiff")||n.name.toLowerCase().endsWith(".tif")||n.name.toLowerCase().endsWith(".nrrd")||n.name.toLowerCase().endsWith(".dcm")||n.name.toLowerCase().endsWith(".dicom"));0<m.length&&(k=m[0].name.toLowerCase().endsWith(".nrrd")?new BigLime.NrrdLoader3D:m[0].name.toLowerCase().endsWith(".dcm")||m[0].name.toLowerCase().endsWith(".dicom")?new BigLime.DicomLoader3D:new BigLime.TiffLoader3D)}d.callback(h,k)}}catch(k){b.ignoreClicks=!1,k&&k.toString&&k.toString().includes("user aborted")||
c.Logger.Report("File picker error.\n"+k,c.Logger.Severity.Error)}}});return b};c.Ui.CreateSaveButton=function(d={}){var a=d.styles||{};a.display="flex";a.flexDirection="row";a.textAlign="center";a.alignItems="center";a.justifyContent="center";a.fontSize=a.fontSize||14;a.fontFamily=a.fontFamily||c.Ui.DefaultFontFamily;d.flatStyle&&(a.border=0,a.boxShadow="none",a.borderRadius="0px");a=c.Ui.CreateElement("button",d.id,d.parent,a,{innerHTML:d.text});var e=d.dbTag||"biglimeRecentDirHandle",b=d.suggestedName||
t;a.addEventListener(c.Utils.isTouchDevice()?"touchstart":"click",function(){var f=c.UtilityDb.Instance();f.get(e).then(g=>{g=g?g.value:t;var h=g instanceof FileSystemFileHandle?g.name:t;showSaveFilePicker({startIn:g,suggestedName:b||h}).then(k=>{k&&f.put(e,k);d.callback&&d.callback(k)}).catch(k=>{})})});return a};c.Ui.CreateButtonGroup=function(d,a,e,b,f,g){e=e||{};g=g||{};e.border=e.border===t?"1px solid #606060":e.border;a=c.Ui.CreateElement("div",d+"_host_div",a,e);var h=[],k=parseInt(a.style.height,
10),m=b.length,n=e.fontFamily||c.Ui.DefaultFontFamily;e=e.fontSize||24;var l=g.btnSize||24;k=(k-m*l)/(m+1);var p=!g.independent;g=0===g.btnLeft?0:g.btnLeft||e;for(var r=function(H){H.target.btn.click&&H.target.btn.click()},q=function(H){H.target.btn.dblclick&&H.target.btn.dblclick()},u=0;u<b.length;u++){var x=b[u],E=k+u*(k+l),y={type:p?"radio":"checkbox",name:p?d:1<m?d+"_"+x.value:t,value:x.value};x.checked&&(y.checked=!0);y=c.Ui.CreateElement("input",d+"_"+x.value+"_btn",a,{top:E,left:g,width:l,
height:l},y);f&&y.addEventListener("change",f);h.push(y);x=c.Ui.CreateElement("label","",a,{top:E+l/2-(e+2)/2,left:g+l+.5*e,fontSize:e,fontFamily:n},{innerHTML:x.label,btn:y});x.addEventListener("click",r);x.addEventListener("dblclick",q)}return{div:a,btns:h}};c.Ui.CreateHSlider=function(d,a,e,b,f,g,h,k,m){e.styles=e.styles||{};b.styles=b.styles||{};f.styles=f.styles||{};g.styles=g.styles||{};e.props=e.props||{};b.props=b.props||{};f.props=f.props||{};g.props=g.props||{};a=c.Ui.CreateElement("div",
d+"_div",a,e.styles,e.props);var n=e.styles.fontSize||18,l=parseInt(e.styles.height,10);f.styles.top=l/2-n/2;f.styles.textAlign="left";c.Ui.CreateElement("label","slider_label",a,f.styles,f.props);var p=b.props.hasOwnProperty("valueScale")?b.props.valueScale:1,r=b.props.hasOwnProperty("xfrm")?b.props.xfrm:function(E){return E*p};b.styles.left=f.styles.width+10;b.styles.height=e.styles.height;b.styles.width=e.styles.width-f.styles.width-g.styles.width-20;b.props.type="range";var q=c.Ui.CreateElement("input",
d+"_inp",a,b.styles,b.props);h&&q.addEventListener("input",function(){h(r(parseInt(q.value)))});k&&q.addEventListener(c.Utils.isTouchDevice()?"touchstart":"mousedown",k);m&&q.addEventListener(c.Utils.isTouchDevice()?"touchend":"mouseup",m);var u=b.props.decimals||0===b.props.decimals?b.props.decimals:2;g.props.innerHTML=r(parseInt(q.value)).toFixed(u).toString();g.styles.top=l/2-(n+2)/2;g.styles.right=0;g.styles.textAlign="left";var x=c.Ui.CreateElement("label","slider_val_label",a,g.styles,g.props);
q.valLabel=x;q.addEventListener("input",function(E){x.innerHTML=r(parseInt(q.value)).toFixed(u).toString()});return q};c.Ui.CreateNumericInput=function(d,a,e,b,f,g="change"){var h=c.Ui;e=e||{};e.display="flex";e.alignItems="center";a=h.CreateElement("div",d+"_div",a,e);b=b||{};var k=b.min||0===b.min?b.min:0,m=b.max||0===b.max?b.max:10,n=e.fontSize||18,l=e.inpWidth||5*n;d=h.CreateElement("input",d+"_inp",a,{height:"100%",width:l,fontSize:n,textAlign:e.textAlign||"center"},{type:"number",min:k.toString(),
max:m.toString(),value:(b.val||0===b.val?b.val:(m+k)/2).toString(),step:(b.step||0===b.step?b.step:(m-k)/10).toString()});f&&d.addEventListener(g,f);b.label&&h.CreateElement("label","lbl",a,{fontSize:n,left:l},{innerHTML:"&nbsp;&nbsp;"+b.label});return d};c.Ui.OnClickAndDoubleClick=function(d,a,e,b){d.Namespace={};d.Namespace.clicks=0;d.Namespace.clickTimer=d.Namespace.clickTimer||null;d.addEventListener("click",function(f){if(b){if(null===f.data||f.data===t)f.data={};for(var g in b)f.data[g]=b[g]}d.Namespace.clicks++;
1===d.Namespace.clicks?d.Namespace.clickTimer=setTimeout(function(){a(f);d.Namespace.clicks=0},300):(clearTimeout(d.Namespace.clickTimer),e(f),d.Namespace.clicks=0)});d.addEventListener("dblclick",function(f){f.preventDefault()})}})(window.BigLime=window.BigLime||{});
(function(c){function t(f,g){f=c(this);!0!==f.data("tap_event")&&f.bind("touchend.tap",a).bind("touchmove.tap",function(){b=!0}).data("tap_event",!0)}function d(f){c(this).unbind("touchend.tap touchmove.tap")}function a(f){if(b)return b=!1;var g=c(f.target),h=g.data("lastTouch")||0,k=f.timeStamp;h=k-h;if(20<h&&500>h)return clearTimeout(e),f.preventDefault(),g.data("lastTouch",0).trigger("doubleTap");g.data("lastTouch",k);e=setTimeout(function(){g.trigger("tap")},500)}if("undefined"!==typeof c){var e,
b=!1;c.event.special.doubleTap={setup:t,teardown:d,handler:a};c.event.special.tap={setup:t,teardown:d,handler:a}}})(window.jQuery);
(function(c,t){c.Color=function(d,a,e,b){"undefined"===typeof b&&(b=255);this.r=Math.round(Math.max(0,Math.min(255,d)));this.g=Math.round(Math.max(0,Math.min(255,a)));this.b=Math.round(Math.max(0,Math.min(255,e)));this.a=Math.round(Math.max(0,Math.min(255,b)))};c.Color.FromObj=function(d){return new c.Color(d.r,d.g,d.b,d.a)};c.Color.Clone=function(d){return new c.Color(d.r,d.g,d.b,d.a)};c.Color.prototype.valueEquals=function(d){return this===d?!0:d?this.r==d.r&&this.g==d.g&&this.b==d.b&&this.a==d.a:
!1};c.Color.AreEqual=function(d,a){return d&&a?d.r==a.r&&d.g==a.g&&d.b==a.b&&d.a==a.a:!1};c.Color.ScaleTo1=function(d){return[d.r/255,d.g/255,d.b/255,d.a/255]};c.Color.ToArray=function(d){return[d.r,d.g,d.b,d.a]};c.Color.prototype.toString=function(){return"("+this.r.toString()+", "+this.g.toString()+", "+this.b.toString()+", "+this.a.toString()+")"};c.Color.FromString=function(d){var a=new c.Color(0,0,0);try{var e=d.replace(/[()]/g,"").split(",");a=new c.Color(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),
parseInt(e[3]))}catch(b){c.Logger.Report("Color.FromString: invalid input string.",c.Logger.Severity.Warn)}return a};c.Color.ToHexString=function(d){return"#"+("0"+d.r.toString(16)).slice(-2).toUpperCase()+("0"+d.g.toString(16)).slice(-2).toUpperCase()+("0"+d.b.toString(16)).slice(-2).toUpperCase()};c.Color.ArrayToHexString=function(d){return"#"+("0"+d[0].toString(16)).slice(-2).toUpperCase()+("0"+d[1].toString(16)).slice(-2).toUpperCase()+("0"+d[2].toString(16)).slice(-2).toUpperCase()};c.Color.prototype.toHexString=
function(){return c.Color.ToHexString(this)};c.Color.FromHexString=function(d,a){d=d.replace("#","");d=parseInt(d,16);var e=new c.Color(0,0,0,255);e.r=d>>16&255;e.g=d>>8&255;e.b=d&255;e.a=a||0===a?a:255;return e};c.Color.FromName=function(d,a){try{var e=document.createElement("canvas").getContext("2d");e.fillStyle=d;var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e.fillStyle),f=new c.Color(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),255);a&&(f=c.Color.ScaleTo1(f));return f}catch(g){return c.Logger.Report("Color.NameToColor: Invalid color name.",
c.Logger.Severity.Warn),new c.Color(0,0,0,255)}};c.Color.Black=function(d){return d?new c.Color(0,0,0,1):new c.Color(0,0,0,255)};c.Color.White=function(d){return d?new c.Color(1,1,1,1):new c.Color(255,255,255,255)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Dialog=function(d){d=d||{};this.parent=d.parent||document.body;this.title=d.title||"";this.contentWidth=d.contentWidth;this.contentHeight=d.contentHeight;this.modal=d.modal;this.bkgndColor=d.bkgndColor||c.Dialog.BkgndColor;this.titleBarColor=d.titleBarColor||c.Dialog.TitleBarColor;this.borderWidth=d.borderWidth||0;this.borderColor=d.borderColor||"#000000";this.mainDiv=null;this.prevMouseLoc=[0,0];this.dragStartFunc=this._onDragStart.bind(this);this.dragMoveFunc=this._onDragMove.bind(this);
this.dragEndFunc=this._onDragEnd.bind(this);this.onCancel=this.onOk=null;this.neverBeenShown=!0;this._initUi()};c.Dialog.FontFamily=c.Ui.DefaultFontFamily;c.Dialog.BkgndColor="#D5BFA2";c.Dialog.TitleBarColor="#BEA074";c.Dialog.prototype.setContent=function(d){this.mainDiv.append(d);c.Ui.StyleElement(d,{position:"absolute",left:"0px",right:"0px",top:"32px",bottom:"0px"},{},!1)};c.Dialog.prototype._initUi=function(){var d=c.Ui;this.mainDiv=d.CreateElement("div","dialog_maindiv",this.parent,{position:"absolute",
width:this.contentWidth,height:this.contentHeight+32,display:"none",zIndex:"9",backgroundColor:this.bkgndColor,fontSize:"16px",fontFamily:c.Dialog.FontFamily,border:this.borderWidth?this.borderWidth+"px solid "+this.borderColor:"none"});this.titleDiv=d.CreateElement("div","dialog_titlediv",this.mainDiv,{position:"absolute",left:"0px",right:"32px",top:"0px",height:"32px",lineHeight:"32px",textAlign:"center",verticalAlign:"middle",backgroundColor:this.titleBarColor,fontSize:"16px",fontFamily:c.Dialog.FontFamily,
userSelect:"none",MsUserSelect:"none",MozUserSelect:"none",WebkitUserSelect:"none"},{innerHTML:this.title});this.mainDiv.addEventListener(c.Utils.isTouchDevice()?"touchstart":"mousedown",this.dragStartFunc);this.closeDiv=d.CreateElement("div","dialog_closediv",this.mainDiv,{position:"absolute",width:"32px",height:"32px",right:"0px",top:"0px",lineHeight:"32px",textAlign:"center",verticalAlign:"middle",backgroundColor:this.titleBarColor,fontSize:"16px",fontFamily:c.Dialog.FontFamily,userSelect:"none",
MsUserSelect:"none",MozUserSelect:"none",WebkitUserSelect:"none"},{innerHTML:"X"});this.closeDiv.addEventListener(c.Utils.isTouchDevice()?"touchstart":"click",this._onTitleBarClose.bind(this));this.closeDiv.addEventListener("mouseover",function(){this.closeDiv.style.fontWeight="bold"}.bind(this));this.closeDiv.addEventListener("mouseout",function(){this.closeDiv.style.fontWeight="normal"}.bind(this));this.escapeListener=function(a){a=a||window.event;if("key"in a?"Escape"===a.key||"Esc"===a.key:27===
a.keyCode)this.hide(),a.stopImmediatePropagation(),a.preventDefault()}.bind(this)};c.Dialog.prototype.show=function(d,a){d&&(this.onOk=d);a&&(this.onCancel=a);"none"==this.mainDiv.style.display&&(this.mainDiv.style.display="inline-block",this.neverBeenShown&&(this.neverBeenShown=!1,d=this.mainDiv.getBoundingClientRect(),a=this.parent.getBoundingClientRect(),c.Ui.StyleElement(this.mainDiv,{left:Math.max(0,(a.width-d.width)/2)+"px",top:Math.max(0,(a.height-d.height)/2)+"px"})),document.addEventListener("keydown",
this.escapeListener));this.trigger("shown")};c.Dialog.prototype.hide=function(){this.mainDiv.style.display="none";document.removeEventListener("keydown",this.escapeListener);this.trigger("hidden")};c.Dialog.prototype.isShown=function(){return"none"!=this.mainDiv.style.display};c.Dialog.prototype._onTitleBarClose=function(){if(this.onCancel)this.onCancel(this);this.hide()};c.Dialog.prototype._onDragStart=function(d){d=c.Dialog._getEventCoordinates(d);if(null!==d[0]&&null!==d[1]){var a=parseInt(this.titleDiv.style.height,
10),e=this.mainDiv.getBoundingClientRect();24<d[0]-e.left&&24<e.right-d[0]&&d[1]-e.top>a&&e.bottom-d[1]>a||(this.prevMouseLoc=[d[0],d[1]],c.Utils.isTouchDevice()?(document.addEventListener("touchmove",this.dragMoveFunc),document.addEventListener("touchend",this.dragEndFunc),document.addEventListener("touchcancel",this.dragEndFunc)):(document.addEventListener("mousemove",this.dragMoveFunc),document.addEventListener("mouseup",this.dragEndFunc)),this.dragging=!0)}};c.Dialog.prototype._onDragMove=function(d){if(this.dragging){var a=
c.Dialog._getEventCoordinates(d);if(null!==a[0]&&null!==a[1])try{d.preventDefault();var e=[a[0]-this.prevMouseLoc[0],a[1]-this.prevMouseLoc[1]];this.prevMouseLoc=[a[0],a[1]];var b=this.mainDiv.getBoundingClientRect(),f=c.Dialog._getElementWidth(this.parent),g=c.Dialog._getElementHeight(this.parent),h=Math.max(64-b.width,Math.min(f-64,parseInt(this.mainDiv.style.left,10)+e[0])),k=Math.max(64-b.height,Math.min(g-64,parseInt(this.mainDiv.style.top,10)+e[1]));this.mainDiv.style.left=h.toString()+"px";
this.mainDiv.style.top=k.toString()+"px"}catch(m){}}};c.Dialog.prototype._onDragEnd=function(d){this.dragging&&(this.dragging=!1,document.removeEventListener(c.Utils.isTouchDevice()?"touchmove":"mousemove",this.dragMoveFunc),document.removeEventListener(c.Utils.isTouchDevice()?"touchend touchcancel":"mouseup",this.dragEndFunc))};c.Dialog._getEventCoordinates=function(d){var a=d.clientX,e=d.clientY;if(("undefined"==typeof a||"undefined"==typeof e||null===a||null===e)&&c.Utils.isTouchDevice())for(var b of[d,
d.originalEvent])if(b&&b.targetTouches&&b.targetTouches.length){a=b.targetTouches[0].clientX;e=b.targetTouches[0].clientY;break}if("undefined"==typeof a||"undefined"==typeof e)a=e=null;return[a,e]};c.Dialog._getElementHeight=function(d){return parseFloat(d.getBoundingClientRect().height)||window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight};c.Dialog._getElementWidth=function(d){return parseFloat(d.getBoundingClientRect().width)||window.innerWidth||document.documentElement.clientWidth||
document.body.clientWidth};c.Dialog.prototype.addEventListener=function(d,a){c.Notifier.prototype.addEventListener.call(this,d,a)};c.Dialog.prototype.removeEventListener=function(d,a){c.Notifier.prototype.removeEventListener.call(this,d,a)};c.Dialog.prototype.trigger=function(d,a){c.Notifier.prototype.trigger.call(this,d,a)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.FpsAnimator=function(d,a){this.fps=d||10;this.drawFunc=a;this.loopFunc=this._loop.bind(this);this.isPlaying=!1;this.frame=-1;this.rafId=this.time=null};c.FpsAnimator.prototype.start=function(){this.isPlaying||(this.isPlaying=!0,this.rafId=c.Utils.requestAnimFrame(this.loopFunc))};c.FpsAnimator.prototype.stop=function(){this.isPlaying&&(c.Utils.cancelAnimFrame(this.rafId),this.isPlaying=!1,this.time=null,this.frame=-1)};c.FpsAnimator.prototype.setFrameRate=function(d){this.fps=d};
c.FpsAnimator.prototype._loop=function(d){null===this.time&&(this.time=d);d=Math.floor((d-this.time)*this.fps/1E3);d>this.frame&&(this.frame=d,this.drawFunc());this.rafId=requestAnimationFrame(this.loopFunc)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Logger=function(){};c.Logger.Severity={Debug:0,Info:1,Client:2,Warning:3,Warn:3,Error:4};Object.freeze(c.Logger.Severity);c.Logger.ConsoleThresh=c.Logger.Severity.Info;c.Logger._MaxIncidents=1E3;c.Logger._IncidentList=[];c.Logger._NumErrors=0;c.Logger._NumWarnings=0;c.Logger.Report=function(d,a,e,b){var f=c.Logger.Severity;d=d||"";a>=f.Debug&&a<=f.Error||(a=f.Error);for(;c.Logger._IncidentList.length>=c.Logger._MaxIncidents;)c.Logger._IncidentList.shift();c.Logger._IncidentList.push({msg:d,
severity:a});a===f.Error&&c.Logger._NumErrors++;a===f.Warn&&c.Logger._NumWarnings++;a>=c.Logger.ConsoleThresh&&window.console&&(a=(a=a<=f.Debug?window.console.debug:a==f.Info||a==f.Client?window.console.info:a==f.Warn?window.console.warn:window.console.error)||window.console.log)&&a(d);if(b)throw Error(d);!0===e&&alert(d)};c.Logger.Clear=function(){c.Logger._IncidentList=[];c.Logger._NumErrors=0;c.Logger._NumWarnings=0};c.Logger.NumIncidents=function(){return c.Logger._IncidentList.length};c.Logger.NumErrors=
function(){return c.Logger._NumErrors};c.Logger.NumWarnings=function(){return c.Logger._NumWarnings};c.Logger.LastIncident=function(){var d=c.Logger._IncidentList.length;return 0<d?c.Logger._IncidentList[d-1]:null};c.Logger.LastErrorMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Error)return a.msg}return""};c.Logger.LastWarningMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];
if(a.severity===c.Logger.Severity.Warn)return a.msg}return""};c.Logger.LastDebugMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Debug)return a.msg}return""};c.Logger.LastInfoMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Info)return a.msg}return""}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Notifier=function(){};c.Notifier.prototype.addEventListener=function(d,a){this.listeners=this.listeners||{};d=d.split(/[ ,]+/);for(var e=0;e<d.length;e++){var b=d[e];this.listeners.hasOwnProperty(b)||(this.listeners[b]=[]);this.listeners[b].push(a)}};c.Notifier.prototype.removeEventListener=function(d,a){this.listeners=this.listeners||{};d=d.split(/[ ,]+/);for(var e=function(g){return g!=a},b=0;b<d.length;b++){var f=d[b];this.listeners.hasOwnProperty(f)&&(this.listeners[f]=this.listeners[f].filter(e),
0==this.listeners[f].length&&delete this.listeners[f])}};c.Notifier.prototype.trigger=function(d,a){this.listeners=this.listeners||{};if(this.listeners.hasOwnProperty(d))for(var e=this.listeners[d].slice(),b=0;b<e.length;b++)e[b]&&(a=a||{},a.currentTarget=this,e[b](new CustomEvent(d,{detail:a})));if(this.listeners.hasOwnProperty("AllEvents"))for(e=this.listeners.AllEvents.slice(),b=0;b<e.length;b++)e[b]&&(a=a||{},a.currentTarget=this,e[b](new CustomEvent(d,{detail:a})))}})(window.BigLime=window.BigLime||
{});
(function(c,t){c.UtilityDb=function(){if(c.UtilityDbInstance_)throw Error("UtilityDb is a singleton. Use the Instance() method to access it.");this.innerDb=new Dexie(c.UtilityDbName);this.innerDb.version(1).stores({TagValuePairs:"tag, value"})};c.UtilityDbName="BigLimeDB";c.UtilityDbInstance_=null;c.UtilityDb.Instance=function(){c.UtilityDbInstance_||(c.UtilityDbInstance_=new c.UtilityDb);return c.UtilityDbInstance_};c.UtilityDb.prototype.get=function(d){return this.innerDb.TagValuePairs.get(d)};c.UtilityDb.prototype.put=
function(d,a){this.innerDb.TagValuePairs.put({tag:d,value:a})};c.UtilityDb.prototype.delete=function(d){this.innerDb.TagValuePairs.delete(d)}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.mat4;c.Utils=c.Utils||{};c.Utils.requestAnimFrame=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,50)}).bind(window);c.Utils.cancelAnimFrame=(window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.oCancelAnimationFrame||
window.msCancelAnimationFrame||window.clearTimeout).bind(window);c.Utils.isTouchDevice=function(){return"ontouchstart"in document.documentElement||window.navigator.msMaxTouchPoints};c.Utils.getBuildInfo=function(){return"16-Dec-2025 17:26"};c.Utils.isString=function(b){return"string"===typeof b||b instanceof String};c.Utils.isStringy=function(b){return c.isString(b)||$.isArray(b)&&b.length&&c.isString(b[0])};c.Utils.ReadFile=function(b,f="text"){return new Promise((g,h)=>{if(!(b instanceof Blob))throw Error("Utils.ReadFile: file must be a File or Blob");
var k=new FileReader;k.onload=()=>{g(k.result)};k.onerror=m=>{h(m)};f=f.toLowerCase();if("text"===f)k.readAsText(b);else if("arraybuffer"===f)k.readAsArrayBuffer(b);else if("dataurl"===f)k.readAsDataURL(b);else throw Error("Unsupported type, in Utils.ReadFile");})};c.Utils.getFileExtension=function(b){b=b.split(".");return 1>=b.length?"":b[b.length-1]};c.Utils.SafeInvoke=function(b,f,g={}){if(b)try{f?b(...f):b()}catch(h){g.ignoreErrors||c.Logger.Report(h.message||"Error.",g.severity===t?c.Logger.Severity.Error:
g.severity,g.popup===t?!0:!!g.popup,!!g.throwOnFailure)}};c.Utils.GetUrlArgs=function(){var b={},f=window.location.search.substring(1).split("&"),g;for(g of f)try{if(""!==g){var h=g.split("=");b[decodeURIComponent(h[0]).toLowerCase()]=decodeURIComponent(h[1]||"")}}catch(k){}return b};c.Utils.floatEquals=function(b,f,g){"undefined"===typeof g&&(g=1E-6);return Math.abs(b-f)<=g*Math.max(1,Math.abs(b),Math.abs(f))};c.Utils.GetRotMatrix=function(b,f,g){b=a.normalize(a.create(),b);f=a.normalize(a.create(),
f);var h=a.cross(a.create(),b,f);if(.001<Math.abs(a.dot(b,f)))return c.Logger.Report("Non-orthogonal orientation vectors passed to Utils.GetRotMatrix.",c.Logger.Severity.Error),g?e.identity(g):e.create();b=[b[0],f[0],h[0],0,b[1],f[1],h[1],0,b[2],f[2],h[2],0,0,0,0,1];return g?e.set(g,...b):e.fromValues(...b)};c.Utils.CalcRotAngle=function(b,f,g){if(d.equals(f,b)||d.equals(b,g)||d.equals(f,g))return 0;b=d.subtract(d.create(),b,g);f=d.subtract(d.create(),f,g);g=d.dot(b,f)/(d.length(b)*d.length(f));g=
Math.acos(Math.min(1,Math.max(-1,g)));return g=f[1]*b[0]>f[0]*b[1]?-g:g};c.Utils.DrawLine=function(b,f,g,h={}){b=b.getContext("2d");h.lineWidth&&(b.lineWidth=h.lineWidth);h.strokeStyle&&(b.strokeStyle=h.strokeStyle);b.beginPath();b.moveTo(f[0],f[1]);b.lineTo(g[0],g[1]);b.stroke()};c.Utils.DrawCircle=function(b,f,g,h={}){b=b.getContext("2d");h.lineWidth&&(b.lineWidth=h.lineWidth);h.strokeStyle&&(b.strokeStyle=h.strokeStyle);h.fillStyle&&(b.fillStyle=h.fillStyle);b.beginPath();b.arc(f[0],f[1],g,0,2*
Math.PI);h.fill?b.fill():b.stroke()};c.Utils.SwapByteOrder=function(b,f){b=new Uint8Array(b.buffer||b);var g=b.length,h;if(2===f)for(h=0;h<g;h+=2)f=b[h],b[h]=b[h+1],b[h+1]=f;else if(4===f)for(h=0;h<g;h+=4)f=b[h],b[h]=b[h+3],b[h+3]=f,f=b[h+1],b[h+1]=b[h+2],b[h+2]=f;else c.Logger.Report("Unsupported object size, in Utils.SwapByteOrder",c.Logger.Severity.Error)};c.Utils.SquaredDistanceToLineSegment=function(b,f,g){g=[g[0]-f[0],g[1]-f[1]];var h=g[0]**2+g[1]**2;if(1E-16>h)return(b[0]-f[0])**2+(b[1]-f[1])**
2;h=((b[0]-f[0])*g[0]+(b[1]-f[1])*g[1])/h;h=Math.max(0,Math.min(1,h));f=[f[0]+h*g[0],f[1]+h*g[1]];return(b[0]-f[0])**2+(b[1]-f[1])**2};c.Utils.PointInPolygon=function(b,f){for(var g=!1,h=f.length,k=0,m=h-1;k<h;m=k++){var n=f[k];m=f[m];var l=(m[1]-n[1])*(b[0]-n[0]),p=(m[0]-n[0])*(b[1]-n[1]);if(n[1]<=b[1]&&b[1]<m[1]&&l<p||m[1]<=b[1]&&b[1]<n[1]&&l>p)g=!g}return g}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Geometry=function(){};c.Geometry.convexHull=function(d){if(!d||1>=d.length)return d?d.slice():null;var a=!1;d[0].hasOwnProperty("x")||(d=d.map(function(n){return{x:n[0],y:n[1]}}),a=!0);d=d.slice();d.sort(function(n,l){return n.x<l.x?-1:n.x>l.x?1:n.y<l.y?-1:n.y>l.y?1:0});var e,b,f=d.length,g=[];for(e=0;e<f;e++){for(b=d[e];2<=g.length;){var h=g[g.length-1];var k=g[g.length-2];if((h.x-k.x)*(b.y-k.y)>=(h.y-k.y)*(b.x-k.x))g.pop();else break}g.push(b)}g.pop();var m=[];for(e=f-1;0<=e;e--){for(b=
d[e];2<=m.length;)if(h=m[m.length-1],k=m[m.length-2],(h.x-k.x)*(b.y-k.y)>=(h.y-k.y)*(b.x-k.x))m.pop();else break;m.push(b)}m.pop();d=1===g.length&&1===m.length&&g[0].x===m[0].x&&g[0].y===m[0].y?g:g.concat(m);a&&(d=d.map(function(n){return[n.x,n.y]}));return d}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Logger=function(){};c.Logger.Severity={Debug:0,Info:1,Client:2,Warning:3,Warn:3,Error:4};Object.freeze(c.Logger.Severity);c.Logger.ConsoleThresh=c.Logger.Severity.Info;c.Logger._MaxIncidents=1E3;c.Logger._IncidentList=[];c.Logger._NumErrors=0;c.Logger._NumWarnings=0;c.Logger.Report=function(d,a,e,b){var f=c.Logger.Severity;d=d||"";a>=f.Debug&&a<=f.Error||(a=f.Error);for(;c.Logger._IncidentList.length>=c.Logger._MaxIncidents;)c.Logger._IncidentList.shift();c.Logger._IncidentList.push({msg:d,
severity:a});a===f.Error&&c.Logger._NumErrors++;a===f.Warn&&c.Logger._NumWarnings++;a>=c.Logger.ConsoleThresh&&window.console&&(a=(a=a<=f.Debug?window.console.debug:a==f.Info||a==f.Client?window.console.info:a==f.Warn?window.console.warn:window.console.error)||window.console.log)&&a(d);if(b)throw Error(d);!0===e&&alert(d)};c.Logger.Clear=function(){c.Logger._IncidentList=[];c.Logger._NumErrors=0;c.Logger._NumWarnings=0};c.Logger.NumIncidents=function(){return c.Logger._IncidentList.length};c.Logger.NumErrors=
function(){return c.Logger._NumErrors};c.Logger.NumWarnings=function(){return c.Logger._NumWarnings};c.Logger.LastIncident=function(){var d=c.Logger._IncidentList.length;return 0<d?c.Logger._IncidentList[d-1]:null};c.Logger.LastErrorMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Error)return a.msg}return""};c.Logger.LastWarningMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];
if(a.severity===c.Logger.Severity.Warn)return a.msg}return""};c.Logger.LastDebugMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Debug)return a.msg}return""};c.Logger.LastInfoMsg=function(){for(var d=c.Logger._IncidentList.length-1;0<=d;d--){var a=c.Logger._IncidentList[d];if(a.severity===c.Logger.Severity.Info)return a.msg}return""}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Loader3D=function(){this.vol=null;this.done=this.cancelled=!1;this.loadProgressCb=this.loadCompleteCb=this.rgbaBuf=null;this.warnings=this.errors=""};c.Loader3D.prototype.cancelLoading=function(){this.cancelled=!0};c.Loader3D.prototype._copyImagesToTexture=function(d){var a=this.vol,e=a.context.gl,b=a.dims[0],f=a.dims[1],g=8==a.bpp?e.RED:e.RG,h=e.createBuffer();e.bindBuffer(e.PIXEL_UNPACK_BUFFER,h);for(var k=d.startIndex;k<d.endIndex;k++){var m=d.imgBuffers[k-d.startIndex];m.buffer&&
(m=m.buffer);16==a.bpp&&a.bigEndian&&c.Loader3D._SwapByteOrder(m);e.bufferData(e.PIXEL_UNPACK_BUFFER,m,e.DYNAMIC_COPY);a.texture.bind();e.texSubImage3D(e.TEXTURE_3D,0,0,0,k,b,f,1,g,e.UNSIGNED_BYTE,0);a.histogram.addImage(m,a.bpp/8,!1)}e.bindBuffer(e.PIXEL_UNPACK_BUFFER,null);e.deleteBuffer(h)};c.Loader3D.prototype._populateRgbaBuffer_From16bitImages=function(d){var a=this.vol,e=a.dims[0],b=a.dims[1],f=e*b,g=d.endIndex-d.startIndex,h,k=[];for(h=0;h<g;h++)k.push(d.imgBuffers[h].buffer||d.imgBuffers[h]);
d=(b-1)*e;for(h=0;h<g;h++){for(var m=new Uint16Array(k[h]),n=0;n<b;n++){var l=n*e;m[l]=m[l+e-1]=0}for(n=0;n<e;n++)m[n]=m[d+n]=0}e=[];e.push(0<g?new Uint8Array(k[0]):null);e.push(1<g?new Uint8Array(k[1]):null);b=0;d=2*f;for(h=0;h<d;h+=2)for(f=0;2>f;f++)e[f]?(this.rgbaBuf[b++]=a.bigEndian?e[f][h+1]:e[f][h],this.rgbaBuf[b++]=a.bigEndian?e[f][h]:e[f][h+1]):(this.rgbaBuf[b++]=0,this.rgbaBuf[b++]=0);for(h=0;2>h;h++)h<g&&a.histogram.addImage(k[h],a.bpp/8,a.bigEndian)};c.Loader3D.prototype._populateRgbaBuffer_From8bitImages=
function(d){var a=this.vol,e=a.dims[0],b=a.dims[1],f=e*b,g=d.imgBuffers.length,h,k=[];for(h=0;h<g;h++)k.push(d.imgBuffers[h].buffer||d.imgBuffers[h]);d=(b-1)*e;for(h=0;h<g;h++){for(var m=new Uint8Array(k[h]),n=0;n<b;n++){var l=n*e;m[l]=m[l+e-1]=0}for(n=0;n<e;n++)m[n]=m[d+n]=0}e=[];e.push(0<g?new Uint8Array(k[0]):null);e.push(1<g?new Uint8Array(k[1]):null);e.push(2<g?new Uint8Array(k[2]):null);e.push(3<g?new Uint8Array(k[3]):null);for(h=b=0;h<f;h++)for(d=0;4>d;d++)this.rgbaBuf[b++]=e[d]?e[d][h]:0;
for(h=0;4>h;h++)h<g&&a.histogram.addImage(k[h],a.bpp/8,a.bigEndian)};c.Loader3D._SwapByteOrder=function(d){d=new Uint8Array(d.buffer||d);for(var a=d.length,e=0;e<a;e+=2){var b=d[e];d[e]=d[e+1];d[e+1]=b}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2;c.Interactor=function(a,e,b){this.eventSources=Array.isArray(a)?a:[a];this.name=e||"";this.eventTypes=b||{btns:0,shift:!1,ctrl:!1,alt:!1};this.isTouchDevice=c.Utils.isTouchDevice();this.enabled=!0;this.pinching=this.active=!1;this.currNumTouches=0;this.currentEventSource=null;this.prevPoint=d.create();this.currPoint=d.create();this.startPoint=d.create();this.deltaPrev=d.create();this.deltaStart=d.create();this.prevPinch={sep:1,ctr:d.create(),ang:0};this.currPinch=
{sep:1,ctr:d.create(),ang:0};this.startPinch={sep:1,ctr:d.create(),ang:0};this.deltaPrevPinch={sep:0,ctr:d.create(),ang:0};this.deltaStartPinch={sep:0,ctr:d.create(),ang:0};this.isTouchDevice?(this.touchStartListener=this._onStartBase.bind(this),this.touchMoveListener=this._onMoveBase.bind(this),this.touchEndListener=this._onEndBase.bind(this),this.eventSources.forEach(f=>f.addEventListener("touchstart",this.touchStartListener)),this.eventSources.forEach(f=>f.addEventListener("touchmove",this.touchMoveListener)),
this.eventSources.forEach(f=>f.addEventListener("touchend",this.touchEndListener))):(this.mouseDownListener=this._onStartBase.bind(this),this.mouseMoveListener=this._onMoveBase.bind(this),this.mouseUpListener=this._onEndBase.bind(this),this.eventSources.forEach(f=>f.addEventListener("mousedown",this.mouseDownListener)),document.addEventListener("mousemove",this.mouseMoveListener),document.addEventListener("mouseup",this.mouseUpListener))};c.Interactor.prototype.stopListening=function(){this.touchStartListener&&
this.eventSources.forEach(a=>a.removeEventListener("touchstart",this.touchStartListener));this.touchMoveListener&&this.eventSources.forEach(a=>a.removeEventListener("touchmove",this.touchMoveListener));this.touchEndListener&&this.eventSources.forEach(a=>a.removeEventListener("touchend",this.touchEndListener));this.mouseDownListener&&this.eventSources.forEach(a=>a.removeEventListener("mousedown",this.mouseDownListener));this.mouseMoveListener&&document.removeEventListener("mousemove",this.mouseMoveListener);
this.mouseUpListener&&document.removeEventListener("mouseup",this.mouseUpListener)};c.Interactor.prototype._onStartBase=function(a){this.enabled&&!this.active&&c.Interactor.MouseEventMatches(a,this.eventTypes)&&(this.currentEventSource=a.currentTarget,this._updateStateFromEvent(a),1<=this.currNumTouches?(this.active=!0,d.copy(this.startPoint,this.currPoint),d.copy(this.prevPoint,this.currPoint),d.set(this.deltaPrev,0,0),d.set(this.deltaStart,0,0),2<=this.currNumTouches&&(this.pinching=!0,c.Interactor._copyPinchInfo(this.startPinch,
this.currPinch),c.Interactor._copyPinchInfo(this.prevPinch,this.currPinch),c.Interactor._zeroPinchInfo(this.deltaPrevPinch),c.Interactor._zeroPinchInfo(this.deltaStartPinch)),this._onStart?this._onStart(a):this.trigger("start",{origEvent:a})):this.currentEventSource=null,a.preventDefault())};c.Interactor.prototype._onMoveBase=function(a){this.enabled&&this.active&&this.currentEventSource&&(this._updateStateFromEvent(a),this._onMove?this._onMove(a):this.trigger("move",{origEvent:a}),d.copy(this.prevPoint,
this.currPoint),2<=this.currNumTouches&&c.Interactor._copyPinchInfo(this.prevPinch,this.currPinch),a.preventDefault())};c.Interactor.prototype._onEndBase=function(a){this.enabled&&this.active&&this.currentEventSource&&(this._updateStateFromEvent(a),this._onEnd?this._onEnd(a):this.trigger("end",{origEvent:a}),this.pinching=this.active=!1,this.currentEventSource=null,a.preventDefault())};c.Interactor.MouseEventMatches=function(a,e){if(!e)return!1;Array.isArray(e)||(e=[e]);for(const b of e)if((!a.button&&
0!==a.button||(Array.isArray(b.btns)?b.btns:[b.btns]).some(f=>f===a.button))&&!(b.shift!==t&&b.shift!==a.shiftKey||b.ctrl!==t&&b.ctrl!==(a.ctrlKey||a.metaKey)||b.alt!==t&&b.alt!==a.altKey))return!0;return!1};c.Interactor.prototype._updateStateFromEvent=function(a){a=c.Interactor._getEventCoordinates(a);if(null===a[0]||null===a[1])this.currNumTouches=0;else{this.currNumTouches=1;var e=this.currentEventSource.getBoundingClientRect();d.set(this.currPoint,a[0]-e.left,a[1]-e.top);d.subtract(this.deltaPrev,
this.currPoint,this.prevPoint);d.subtract(this.deltaStart,this.currPoint,this.startPoint);if(null!==a[2]&&null!==a[3]){this.currNumTouches=2;e=a[0];var b=a[1],f=a[2];a=a[3];d.set(this.currPinch.ctr,(e+f)/2,(b+a)/2);this.currPinch.sep=Math.sqrt((f-e)*(f-e)+(a-b)*(a-b));this.currPinch.ang=Math.atan2(b-a,f-e);d.subtract(this.deltaPrevPinch.ctr,this.currPinch.ctr,this.prevPinch.ctr);d.subtract(this.deltaStartPinch.ctr,this.currPinch.ctr,this.startPinch.ctr);this.deltaPrevPinch.sep=this.currPinch.sep-
this.prevPinch.sep;this.deltaStartPinch.sep=this.currPinch.sep-this.startPinch.sep;this.deltaPrevPinch.ang=this.currPinch.ang-this.prevPinch.ang;this.deltaStartPinch.ang=this.currPinch.ang-this.startPinch.ang}}};c.Interactor._getEventCoordinates=function(a){var e=a.clientX,b=a.clientY,f=null,g=null;("undefined"==typeof e||"undefined"==typeof b||null===e||null===b)&&(a=a.targetTouches&&a.targetTouches.length?a:a.originalEvent)&&a.targetTouches&&a.targetTouches.length&&(e=a.targetTouches[0].clientX,
b=a.targetTouches[0].clientY,1<a.targetTouches.length&&(f=a.targetTouches[1].clientX,g=a.targetTouches[1].clientY));if("undefined"==typeof e||"undefined"==typeof b)e=b=f=g=null;return[e,b,f,g]};c.Interactor._copyPinchInfo=function(a,e){a.sep=e.sep;a.ang=e.ang;d.copy(a.ctr,e.ctr)};c.Interactor._zeroPinchInfo=function(a){a.sep=0;a.ang=0;d.set(a.ctr,0,0)};c.Interactor.prototype.addEventListener=function(a,e){c.Notifier.prototype.addEventListener.call(this,a,e)};c.Interactor.prototype.removeEventListener=
function(a,e){c.Notifier.prototype.removeEventListener.call(this,a,e)};c.Interactor.prototype.trigger=function(a,e){c.Notifier.prototype.trigger.call(this,a,e)}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.AttributeBuffer=function(a,e,b,f){f=f||{};b=b||3;var g=a.gl;this.context=a;this.attrDim=b;this.drawMode=f.drawMode||g.STATIC_DRAW;this.dataType=f.dataType||g.FLOAT;this.normalizeValues=!!f.normalizeValues;this.bytesPerVertex=b*this.context.sizeOf(this.dataType);this.numBytes=0;this.glBuffer=null;1!==b&&2!==b&&3!==b&&4!==b?c.Logger.Report("AttributeBuffer.ctor: Invalid attribute dimension.",d.Error):(a=this._coerceData(e))?(this.numBytes=a.buffer?a.buffer.byteLength:
a.byteLength,this.glBuffer=g.createBuffer(),g.bindBuffer(g.ARRAY_BUFFER,this.glBuffer),g.bufferData(g.ARRAY_BUFFER,a,this.drawMode),g.bindBuffer(g.ARRAY_BUFFER,null)):c.Logger.Report("AttributeBuffer.ctor: Invalid data array.",d.Error)};c.AttributeBuffer.prototype.destroy=function(){if(this.context){if(this.glBuffer){var a=this.context.gl;a.bindBuffer(a.ARRAY_BUFFER,this.glBuffer);a.bufferData(a.ARRAY_BUFFER,1,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);a.deleteBuffer(this.glBuffer);this.glBuffer=
null}this.context=null}};c.AttributeBuffer.prototype._coerceData=function(a){var e=this.context.gl;try{if(this.dataType===e.FLOAT)return a instanceof Float32Array?a:new Float32Array(a);if(this.dataType===e.UNSIGNED_SHORT)return a instanceof Uint16Array?a:new Uint16Array(a);if(this.dataType===e.UNSIGNED_BYTE)return a instanceof Uint8Array?a:new Uint8Array(a);if(this.dataType===e.SHORT)return a instanceof Int16Array?a:new Int16Array(a);if(this.dataType===e.BYTE)return a instanceof Int8Array?a:new Int8Array(a);
if(this.dataType===e.HALF_FLOAT)return a}catch(b){}return null};c.AttributeBuffer.prototype.setData=function(a){if(a=this._coerceData(a)){this.numBytes=a.buffer?a.buffer.byteLength:a.byteLength;var e=this.context.gl;e.bindBuffer(e.ARRAY_BUFFER,this.glBuffer);e.bufferData(e.ARRAY_BUFFER,a,this.drawMode);e.bindBuffer(e.ARRAY_BUFFER,null)}else c.Logger.Report("AttributeBuffer.setData: Invalid data array.",d.Error)};c.AttributeBuffer.prototype.subData=function(a,e){if(a=this._coerceData(a)){var b=this.context.gl;
b.bindBuffer(b.ARRAY_BUFFER,this.glBuffer);b.bufferSubData(b.ARRAY_BUFFER,e||0,a);b.bindBuffer(b.ARRAY_BUFFER,null)}else c.Logger.Report("AttributeBuffer.subData: Invalid data array.",d.Error)}})(window.BigLime=window.BigLime||{});(function(c,t){c.Interp3D={NN:1,BiLinear:2,TriLinear:3};Object.freeze(c.Interp3D);c.RenderType={MIP:1,VR:2,XRAY:3};Object.freeze(c.RenderType)})(window.BigLime=window.BigLime||{});
(function(c,t){c.DebugUtils=function(){function d(l){if(null===m){m={};n={};for(var p in l)"number"==typeof l[p]&&(m[l[p]]=p,n[p]=l[p])}}function a(){if(null===m)throw"WebGLDebugUtils.init(ctx) not called";}function e(l){a();var p=m[l];return p!==t?"gl."+p:"/*UNKNOWN WebGL ENUM*/ 0x"+l.toString(16)}function b(l,p,r,q){l=k[l];if(l!==t&&(l=l[p],l!==t&&l[r])){if("object"===typeof l[r]&&l[r].enumBitwiseOr!==t){p=l[r].enumBitwiseOr;r=0;l=[];for(var u=0;u<p.length;++u){var x=n[p[u]];0!==(q&x)&&(r|=x,l.push(e(x)))}return r===
q?l.join(" | "):e(q)}return e(q)}return null===q?"null":q===t?"undefined":q.toString()}function f(l,p,r){l.__defineGetter__(r,function(){return p[r]});l.__defineSetter__(r,function(q){p[r]=q})}function g(l,p,r,q){function u(B,z){return function(){r&&r(z,arguments);var J=B[z].apply(B,arguments),A=q.getError();0!==A&&(x[A]=!0,p(A,z,arguments));return J}}q=q||l;d(l);p=p||function(B,z,J){for(var A="",L=J.length,I=0;I<L;++I)A+=(0===I?"":", ")+b(z,L,I,J[I]);B="WebGL error "+e(B)+" in "+z+"("+A+")";window.console&&
window.console.error?window.console.error(B):window.console&&window.console.log&&window.console.log(B)};var x={},E={},y;for(y in l)if("function"==typeof l[y])if("getExtension"!=y)E[y]=u(l,y);else{var H=u(l,y);E[y]=function(){var B=H.apply(l,arguments);return B?g(B,p,r,q):null}}else f(E,l,y);E.getError=function(){for(var B in x)if(x.hasOwnProperty(B)&&x[B])return x[B]=!1,B;return l.NO_ERROR};return E}function h(l){var p=!!l.createTransformFeedback;p&&l.bindVertexArray(null);var r=l.getParameter(l.MAX_VERTEX_ATTRIBS),
q=l.createBuffer(),u;l.bindBuffer(l.ARRAY_BUFFER,q);for(u=0;u<r;++u)l.disableVertexAttribArray(u),l.vertexAttribPointer(u,4,l.FLOAT,!1,0,0),l.vertexAttrib1f(u,0),p&&l.vertexAttribDivisor(u,0);l.deleteBuffer(q);r=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);for(u=0;u<r;++u)l.activeTexture(l.TEXTURE0+u),l.bindTexture(l.TEXTURE_CUBE_MAP,null),l.bindTexture(l.TEXTURE_2D,null),p&&(l.bindTexture(l.TEXTURE_2D_ARRAY,null),l.bindTexture(l.TEXTURE_3D,null),l.bindSampler(u,null));l.activeTexture(l.TEXTURE0);l.useProgram(null);
l.bindBuffer(l.ARRAY_BUFFER,null);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null);l.bindFramebuffer(l.FRAMEBUFFER,null);l.bindRenderbuffer(l.RENDERBUFFER,null);l.disable(l.BLEND);l.disable(l.CULL_FACE);l.disable(l.DEPTH_TEST);l.disable(l.DITHER);l.disable(l.SCISSOR_TEST);l.blendColor(0,0,0,0);l.blendEquation(l.FUNC_ADD);l.blendFunc(l.ONE,l.ZERO);l.clearColor(0,0,0,0);l.clearDepth(1);l.clearStencil(-1);l.colorMask(!0,!0,!0,!0);l.cullFace(l.BACK);l.depthFunc(l.LESS);l.depthMask(!0);l.depthRange(0,1);l.frontFace(l.CCW);
l.hint(l.GENERATE_MIPMAP_HINT,l.DONT_CARE);l.lineWidth(1);l.pixelStorei(l.PACK_ALIGNMENT,4);l.pixelStorei(l.UNPACK_ALIGNMENT,4);l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1);l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);l.UNPACK_COLORSPACE_CONVERSION_WEBGL&&l.pixelStorei(l.UNPACK_COLORSPACE_CONVERSION_WEBGL,l.BROWSER_DEFAULT_WEBGL);l.polygonOffset(0,0);l.sampleCoverage(1,!1);l.scissor(0,0,l.canvas.width,l.canvas.height);l.stencilFunc(l.ALWAYS,0,4294967295);l.stencilMask(4294967295);l.stencilOp(l.KEEP,
l.KEEP,l.KEEP);l.viewport(0,0,l.canvas.width,l.canvas.height);l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT|l.STENCIL_BUFFER_BIT);if(p){l.drawBuffers([l.BACK]);l.readBuffer(l.BACK);l.bindBuffer(l.COPY_READ_BUFFER,null);l.bindBuffer(l.COPY_WRITE_BUFFER,null);l.bindBuffer(l.PIXEL_PACK_BUFFER,null);l.bindBuffer(l.PIXEL_UNPACK_BUFFER,null);p=l.getParameter(l.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS);for(u=0;u<p;++u)l.bindBufferBase(l.TRANSFORM_FEEDBACK_BUFFER,u,null);p=l.getParameter(l.MAX_UNIFORM_BUFFER_BINDINGS);
for(u=0;u<p;++u)l.bindBufferBase(l.UNIFORM_BUFFER,u,null);l.disable(l.RASTERIZER_DISCARD);l.pixelStorei(l.UNPACK_IMAGE_HEIGHT,0);l.pixelStorei(l.UNPACK_SKIP_IMAGES,0);l.pixelStorei(l.UNPACK_ROW_LENGTH,0);l.pixelStorei(l.UNPACK_SKIP_ROWS,0);l.pixelStorei(l.UNPACK_SKIP_PIXELS,0);l.pixelStorei(l.PACK_ROW_LENGTH,0);l.pixelStorei(l.PACK_SKIP_ROWS,0);l.pixelStorei(l.PACK_SKIP_PIXELS,0);l.hint(l.FRAGMENT_SHADER_DERIVATIVE_HINT,l.DONT_CARE)}for(;l.getError(););}var k={enable:{1:{0:!0}},disable:{1:{0:!0}},
getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},bindBuffer:{2:{0:!0}},
getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,
1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}},bufferData:{3:{0:!0,2:!0},4:{0:!0,2:!0},5:{0:!0,2:!0}},bufferSubData:{3:{0:!0},
4:{0:!0},5:{0:!0}},copyBufferSubData:{5:{0:!0,1:!0}},getBufferSubData:{3:{0:!0},4:{0:!0},5:{0:!0}},blitFramebuffer:{10:{8:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]},9:!0}},framebufferTextureLayer:{5:{0:!0,1:!0}},invalidateFramebuffer:{2:{0:!0}},invalidateSubFramebuffer:{6:{0:!0}},readBuffer:{1:{0:!0}},getInternalformatParameter:{3:{0:!0,1:!0,2:!0}},renderbufferStorageMultisample:{5:{0:!0,2:!0}},texStorage2D:{5:{0:!0,2:!0}},texStorage3D:{6:{0:!0,2:!0}},texImage2D:{9:{0:!0,
2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0},10:{0:!0,2:!0,6:!0,7:!0}},texImage3D:{10:{0:!0,2:!0,7:!0,8:!0},11:{0:!0,2:!0,7:!0,8:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0},10:{0:!0,6:!0,7:!0}},texSubImage3D:{11:{0:!0,8:!0,9:!0},12:{0:!0,8:!0,9:!0}},copyTexSubImage3D:{9:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0},8:{0:!0,2:!0},9:{0:!0,2:!0}},compressedTexImage3D:{8:{0:!0,2:!0},9:{0:!0,2:!0},10:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0},9:{0:!0,6:!0},10:{0:!0,6:!0}},compressedTexSubImage3D:{10:{0:!0,
8:!0},11:{0:!0,8:!0},12:{0:!0,8:!0}},vertexAttribIPointer:{5:{2:!0}},drawArraysInstanced:{4:{0:!0}},drawElementsInstanced:{5:{0:!0,2:!0}},drawRangeElements:{6:{0:!0,4:!0}},readPixels:{7:{4:!0,5:!0},8:{4:!0,5:!0}},clearBufferfv:{3:{0:!0},4:{0:!0}},clearBufferiv:{3:{0:!0},4:{0:!0}},clearBufferuiv:{3:{0:!0},4:{0:!0}},clearBufferfi:{4:{0:!0}},beginQuery:{2:{0:!0}},endQuery:{1:{0:!0}},getQuery:{2:{0:!0,1:!0}},getQueryParameter:{2:{1:!0}},samplerParameteri:{3:{1:!0,2:!0}},samplerParameterf:{3:{1:!0}},getSamplerParameter:{2:{1:!0}},
fenceSync:{2:{0:!0,1:{enumBitwiseOr:[]}}},clientWaitSync:{3:{1:{enumBitwiseOr:["SYNC_FLUSH_COMMANDS_BIT"]}}},waitSync:{3:{1:{enumBitwiseOr:[]}}},getSyncParameter:{2:{1:!0}},bindTransformFeedback:{2:{0:!0}},beginTransformFeedback:{1:{0:!0}},transformFeedbackVaryings:{3:{2:!0}},bindBufferBase:{3:{0:!0}},bindBufferRange:{5:{0:!0}},getIndexedParameter:{2:{0:!0}},getActiveUniforms:{3:{2:!0}},getActiveUniformBlockParameter:{3:{2:!0}}},m=null,n=null;return{copyright:'/*\n** Copyright (c) 2012 The Khronos Group Inc.\n**\n** Permission is hereby granted, free of charge, to any person obtaining a\n** copy of this software and/or associated documentation files (the\n** "Materials"), to deal in the Materials without restriction, including\n** without limitation the rights to use, copy, modify, merge, publish,\n** distribute, sublicense, and/or sell copies of the Materials, and to\n** permit persons to whom the Materials are furnished to do so, subject to\n** the following conditions:\n**\n** The above copyright notice and this permission notice shall be included\n** in all copies or substantial portions of the Materials.\n**\n** THE MATERIALS ARE PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,\n** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n** IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n** CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n** MATERIALS OR THE USE OR OTHER DEALINGS IN THE MATERIALS.\n*/',
init:d,mightBeEnum:function(l){a();return m[l]!==t},glEnumToString:e,glFunctionArgToString:b,glFunctionArgsToString:function(l,p){for(var r="",q=p.length,u=0;u<q;++u)r+=(0===u?"":", ")+b(l,q,u,p[u]);return r},makeDebugContext:g,makeLostContextSimulatingCanvas:function(l){function p(w){return"function"==typeof w?w:function(v){w.handleEvent(v)}}function r(){for(var w=Object.keys(K),v=0;v<w.length;++v)delete K[w[v]]}function q(){++N;A||I==N&&l.loseContext()}function u(w,v){var C=w[v];return function(){q();
if(!A)return C.apply(w,arguments)}}function x(w){return{statusMessage:w,preventDefault:function(){O=!0}}}function E(w){for(var v in w)"function"==typeof w[v]?z[v]=u(w,v):f(z,w,v);var C;z.getError=function(){q();if(!A)for(;C=y.getError();)K[C]=!0;for(C in K)if(K[C])return delete K[C],C;return z.NO_ERROR};var F="createBuffer createFramebuffer createProgram createRenderbuffer createShader createTexture".split(" ");M&&F.push("createQuery","createSampler","fenceSync","createTransformFeedback","createVertexArray");
for(var G=0;G<F.length;++G)v=F[G],z[v]=function(D){return function(){q();if(A)return null;var P=D.apply(w,arguments);P.__webglDebugContextLostId__=J;L.push(P);return P}}(w[v]);F="getActiveAttrib getActiveUniform getBufferParameter getContextAttributes getAttachedShaders getFramebufferAttachmentParameter getParameter getProgramParameter getProgramInfoLog getRenderbufferParameter getShaderParameter getShaderInfoLog getShaderSource getTexParameter getUniform getUniformLocation getVertexAttrib".split(" ");
M&&F.push("getInternalformatParameter","getQuery","getQueryParameter","getSamplerParameter","getSyncParameter","getTransformFeedbackVarying","getIndexedParameter","getUniformIndices","getActiveUniforms","getActiveUniformBlockParameter","getActiveUniformBlockName");for(G=0;G<F.length;++G)v=F[G],z[v]=function(D){return function(){q();return A?null:D.apply(w,arguments)}}(z[v]);F="isBuffer isEnabled isFramebuffer isProgram isRenderbuffer isShader isTexture".split(" ");M&&F.push("isQuery","isSampler",
"isSync","isTransformFeedback","isVertexArray");for(G=0;G<F.length;++G)v=F[G],z[v]=function(D){return function(){q();return A?!1:D.apply(w,arguments)}}(z[v]);z.checkFramebufferStatus=function(D){return function(){q();return A?z.FRAMEBUFFER_UNSUPPORTED:D.apply(w,arguments)}}(z.checkFramebufferStatus);z.getAttribLocation=function(D){return function(){q();return A?-1:D.apply(w,arguments)}}(z.getAttribLocation);z.getVertexAttribOffset=function(D){return function(){q();return A?0:D.apply(w,arguments)}}(z.getVertexAttribOffset);
z.isContextLost=function(){return A};M&&(z.getFragDataLocation=function(D){return function(){q();return A?-1:D.apply(w,arguments)}}(z.getFragDataLocation),z.clientWaitSync=function(D){return function(){q();return A?z.WAIT_FAILED:D.apply(w,arguments)}}(z.clientWaitSync),z.getUniformBlockIndex=function(D){return function(){q();return A?z.INVALID_INDEX:D.apply(w,arguments)}}(z.getUniformBlockIndex));return z}var y,H=[],B=[],z={},J=1,A=!1,L=[],I=0,N=0,O=!1,Q=0,M,K={};l.getContext=function(w){return function(){var v=
w.apply(l,arguments);if(v instanceof WebGLRenderingContext||window.WebGL2RenderingContext&&v instanceof WebGL2RenderingContext){if(v!=y){if(y)throw"got different context";M=window.WebGL2RenderingContext&&v instanceof WebGL2RenderingContext;y=v;z=E(y)}return z}return v}}(l.getContext);(function(w){var v=w.addEventListener;w.addEventListener=function(C,F,G){switch(C){case "webglcontextlost":H.push(p(F));break;case "webglcontextrestored":B.push(p(F));break;default:v.apply(w,arguments)}}})(l);l.loseContext=
function(){if(!A){A=!0;I=0;for(++J;y.getError(););r();K[y.CONTEXT_LOST_WEBGL]=!0;var w=x("context lost"),v=H.slice();setTimeout(function(){for(var C=0;C<v.length;++C)v[C](w);0<=Q&&setTimeout(function(){l.restoreContext()},Q)},0)}};l.restoreContext=function(){A&&B.length&&setTimeout(function(){if(!O)throw"can not restore. webglcontestlost listener did not call event.preventDefault";for(var w=0;w<L.length;++w){var v=L[w];v instanceof WebGLBuffer?y.deleteBuffer(v):v instanceof WebGLFramebuffer?y.deleteFramebuffer(v):
v instanceof WebGLProgram?y.deleteProgram(v):v instanceof WebGLRenderbuffer?y.deleteRenderbuffer(v):v instanceof WebGLShader?y.deleteShader(v):v instanceof WebGLTexture?y.deleteTexture(v):M&&(v instanceof WebGLQuery?y.deleteQuery(v):v instanceof WebGLSampler?y.deleteSampler(v):v instanceof WebGLSync?y.deleteSync(v):v instanceof WebGLTransformFeedback?y.deleteTransformFeedback(v):v instanceof WebGLVertexArrayObject&&y.deleteVertexArray(v))}h(y);A=!1;N=0;O=!1;w=B.slice();v=x("context restored");for(var C=
0;C<w.length;++C)w[C](v)},0)};l.loseContextInNCalls=function(w){if(A)throw"You can not ask a lost contet to be lost";I=N+w};l.getNumCalls=function(){return N};l.setRestoreTimeout=function(w){Q=w};return l},resetToInitialState:h}}()})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.FrameBuffer=function(a,e,b,f,g,h,k){this.context=a;this.txIndex=e;this.width=Math.round(b);this.height=Math.round(f);if(0===this.width||0===this.height)c.Logger.Report("FrameBuffer.ctor: FrameBuffer size cannot be zero; setting it to 1.",d.Warn),this.width=this.height=1;this.depthBuffer=this.glFrameBuffer=this.texture=null;b=this.context.gl;this.texture=new c.Texture2D(a,e,this.width,this.height,g,h);this.glFrameBuffer=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,
this.glFrameBuffer);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.texture.glTexture,0);k&&(this.depthBuffer=b.createRenderbuffer(),b.bindRenderbuffer(b.RENDERBUFFER,this.depthBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depthBuffer),b.bindRenderbuffer(b.RENDERBUFFER,null));b.bindFramebuffer(b.FRAMEBUFFER,null)};c.FrameBuffer.prototype.destroy=function(){if(this.context){this.texture.destroy();
this.texture=null;var a=this.context.gl;this.depthBuffer&&(a.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=null);a.deleteFramebuffer(this.glFrameBuffer);this.context=this.glFrameBuffer=null}};c.FrameBuffer.prototype.resize=function(a,e){a=Math.round(a);e=Math.round(e);if(0===a||0===e)c.Logger.Report("FrameBuffer.resize: FrameBuffer size cannot be zero; setting it to 1.",d.Warn),a=e=1;if(a!=this.width||e!=this.height){var b=this.context.gl;this.width=a;this.height=e;this.texture.resize(a,e);
this.depthBuffer&&(b.bindRenderbuffer(b.RENDERBUFFER,this.depthBuffer),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a,e),b.bindRenderbuffer(b.RENDERBUFFER,null))}};c.FrameBuffer.prototype.getSize=function(){return[this.width,this.height]};c.FrameBuffer.prototype.invalidate=function(){var a=this.context.gl,e=[a.COLOR_ATTACHMENT0];this.depthBuffer&&e.push(a.DEPTH_ATTACHMENT);a.bindFramebuffer(a.FRAMEBUFFER,this.glFrameBuffer);a.invalidateFramebuffer(a.FRAMEBUFFER,e)}})(window.BigLime=window.BigLime||
{});
(function(c,t){var d=c.Logger.Severity;c.GLContext=function(a,e){this.canvas=this.gl=null;this.uniformSetters={};this.state={currentProgram:null,boundIndexBuffer:null,boundTextures:null,activeTexture:-1};if(window.WebGLRenderingContext){try{this.gl=a.getContext("webgl2")}catch(f){}if(this.gl)for(;this.gl.getError()!=this.gl.NO_ERROR;);if(this.gl){this.canvas=this.gl.canvas;e=e||{};if(a=e.logErrors||e.logCalls)this.gl=c.DebugUtils.makeDebugContext(this.gl,e.logErrors?c.GLContext._logWebGLError:function(){},
e.logCalls?c.GLContext._logWebGLCall:function(){}),c.Logger.ConsoleThresh=d.Debug;this._initializeConstants();this.uniformSetters=this._tabulateUniformSetters();this.state.boundTextures=Array(this.GlMaxTextures);var b=this.gl;b.enable(b.CULL_FACE);b.cullFace(b.BACK);b.pixelStorei(b.UNPACK_ALIGNMENT,1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);e.noLostContextPopup||(this.contextLostListener=function(f){alert("WebGL context lost. \nPlease reload the page or restart the browser and try again with a smaller data set.")},
this.canvas.addEventListener("webglcontextlost",this.contextLostListener));c.Logger.Report("Created WebGL2"+(a?" debug":"")+" context.",d.Debug)}else c.Logger.Report("GLContext.ctor: Unable to get WebGL2 context from canvas.",d.Error)}else c.Logger.Report("GLContext.ctor: The browser doesn't support WebGL.",d.Error)};c.GLContext.prototype.destroy=function(){this.gl&&(this.canvas.removeEventListener("webglcontextlost",this.contextLostListener),this.uniformSetters=this.gl=null)};c.GLContext._isWebGL2Supported=
t;c.GLContext.isWebGL2Supported=function(){if(c.GLContext._isWebGL2Supported===t){var a=null;try{a=document.createElement("canvas").getContext("webgl2")}catch(e){}c.GLContext._isWebGL2Supported=!!a}return c.GLContext._isWebGL2Supported};c.GLContext.prototype.createProgram=function(a,e,b){return new c.ShaderProgram(this,b?b.name:"",a,e,b?b.vSubs:null,b?b.fSubs:null,b&&"undefined"!==typeof b.compile?!!b.compile:!0)};c.GLContext.prototype.createAttrBuffer=function(a,e,b){return new c.AttributeBuffer(this,
a,e,b)};c.GLContext.prototype.createIndexBuffer=function(a,e,b){return new c.IndexBuffer(this,a,e,b)};c.GLContext.prototype.bindIndexBuffer=function(a){a||null===this.state.boundIndexBuffer?a&&this.state.boundIndexBuffer!=a.glBuffer&&(this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a.glBuffer),this.state.boundIndexBuffer=a.glBuffer):(this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.state.boundIndexBuffer=null)};c.GLContext.prototype.unbindIndexBuffer=function(a){this.state.boundIndexBuffer==
a.glBuffer&&(this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.state.boundIndexBuffer=null)};c.GLContext.prototype.bindTexture=function(a){var e=this.gl;this.state.activeTexture!=a.txIndex&&(e.activeTexture(e.TEXTURE0+a.txIndex),this.state.activeTexture=a.txIndex);this.state.boundTextures[a.txIndex]!=a.glTexture&&(e.bindTexture(a.is3D?e.TEXTURE_3D:e.TEXTURE_2D,a.glTexture),this.state.boundTextures[a.txIndex]=a.glTexture)};c.GLContext.prototype.unbindTexture=function(a){var e=this.gl;this.state.boundTextures[a.txIndex]==
a.glTexture&&(e.activeTexture(e.TEXTURE0+a.txIndex),e.bindTexture(a.is3D?e.TEXTURE_3D:e.TEXTURE_2D,null),this.state.boundTextures[a.txIndex]=null,this.state.activeTexture=a.txIndex)};c.GLContext.prototype.setCurrentProgram=function(a){a?a.context!==this?c.Logger.Report("GLContext.setCurrentProgram: Invalid program.",d.Error):this.state.currentProgram!=a&&(this.gl.useProgram(a.glProgram),this.state.currentProgram=a):(this.gl.useProgram(null),this.state.currentProgram=null)};c.GLContext.prototype.isCurrentProgram=
function(a){return this.state.currentProgram==a};c.GLContext.prototype.clearCanvas=function(a){a=c.Color.ScaleTo1(a||c.Color.Black());this.gl.clearColor(a[0],a[1],a[2],a[3]);this.gl.clear(this.gl.COLOR_BUFFER_BIT)};c.GLContext._logWebGLError=function(a,e,b){for(var f="",g=b.length,h=0;h<g;++h)f+=(0===h?"":", ")+c.DebugUtils.glFunctionArgToString(e,g,h,b[h]);a="WebGL error: "+c.DebugUtils.glEnumToString(a)+" in "+e+"("+f+")";c.Logger.Report(a,d.Error)};c.GLContext._logWebGLCall=function(a,e){for(var b=
"",f=e.length,g=0;g<f;++g)b+=(0===g?"":", ")+c.DebugUtils.glFunctionArgToString(a,f,g,e[g]);c.Logger.Report("3DLib WebGL trace: "+a+"("+b+")",d.Debug)};c.GLContext.prototype._tabulateUniformSetters=function(){var a=this.gl,e={},b=function(g){return Array.isArray(g)||ArrayBuffer.isView(g)&&!(g instanceof DataView)};e[a.FLOAT_VEC2]=function(g,h){return a.uniform2fv(g,h)};e[a.FLOAT_VEC3]=function(g,h){return a.uniform3fv(g,h)};e[a.FLOAT_VEC4]=function(g,h){return a.uniform4fv(g,h)};e[a.FLOAT_MAT2]=function(g,
h){return a.uniformMatrix2fv(g,!1,h)};e[a.FLOAT_MAT3]=function(g,h){return a.uniformMatrix3fv(g,!1,h)};e[a.FLOAT_MAT4]=function(g,h){return a.uniformMatrix4fv(g,!1,h)};e[a.FLOAT]=function(g,h){return b(h)?a.uniform1fv(g,h):a.uniform1f(g,h)};e[a.INT_VEC2]=function(g,h){return a.uniform2iv(g,h)};e[a.INT_VEC3]=function(g,h){return a.uniform3iv(g,h)};e[a.INT_VEC4]=function(g,h){return a.uniform4iv(g,h)};e[a.INT]=function(g,h){return b(h)?a.uniform1iv(g,h):a.uniform1i(g,h)};e[a.SAMPLER_2D]=e[a.INT];e[a.SAMPLER_CUBE]=
e[a.INT];var f=function(g){return g?1:0};e[a.BOOL_VEC2]=function(g,h){return a.uniform2iv(g,h.map(f))};e[a.BOOL_VEC3]=function(g,h){return a.uniform3iv(g,h.map(f))};e[a.BOOL_VEC4]=function(g,h){return a.uniform4iv(g,h.map(f))};e[a.BOOL]=function(g,h){return b(h)?a.uniform1iv(g,h.map(f)):a.uniform1i(g,h?1:0)};e[a.SAMPLER_3D]=e[a.INT];e[a.SAMPLER_2D_SHADOW]=e[a.INT];e[a.SAMPLER_2D_ARRAY]=e[a.INT];e[a.SAMPLER_2D_ARRAY_SHADOW]=e[a.INT];e[a.SAMPLER_CUBE_SHADOW]=e[a.INT];e[a.INT_SAMPLER_2D]=e[a.INT];e[a.INT_SAMPLER_3D]=
e[a.INT];e[a.INT_SAMPLER_CUBE]=e[a.INT];e[a.INT_SAMPLER_2D_ARRAY]=e[a.INT];e[a.UNSIGNED_INT_SAMPLER_2D]=e[a.INT];e[a.UNSIGNED_INT_SAMPLER_3D]=e[a.INT];e[a.UNSIGNED_INT_SAMPLER_CUBE]=e[a.INT];e[a.UNSIGNED_INT_SAMPLER_2D_ARRAY]=e[a.INT];e[a.UNSIGNED_INT_VEC2]=function(g,h){return a.uniform2uiv(g,h)};e[a.UNSIGNED_INT_VEC3]=function(g,h){return a.uniform3uiv(g,h)};e[a.UNSIGNED_INT_VEC4]=function(g,h){return a.uniform4uiv(g,h)};e[a.UNSIGNED_INT]=function(g,h){return b(h)?a.uniform1uiv(g,h):a.uniform1ui(g,
h)};e[a.FLOAT_MAT2x3]=function(g,h){return a.uniformMatrix2x3fv(g,!1,h)};e[a.FLOAT_MAT2x4]=function(g,h){return a.uniformMatrix2x4fv(g,!1,h)};e[a.FLOAT_MAT3x2]=function(g,h){return a.uniformMatrix3x2fv(g,!1,h)};e[a.FLOAT_MAT3x4]=function(g,h){return a.uniformMatrix3x4fv(g,!1,h)};e[a.FLOAT_MAT4x2]=function(g,h){return a.uniformMatrix4x2fv(g,!1,h)};e[a.FLOAT_MAT4x3]=function(g,h){return a.uniformMatrix4x3fv(g,!1,h)};return e};c.GLContext.prototype._initializeConstants=function(){var a=this.gl;this.GlMaxTextures=
a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.GlMaxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.GlMax3DTextureSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE);this.GlMaxFragUniformVecs=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.GlMaxVertUniformVecs=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.GlMaxRenderBufSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.GlVersionInfo=a.getParameter(a.VERSION);var e=a.getExtension("WEBGL_debug_renderer_info");null!==e?(this.RendererInfo=a.getParameter(e.UNMASKED_RENDERER_WEBGL),
this.VendorInfo=a.getParameter(e.UNMASKED_VENDOR_WEBGL)):(this.RendererInfo=a.getParameter(a.RENDERER)||"Unknown",this.VendorInfo=a.getParameter(a.VENDOR)||"Unknown")};c.GLContext.prototype.sizeOf=function(a){var e=-1,b=this.gl;a===b.FLOAT||a===b.UNSIGNED_INT||a===b.INT?e=4:a===b.UNSIGNED_SHORT||a===b.SHORT?e=2:a===b.UNSIGNED_BYTE||a===b.BYTE?e=1:a===b.HALF_FLOAT&&(e=2);return e}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Histogram3D=function(d){this.data=new Uint32Array(d);this.numBins=d;this.binWidth=65536/d;this.minVal=65535;this.threshedMaxVal=this.threshedMinVal=this.maxVal=0;this.threshPercent=null};c.Histogram3D.prototype.clear=function(){for(var d=0;d<this.numBins;d++)this.data[d]=0;this.minVal=65535;this.threshedMaxVal=this.threshedMinVal=this.maxVal=0;this.threshPercent=null};c.Histogram3D.prototype.addImage=function(d,a,e){if(d){d=new Uint8Array(d);var b=d.length;if(1==a)for(a=0;a<b;a+=
8)e=d[a],this.data[e/this.binWidth|0]++,e<this.minVal&&(this.minVal=e),e>this.maxVal&&(this.maxVal=e);else if(2==a)if(e)for(a=0;a<b;a+=16)e=256*d[a]+d[a+1],this.data[e/this.binWidth|0]++,e<this.minVal&&(this.minVal=e),e>this.maxVal&&(this.maxVal=e);else for(a=0;a<b;a+=16)e=d[a]+256*d[a+1],this.data[e/this.binWidth|0]++,e<this.minVal&&(this.minVal=e),e>this.maxVal&&(this.maxVal=e)}};c.Histogram3D.prototype.getThreshedMinMax=function(d){if(this.threshPercent===d)return[this.threshedMinVal,this.threshedMaxVal];
for(var a=0,e=1;e<this.numBins;e++)a+=this.data[e];e=Math.round(.01*d*a);for(var b=0,f=1;b<=e&&f<this.numBins;)for(b+=this.data[f],f++;f<this.numBins&&0===this.data[f];)f++;a=(f+.5)*this.binWidth;b=0;for(f=this.numBins-1;0<=f&&b<=e;)for(b+=this.data[f],f--;0<=f&&0===this.data[f];)f--;e=65535-(this.numBins-1-f+.5)*this.binWidth;e<a&&(e=a);this.threshPercent=d;this.threshedMinVal=a;this.threshedMaxVal=e;return[this.threshedMinVal,this.threshedMaxVal]}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.IndexBuffer=function(a,e,b,f){var g=a.gl;this.context=a;this.elemSize=b||2;this.dataType=1==b?g.UNSIGNED_BYTE:2==b?g.UNSIGNED_SHORT:g.UNSIGNED_INT;this.drawMode=f||g.STATIC_DRAW;this.numIndices=0;this.glBuffer=null;1!=b&&2!=b&&4!=b?c.Logger.Report("IndexBuffer ctor: Invalid elemSize",d.Error):(a=this._coerceData(e))?(this.numIndices=a.length,this.glBuffer=g.createBuffer(),this.bind(),g.bufferData(g.ELEMENT_ARRAY_BUFFER,a,this.drawMode)):c.Logger.Report("IndexBuffer.ctor: Invalid data array.",
d.Error)};c.IndexBuffer.prototype.destroy=function(){if(this.context){var a=this.context.gl;this.bind();a.bufferData(a.ELEMENT_ARRAY_BUFFER,1,this.drawMode);this.unbind();this.glBuffer&&(a.deleteBuffer(this.glBuffer),this.glBuffer=null);this.context=null}};c.IndexBuffer.prototype.bind=function(){this.context.bindIndexBuffer(this)};c.IndexBuffer.prototype.unbind=function(){this.context.unbindIndexBuffer(this)};c.IndexBuffer.prototype._coerceData=function(a){var e=this.context.gl;try{if(this.dataType===
e.UNSIGNED_INT)return a instanceof Uint32Array?a:new Uint32Array(a);if(this.dataType===e.UNSIGNED_SHORT)return a instanceof Uint16Array?a:new Uint16Array(a);if(this.dataType===e.UNSIGNED_BYTE)return a instanceof Uint8Array?a:new Uint8Array(a)}catch(b){}return null};c.IndexBuffer.prototype.setData=function(a,e){if(a=this._coerceData(a)){var b=this.context.gl;this.bind();b.bufferSubData(b.ELEMENT_ARRAY_BUFFER,e||0,a)}else c.Logger.Report("IndexBuffer.setData: Invalid data array.",d.Error)}})(window.BigLime=
window.BigLime||{});
(function(c,t){var d=glMatrix.vec3;c.Light=function(a){this.diffuse=a?a.diffuse:.1;this.specStrength=a?a.specStrength:0;this.specExp=a?a.specExp:32;this.shadowDarkness=a?a.shadowDarkness:0;this.shadowSoftness=a?a.shadowSoftness:.75;this.dir=a?d.clone(a.dir):d.fromValues(0,0,1)};c.Light.prototype.updateFrom=function(a){this.diffuse=a.diffuse;this.specStrength=a.specStrength;this.specExp=a.specExp;this.shadowDarkness=a.shadowDarkness;this.shadowSoftness=a.shadowSoftness;d.copy(this.dir,a.dir)};c.Light.prototype.valueEquals=
function(a){return c.Utils.floatEquals(this.diffuse,a.diffuse,1E-4)&&c.Utils.floatEquals(this.specStrength,a.specStrength,1E-4)&&c.Utils.floatEquals(this.specExp,a.specExp,1E-4)&&c.Utils.floatEquals(this.shadowDarkness,a.shadowDarkness,1E-4)&&c.Utils.floatEquals(this.shadowSoftness,a.shadowSoftness,1E-4)&&c.Utils.floatEquals(this.dir[0],a.dir[0],1E-4)&&c.Utils.floatEquals(this.dir[1],a.dir[1],1E-4)&&c.Utils.floatEquals(this.dir[2],a.dir[2],1E-4)?!0:!1}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3;c.LightPositioner=function(e){this.mainDiv=e;this.canvas=null;this.ptRadius=10;this.lightPosW=d.create();this.active=!1;this.defaultLightDir=[.32,.16,.93];this._buildUi();this.setLightDirection(this.defaultLightDir);this._redraw();this.interactor=new c.Interactor(this.canvas,"lightPos");this.interactor.addEventListener("start move end",this._onInteract.bind(this))};c.LightPositioner.prototype._buildUi=function(){var e=c.Ui;e.StyleElement(this.mainDiv,
{margin:"auto"});this.canvSize=Math.min(parseInt(this.mainDiv.style.width),parseInt(this.mainDiv.style.height));this.padRadius=(this.canvSize-2*this.ptRadius)/2;this.canvas=e.CreateElement("canvas","canvas",this.mainDiv,{width:this.canvSize,height:this.canvSize},{width:this.canvSize,height:this.canvSize});this.canvas.addEventListener(c.Utils.isTouchDevice()?"doubleTap":"dblclick",this._onDoubleClick.bind(this))};c.LightPositioner.prototype._redraw=function(){var e=this.canvas.getContext("2d"),b=this.canvas.width,
f=this.canvas.height;e.clearRect(0,0,b,f);e.beginPath();e.fillStyle="rgba(255, 255, 255, 0.0)";e.fillRect(0,0,b,f);b/=2;f/=2;e.beginPath();e.arc(b,f,this.padRadius,0,2*Math.PI);e.fillStyle="#D2B48C";e.fill();e.beginPath();e.arc(this.lightPosW[0],this.lightPosW[1],this.ptRadius,0,2*Math.PI);e.fillStyle="#8B4513";e.fill();e.beginPath();e.moveTo(b,f-this.ptRadius-5);e.lineTo(b,f+this.ptRadius+5);e.moveTo(b-this.ptRadius-5,f);e.lineTo(b+this.ptRadius+5,f);e.strokeStyle="black";e.stroke()};c.LightPositioner.prototype.getLightDirection=
function(){var e=this.canvas.width/2-this.lightPosW[0],b=this.canvas.height/2-this.lightPosW[1];e=a.fromValues(e,b,Math.sqrt(this.padRadius*this.padRadius-e*e-b*b));a.normalize(e,e);return e};c.LightPositioner.prototype.setLightDirection=function(e,b){e=a.clone(e);a.normalize(e,e);a.scale(e,e,this.padRadius);this.lightPosW[0]=this.canvas.width/2-e[0];this.lightPosW[1]=this.canvas.height/2-e[1];this._redraw();b||this.trigger("change",{val:this.getLightDirection()})};c.LightPositioner.prototype._onInteract=
function(e){if("start"==e.type)d.distance(this.interactor.currPoint,this.lightPosW)>this.ptRadius||(this.active=!0,this.trigger("changeStart"));else if("move"==e.type){if(this.active){d.add(this.lightPosW,this.lightPosW,this.interactor.deltaPrev);e=d.fromValues(this.canvas.width/2,this.canvas.height/2);var b=d.create();d.subtract(b,this.lightPosW,e);var f=d.length(b);f>.98*this.padRadius&&(d.scale(b,b,.98*this.padRadius/f),d.add(this.lightPosW,b,e));this._redraw();this.trigger("change",{val:this.getLightDirection()})}}else"end"==
e.type&&this.active&&(this.active=!1,this.trigger("changeEnd"))};c.LightPositioner.prototype._onDoubleClick=function(){this.setLightDirection(this.defaultLightDir)};c.LightPositioner.prototype.addEventListener=function(e,b){c.Notifier.prototype.addEventListener.call(this,e,b)};c.LightPositioner.prototype.removeEventListener=function(e,b){c.Notifier.prototype.removeEventListener.call(this,e,b)};c.LightPositioner.prototype.trigger=function(e,b){c.Notifier.prototype.trigger.call(this,e,b)}})(window.BigLime=
window.BigLime||{});
(function(c,t){c.LightSet=function(d){d?(this.ambientLight=d.ambientLight,this.dirLights=[new c.Light(d.dirLights[0]),new c.Light(d.dirLights[1])]):(this.ambientLight=.6,this.dirLights=[new c.Light({diffuse:.1,specStrength:0,specExp:32,shadowDarkness:.5,shadowSoftness:.75,dir:[.32,.16,.93]}),new c.Light({diffuse:0,specStrength:0,specExp:8,shadowDarkness:0,shadowSoftness:.75,dir:[.32,.16,.93]})])};c.LightSet.prototype.updateFrom=function(d){this.ambientLight=d.ambientLight;this.dirLights[0].updateFrom(d.dirLights[0]);this.dirLights[1].updateFrom(d.dirLights[1])};
c.LightSet.prototype.valueEquals=function(d){return c.Utils.floatEquals(this.ambientLight,d.ambientLight,1E-4)&&this.dirLights[0].valueEquals(d.dirLights[0])&&this.dirLights[1].valueEquals(d.dirLights[1])?!0:!1};c.LightSet.prototype.shadowsEnabled=function(){return this.dirLights.some(d=>0<d.shadowDarkness)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Material=function(d,a,e,b,f,g){this.flatShade=!!a;this.ambient=e||(0===e?0:.5);this.diffuse=b||(0===b?0:.5);this.specStrength=f||(0===f?0:.5);this.specPower=g||(0===g?0:32);this.color=d?d instanceof c.Color?d.toArray():d.slice():[255,0,0,255];3===this.color.length&&this.color.push(255)};c.Material.prototype.clone=function(){return new c.Material(this.color,this.flatShade,this.ambient,this.diffuse,this.specStrength,this.specPower)}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3;c.MprOverlayInteractor=function(e,b){b=b||{};var f=b.drag||{btns:2,shift:!1,ctrl:!0,alt:!1};b=b.rot||{btns:0,shift:!0,ctrl:!0,alt:!1};this.dragEventTypes=Array.isArray(f)?f:[f];this.rotEventTypes=Array.isArray(b)?b:[b];c.Interactor.call(this,e.canvas,"overlay",[].concat(this.dragEventTypes,this.rotEventTypes));this.mprViewer=e};c.MprOverlayInteractor.prototype=Object.create(c.Interactor.prototype);c.MprOverlayInteractor.prototype.constructor=c.MprOverlayInteractor;
c.MprOverlayInteractor.prototype._onStart=function(e){this.pinching||(c.Interactor.MouseEventMatches(e,this.dragEventTypes)?this.hitTestResult=this._hitTest(this.currPoint,"drag"):c.Interactor.MouseEventMatches(e,this.rotEventTypes)&&(this.hitTestResult=this._hitTest(this.currPoint,"rot")));this.interactMode=this.hitTestResult.interactMode;"none"!=this.interactMode&&this.trigger("start",{interactMode:this.interactMode})};c.MprOverlayInteractor.prototype._onMove=function(e){"none"!=this.interactMode&&
(e=this.hitTestResult,"dragCrosshair"==this.interactMode?(d.scaleAndAdd(e.crosshairLocV,e.crosshairLocV,e.chDirs[0],d.dot(this.deltaPrev,e.chDirs[0])),d.scaleAndAdd(e.crosshairLocV,e.crosshairLocV,e.chDirs[1],d.dot(this.deltaPrev,e.chDirs[1])),this.trigger("move",{interactMode:this.interactMode,crosshairLocV:e.crosshairLocV})):"rotCrosshair"==this.interactMode?(e=c.Utils.CalcRotAngle(this.currPoint,this.prevPoint,e.crosshairLocV),this.trigger("move",{interactMode:this.interactMode,deltaRotAngle:e})):
"dragClipBox"==this.interactMode?this.trigger("move",{interactMode:this.interactMode,deltaPosV:this.deltaPrev}):"rotClipBox"==this.interactMode?(e=c.Utils.CalcRotAngle(this.currPoint,this.prevPoint,e.clipBoxCenterV),this.trigger("move",{interactMode:this.interactMode,deltaRotAngle:e})):"extrudeClipBox"==this.interactMode&&this.trigger("move",{interactMode:this.interactMode,extrudeFace:e.hitObjIndex,deltaPosV:this.deltaPrev}))};c.MprOverlayInteractor.prototype._onEnd=function(e){this.trigger("end",
{interactMode:this.interactMode})};c.MprOverlayInteractor.prototype._hitTest=function(e,b){var f=this.mprViewer,g=Number.MAX_VALUE,h=null,k=-1,m,n=[[0,0],[0,0]],l=f.transforms.txToViewport(f.mprPoint),p=d.subtract(d.create(),e,l);for(m=0;m<f.siblings.length;m++)if(f.crossHairLines&&f.crossHairLines.length>m){var r=d.subtract(d.create(),f.crossHairLines[m][1],f.crossHairLines[m][0]);var q=d.normalize(d.create(),[r[1],-r[0]]);r=Math.abs(d.dot(p,q));12>r&&(n[m]=q,r<g&&(g=r,h="crosshair",k=m))}p=f.clipBoxLines;
r=!1;if(p){for(m=0;m<p.length;m++)if(r=p[m])r=Math.sqrt(c.Utils.SquaredDistanceToLineSegment(e,r[0],r[1])),r<g&&12>r&&(g=r,h="clipBox",k=m);g=c.Geometry.convexHull(p.filter(function(u){return!!u}).flat(1));r=c.Utils.PointInPolygon(e,g)}e=a.divide(a.create(),f.clipBox.center,f.renderEngine.volume.shape);f=f.transforms.txToViewport(e);e="none";"crosshair"==h?e="drag"==b?"dragCrosshair":"rotCrosshair":"clipBox"==h?e=r?"drag"==b?"dragClipBox":"rotClipBox":"drag"==b?"extrudeClipBox":"rotClipBox":h||r&&
(e="drag"==b?"dragClipBox":"rotClipBox");return{interactMode:e,hitObj:h,hitObjIndex:k,chDirs:n,crosshairLocV:l,clipBoxCenterV:f}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.vec4,b=glMatrix.mat4,f=glMatrix.quat;c.MprViewer=function(g={}){this.site=g.site;this.autoResize="undefined"===typeof g.autoResize?!0:!!g.autoResize;this.drawOrientLabels="undefined"===typeof g.drawOrientLabels?!0:!!g.drawOrientLabels;this.drawCrosshairs="undefined"===typeof g.drawCrosshairs?!0:!!g.drawCrosshairs;if(!g.initialPlane||"string"===typeof g.initialPlane||g.initialPlane instanceof String){var h=(g.initialPlane||"axi").toLowerCase();
this.rowDir="axi"==h?a.fromValues(1,0,0):"cor"==h?a.fromValues(1,0,0):a.fromValues(0,1,0);this.colDir="axi"==h?a.fromValues(0,1,0):a.fromValues(0,0,-1)}else this.rowDir=a.clone(g.initialPlane[0]),this.colDir=a.clone(g.initialPlane[1]),a.normalize(this.rowDir,this.rowDir),a.normalize(this.colDir,this.colDir);this.initialPlane={rowDir:a.clone(this.rowDir),colDir:a.clone(this.colDir)};this.refLineColor="#ffffff";this.canvas=c.Ui.CreateElement("canvas","mprviewer_canvas",this.site,{width:"100%",height:"100%",
backgroundColor:"#000000"});this.canvas.addEventListener("contextmenu",function(k){k.preventDefault()});this.renderEngine=g.renderEngine?g.renderEngine:new c.RenderEngine({options:g.engineOptions});this.ownsEngine=!g.renderEngine;h=this.renderParams=new c.RenderParams;h.renderType=c.RenderType.MIP;h.persp=0;h.slab=new c.Slab(this.renderEngine.volume);h.clipToSlab=!0;h.showSlab=!1;h.rayOversamp=2;h.showGraphics=!1;h.showMarker=!1;h.rotMatrix=c.Utils.GetRotMatrix(this.rowDir,this.colDir);this.transforms=
new c.Transforms(this.renderEngine.volume,this.renderParams,this.canvas);this.mprThickness=1;this.mprPoint=a.fromValues(.5,.5,.5);this.fastDrawDownsamp=1;this.resizeTimerId=null;this.renderCallbacks=[];this.siblings=[];this.clipBox=null;this.drawClipBox=!1;this.orientLabels="X Y Z -X -Y -Z".split(" ");g.omitInteractors||(this.multiInteractor=new c.MultiInteractor(this.canvas,t,!0),this.multiEventHandler=this._onMultiInteractorEvent.bind(this),this.multiInteractor.addEventListener("start move end",
this.multiEventHandler),this.overlayInteractor=new c.MprOverlayInteractor(this),this.overlayEventHandler=this._onOverlayInteractorEvent.bind(this),this.overlayInteractor.addEventListener("start move end",this.overlayEventHandler),this.overlayInteractor.enabled=!1);this.resizeListener=this.onResize.bind(this);window.addEventListener("resize",this.resizeListener);this.onResize()};c.MprViewer.prototype.destroy=function(){this.renderEngine&&(clearTimeout(this.resizeTimerId),window.removeEventListener("resize",
this.resizeListener),c.Utils.cancelAnimFrame(this.rafId),this.multiInteractor&&(this.multiInteractor.stopListening(),this.multiInteractor=null),this.overlayInteractor&&(this.overlayInteractor.stopListening(),this.overlayInteractor=null),this.ownsEngine&&this.renderEngine.destroy(),this.renderEngine=null,this.canvas.remove())};c.MprViewer.prototype.onResize=function(g=!1){if(this.autoResize){var h=this.canvas.getBoundingClientRect();this.canvas.width=Math.round(h.width);this.canvas.height=Math.round(h.height);
this.rafId=c.Utils.requestAnimFrame(this.render.bind(this));g?this.resizeTimerId=null:(this.resizeTimerId&&clearTimeout(this.resizeTimerId),this.resizeTimerId=setTimeout(function(){this.onResize(!0)}.bind(this),300))}};c.MprViewer.MakeSiblingGroup=function(g){for(var h=["#007FFF","#FFFF00","#FF0000"],k=0;k<g.length;k++)for(var m=0;m<g.length;m++)m!=k&&(g[k].siblings.push(g[m]),g[k].refLineColor=h[k%3])};c.MprViewer.prototype.setInteractionMode=function(g){var h={pose:!1,winlevel:!1,overlay:!1};h.hasOwnProperty(g)&&
(h[g]=!0);this.overlayInteractor&&(this.overlayInteractor.enabled=h.overlay);this.multiInteractor&&(this.multiInteractor.enabled=h.pose||h.winlevel,this.multiInteractor.wlEnabled=h.winlevel,this.multiInteractor.panEnabled=this.multiInteractor.zoomEnabled=this.multiInteractor.rotEnabled=h.pose)};c.MprViewer.prototype.clearDisplay=function(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)};c.MprViewer.prototype.loadVolume=function(g,h,k,m){this.orientLabels=h instanceof
c.DicomLoader3D?"LPHRAF".split(""):"X Y Z -X -Y -Z".split(" ");var n=function(l,p){l||c.Utils.SafeInvoke(this.onNewVolumeLoaded.bind(this),[]);c.Utils.SafeInvoke(k,[l,p,this])}.bind(this);this.clearDisplay();this.renderEngine.loadVolume({imgFiles:g,loader:h,completionCb:n,progressCb:m})};c.MprViewer.prototype.cancelLoading=function(){this.renderEngine.cancelLoading()};c.MprViewer.prototype.onNewVolumeLoaded=function(){this.resetPan();this.resetZoom();this.resetOrientation();this.resetWinLevel();this.setMprPoint([.5,
.5,.5])};c.MprViewer.prototype.render=function(){const g=this.renderEngine;if(g.hasImageData()){var [h,k]=[this.canvas.width,this.canvas.height];this.transforms.update(this.renderParams,g.volume.dims,[h,k]);this._updateSlab();this.renderParams.rasterDownsamp=g.isAnimating()?this.fastDrawDownsamp:1;g.render(this.renderParams,this.transforms);var m=this.canvas.getContext("2d"),n=g.canvas.height,[l,p]=[g.viewport[2],g.viewport[3]];m.clearRect(0,0,h,k);m.drawImage(g.canvas,0,n-p,l,p,0,0,h,k);this._drawGraphics();
this.renderCallbacks.forEach(r=>{r(this)})}};c.MprViewer.prototype.perpDir=function(g=!1){return g?a.cross([0,0,0,0],this.rowDir,this.colDir):a.cross([0,0,0],this.rowDir,this.colDir)};c.MprViewer.prototype._drawGraphics=function(){var g=this.canvas.getContext("2d"),h=this.canvas.width,k=this.canvas.height,m;this.crossHairLines=[];if(this.drawCrosshairs)for(m=0;m<this.siblings.length;m++){var n=this.siblings[m],l=a.cross(a.create(),this.perpDir(),n.perpDir());var p=d.fromValues(a.dot(l,this.rowDir),
a.dot(l,this.colDir));d.normalize(p,p);l=Math.abs(p[0])>Math.abs(p[1]);var r=1>=this.mprThickness?0:this.mprThickness/2*this.renderParams.zoom*Math.min(this.canvas.width,this.canvas.height)/this.renderEngine.volume.diagSize,q=this.transforms.txToViewport(this.mprPoint);if(l){var u=[0,q[1]+(0-q[0])*p[1]/p[0]];q=[h,q[1]+(h-q[0])*p[1]/p[0]];p=r/Math.abs(p[0])}else u=[q[0]+(0-q[1])*p[0]/p[1],0],q=[q[0]+(k-q[1])*p[0]/p[1],k],p=r/Math.abs(p[1]);this.crossHairLines.push([u,q]);g.lineWidth=1;g.strokeStyle=
n.refLineColor;for(n=-1;1>=n;n+=2)g.beginPath(),l?(g.moveTo(u[0],u[1]+n*p),g.lineTo(q[0],q[1]+n*p)):(g.moveTo(u[0]+n*p,u[1]),g.lineTo(q[0]+n*p,q[1])),g.stroke()}this.drawOrientLabels&&(m=["",""],l=this.renderEngine.volume,n=l.getAttr("rowDir"),l=l.getAttr("colDir"),n&&l&&(u=a.cross(a.create(),n,l),q=a.create(),a.scaleAndAdd(q,q,n,this.rowDir[0]),a.scaleAndAdd(q,q,l,this.rowDir[1]),a.scaleAndAdd(q,q,u,this.rowDir[2]),m[0]=c.ImageLook.getOrientationLabel(q,this.orientLabels),q=a.create(),a.scaleAndAdd(q,
q,n,this.colDir[0]),a.scaleAndAdd(q,q,l,this.colDir[1]),a.scaleAndAdd(q,q,u,this.colDir[2]),a.negate(q,q),m[1]=c.ImageLook.getOrientationLabel(q,this.orientLabels)),Object.assign(g,{font:"18px Arial Narrow",textAlign:"center",textBaseline:"middle",fillStyle:"#cfcfcf",shadowColor:"black",shadowOffsetX:2,shadowOffsetY:2}),g.fillText(m[0],h-24,k/2),g.fillText(m[1],h/2,15),[g.shadowOffsetX,g.shadowOffsetY]=[0,0]);this.clipBoxLines=null;if(this.drawClipBox)for(h=this.perpDir(!0),e.normalize(h,e.transformMat4(h,
h,this.transforms.model)),h.pop(),g=this.canvas.getContext("2d"),g.strokeStyle="#00FF00",h=this.clipBox.intersectWithPlane(h,this.mprPoint),this.clipBoxLines=[null,null,null,null,null,null],k=0;k<h.length;k++)h[k]&&(m=this.transforms.txToViewport(h[k][0]),n=this.transforms.txToViewport(h[k][1]),this.clipBoxLines[k]=[m,n],g.beginPath(),g.moveTo(m[0],m[1]),g.lineTo(n[0],n[1]),g.stroke())};c.MprViewer.prototype._updateSlab=function(){var g=this.renderParams,h=this.renderEngine.volume,k=g.slab,m=Math.max(...h.shape);
a.copy(k.shape,[4*m,4*m,this.mprThickness]);b.transpose(k.orient,g.rotMatrix);a.multiply(k.center,this.mprPoint,h.shape)};c.MprViewer.prototype._onMultiInteractorEvent=function(g){var h=this.renderEngine,k=this.renderParams,m=this.multiInteractor;if("start"==g.type)m.setInitialValues({zoom:k.zoom,pan:k.pan,wwl:{width:k.winWidth,level:k.winLevel,levelRange:h.volume.getAutoWinLevel()[0]},rot2Dcenter:this.transforms.txToViewport(this.mprPoint)}),h.animate(15,function(){this.render();"zoom"==m.interactMode||
"wheelzoom"==m.interactMode?this.siblings.forEach(function(n){n.renderParams.zoom=this.renderParams.zoom;n.render()}.bind(this)):"light"==m.interactMode&&this.siblings.forEach(function(n){n.renderParams.winWidth=this.renderParams.winWidth;n.renderParams.winLevel=this.renderParams.winLevel;n.render()}.bind(this))}.bind(this));else if("move"==g.type)switch(m.interactMode){case "rotate":g=f.create();f.setAxisAngle(g,this.perpDir(),m.deltaRot2D);a.transformQuat(this.rowDir,this.rowDir,g);a.transformQuat(this.colDir,
this.colDir,g);c.Utils.GetRotMatrix(this.rowDir,this.colDir,k.rotMatrix);break;case "zoom":case "wheelzoom":k.zoom=m.currentZoom;break;case "pan":d.copy(k.pan,m.currentPan);break;case "panzoom":k.zoom=m.currentZoom;d.copy(k.pan,m.currentPan);break;case "light":k.winWidth=m.winWidth,k.winLevel=m.winLevel}else"end"==g.type&&(h.stopAnimation(),this.render(),this.siblings.forEach(function(n){n.renderParams.zoom=this.renderParams.zoom;n.renderParams.winWidth=this.renderParams.winWidth;n.renderParams.winLevel=
this.renderParams.winLevel;n.render()}.bind(this)))};c.MprViewer.prototype._onOverlayInteractorEvent=function(g){var h=this.renderEngine;if("start"==g.type)h.animate(15,function(){this.render();this.siblings.forEach(function(q){q.render()})}.bind(this));else if("move"==g.type)switch(g.detail.interactMode){case "dragCrosshair":this.setMprPoint(this.transforms.viewportToTx(g.detail.crosshairLocV));break;case "rotCrosshair":var k=f.create();f.setAxisAngle(k,this.perpDir(),g.detail.deltaRotAngle);this.siblings.forEach(function(q){a.transformQuat(q.rowDir,
q.rowDir,k);a.transformQuat(q.colDir,q.colDir,k);c.Utils.GetRotMatrix(q.rowDir,q.colDir,q.renderParams.rotMatrix)});break;case "dragClipBox":h=this.transforms.viewportDeltaToTx(g.detail.deltaPosV);a.multiply(h,h,this.renderEngine.volume.shape);a.add(this.clipBox.center,this.clipBox.center,h);break;case "rotClipBox":h=b.fromRotation(b.create(),g.detail.deltaRotAngle,this.perpDir());b.multiply(this.clipBox.orient,h,this.clipBox.orient);break;case "extrudeClipBox":if(h=this.clipBox){var m=this.transforms,
n=this.renderParams.rotMatrix,l=g.detail.extrudeFace,p=1==l||3==l?0:2==l||4==l?1:2;l=0==l||3==l||4==l?-1:1;var r=[h.orient[4*p],h.orient[4*p+1],h.orient[4*p+2]];m=a.length(a.mul(a.create(),m.viewportDeltaToTx([1,1]),this.renderEngine.volume.dims));n=d.normalize(d.create(),a.transformMat4(a.create(),r,n));n=d.dot(g.detail.deltaPosV,n)*m/1.5;g=h.shape[p];p=h.shape[p]=Math.max(1,h.shape[p]+l*n);a.add(h.center,h.center,a.scale(a.create(),r,l*(p-g)/2))}}else"end"==g.type&&(h.stopAnimation(),this.render(),
this.siblings.forEach(function(q){q.render()}))};c.MprViewer.prototype.setMprPoint=function(g){a.copy(this.mprPoint,g)};c.MprViewer.prototype.resetMprPoint=function(){this.setMprPoint([.5,.5,.5])};c.MprViewer.prototype.setMprThickness=function(g){this.mprThickness=Math.max(1,g)};c.MprViewer.prototype.setOrientation=function(g,h){a.normalize(this.rowDir,g);a.normalize(this.colDir,h);Math.abs(1E-4<a.dot(this.rowDir,this.colDir))&&c.Logger.Report("MprViewer.setOrient: Received non-orthogonal orientation vectors.",
c.Logger.Severity.Warn,!1,!1);c.Utils.GetRotMatrix(this.rowDir,this.colDir,this.renderParams.rotMatrix)};c.MprViewer.prototype.resetOrientation=function(){var g=this.initialPlane,h=this.renderEngine.volume.nearLphAxes,k=a.scale(a.create(),h.L,g.rowDir[0]);a.scaleAndAdd(k,a.scaleAndAdd(k,k,h.P,g.rowDir[1]),h.H,g.rowDir[2]);var m=a.scale(a.create(),h.L,g.colDir[0]);a.scaleAndAdd(m,a.scaleAndAdd(m,m,h.P,g.colDir[1]),h.H,g.colDir[2]);this.setOrientation(k,m)};c.MprViewer.prototype.resetZoom=function(){this.renderParams.zoom=
.95*this.calcDefaultZoom()};c.MprViewer.prototype.resetPan=function(){d.copy(this.renderParams.pan,[0,0])};c.MprViewer.prototype.resetWinLevel=function(){[this.renderParams.winWidth,this.renderParams.winLevel]=this.renderEngine.volume.getAutoWinLevel()};c.MprViewer.prototype.calcDefaultZoom=function(){var g=1;if(this.renderEngine.hasImageData()){g=this.renderEngine.volume;var h=this.rowDir.reduce((n,l,p,r)=>Math.abs(l)>Math.abs(r[n])?p:n,0),k=this.colDir.reduce((n,l,p,r)=>Math.abs(l)>Math.abs(r[n])?
p:n,0),m=this.canvas.width/this.canvas.height;g=g.shape[h]/g.shape[k]>m?g.diagSize/g.shape[h]*Math.max(1,m):g.diagSize/g.shape[k]*Math.max(1,1/m)}return g}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.mat4;c.MultiInteractor=function(b,f,g){f=f||{};var h=f.pan||{btns:2,shift:!1,ctrl:!1,alt:!1},k=f.zoom||{btns:0,shift:!0,ctrl:!1,alt:!1},m=f.rot||{btns:0,shift:!1,ctrl:!1,alt:!1};f=f.wl||{btns:0,shift:!1,ctrl:!1,alt:!0};this.panEventTypes=Array.isArray(h)?h:[h];this.zoomEventTypes=Array.isArray(k)?k:[k];this.rotEventTypes=Array.isArray(m)?m:[m];this.wlEventTypes=Array.isArray(f)?f:[f];c.Interactor.call(this,b,"multi",[].concat(this.panEventTypes,
this.zoomEventTypes,this.rotEventTypes,this.wlEventTypes));this.rot2D=!!g;this.wlEnabled=this.rotEnabled=this.zoomEnabled=this.panEnabled=!0;this.winLevel=this.winWidth=1;this.shadow=this.ambient=0;this.wlRateOfChange=1;this.asRateOfChange=1/1024;this.initialZoom=1;this.initialPan=[0,0];this.initialRot=e.create();this.currentZoom=1;this.currentPan=[0,0];this.currentRot=e.create();this.deltaRot=e.create();this.rot2Dcenter=d.create();this.deltaRot2D=0;this.mouseWheelZoomEnabled=!0;this.mouseWheelListener=
this._onMouseWheelChange.bind(this);this.eventSources.forEach(n=>n.addEventListener("wheel",this.mouseWheelListener));this.mouseWheelTimerId=null};c.MultiInteractor.prototype=Object.create(c.Interactor.prototype);c.MultiInteractor.prototype.constructor=c.MultiInteractor;c.MultiInteractor.prototype.setEventTypes=function(b,f){f=Array.isArray(f)?f:[f];switch(b){case "pan":this.panEventTypes=f;break;case "zoom":this.zoomEventTypes=f;break;case "rot":this.rotEventTypes=f;break;case "wl":this.wlEventTypes=
f}this.eventTypes=[].concat(this.panEventTypes,this.zoomEventTypes,this.rotEventTypes,this.wlEventTypes)};c.MultiInteractor.prototype.stopListening=function(){c.Interactor.prototype.stopListening.call(this);this.eventSources.forEach(b=>b.removeEventListener("wheel",this.mouseWheelListener));clearTimeout(this.mouseWheelTimerId)};c.MultiInteractor.prototype.setInitialValues=function(b={}){b.zoom&&(this.initialZoom=this.currentZoom=b.zoom);b.pan&&(d.copy(this.initialPan,b.pan),d.copy(this.currentPan,
b.pan));b.rot&&(e.copy(this.initialRot,b.rot),e.copy(this.currentRot,b.rot));b.rot2Dcenter&&d.copy(this.rot2Dcenter,b.rot2Dcenter);b.wwl&&(this.winWidth=b.wwl.width,this.winLevel=b.wwl.level,this.wlRateOfChange=Math.max(1,b.wwl.levelRange)/1024);b.lighting&&(this.ambient=b.lighting.ambient,this.shadow=b.lighting.shadow,this.asRateOfChange=1/1024)};c.MultiInteractor.prototype._onStart=function(b){this.mouseWheelTimerId&&(clearTimeout(this.mouseWheelTimerId),this.mouseWheelTimerId=null);if(this.pinching)this.interactMode=
this.panEnabled||this.zoomEnabled?"panzoom":"none";else{var f=c.Interactor.MouseEventMatches;this.interactMode=f(b,this.rotEventTypes)&&this.rotEnabled?"rotate":f(b,this.panEventTypes)&&this.panEnabled?"pan":f(b,this.zoomEventTypes)&&this.zoomEnabled?"zoom":f(b,this.wlEventTypes)&&this.wlEnabled?"light":"none"}"none"!=this.interactMode&&(this.onStart?this.onStart(b):this.trigger("start",{origEvent:b}))};c.MultiInteractor.prototype._onMove=function(b){if("none"!=this.interactMode&&"wheelzoom"!=this.interactMode){var f=
this.currentEventSource.getBoundingClientRect();if(this.pinching)2<=this.currNumTouches&&(f=2/Math.min(f.width,f.height),this.currentPan[0]-=f*this.deltaPrevPinch.ctr[0]/this.currentZoom,this.currentPan[1]+=f*this.deltaPrevPinch.ctr[1]/this.currentZoom,this.currentZoom=this.currPinch.sep/(this.startPinch.sep+1E-4)*this.initialZoom);else switch(this.interactMode){case "pan":f=2/Math.min(f.width,f.height);this.currentPan[0]+=f*this.deltaPrev[0]/this.currentZoom;this.currentPan[1]+=f*this.deltaPrev[1]/
this.currentZoom;break;case "zoom":this.currentZoom*=Math.pow(1.01,-this.deltaPrev[1]);break;case "panzoom":f=2/Math.min(f.width,f.height);this.currentPan[0]+=f*this.deltaPrev[0]/this.currentZoom;this.currentPan[1]+=f*this.deltaPrev[1]/this.currentZoom;this.currentZoom*=Math.pow(1.01,-this.deltaPrev[1]);break;case "rotate":this.rot2D?this.deltaRot2D=c.Utils.CalcRotAngle(this.prevPoint,this.currPoint,this.rot2Dcenter):(c.MultiInteractor.CalcRotationMatrix(this.deltaRot,this.prevPoint,this.currPoint,
[f.width,f.height]),e.multiply(this.currentRot,this.deltaRot,this.currentRot));break;case "light":this.winLevel+=this.wlRateOfChange*this.deltaPrev[1],this.winWidth-=this.wlRateOfChange*this.deltaPrev[0],this.winWidth=Math.max(this.winWidth,1E-4),this.ambient-=this.asRateOfChange*this.deltaPrev[1],this.ambient=Math.min(2,Math.max(0,this.ambient)),this.shadow+=this.asRateOfChange*this.deltaPrev[0],this.shadow=Math.min(1.5,Math.max(0,this.shadow))}this.onMove?this.onMove(b):this.trigger("move",{origEvent:b})}};
c.MultiInteractor.prototype._onEnd=function(b){"none"!=this.interactMode&&(this.onEnd?this.onEnd(b):this.trigger("end",{origEvent:b}),this.interactMode="none")};c.MultiInteractor.prototype._onMouseWheelChange=function(b){if(this.mouseWheelZoomEnabled){var f=b.originalEvent;if(!b.deltaMode&&0!==b.deltaMode||!b.deltaY&&0!==b.deltaY){if(!f||!f.deltaMode&&0!==f.deltaMode||!f.deltaY&&0!==f.deltaY)return;f=b.originalEvent.deltaMode;var g=b.originalEvent.deltaY}else f=b.deltaMode,g=b.deltaY;f=Math.pow(1.01,
-g/(0===f?50:1.5));this.mouseWheelTimerId?(this.currentZoom*=f,this.onMove?this.onMove(b):this.trigger("move",{origEvent:b}),clearTimeout(this.mouseWheelTimerId)):(this.active=!0,this.interactMode="wheelzoom",this.onStart?this.onStart(b):this.trigger("start",{origEvent:b}),this.currentZoom=this.initialZoom*f,this.onMove?this.onMove(b):this.trigger("move",{origEvent:b}));this.mouseWheelTimerId=setTimeout(function(){this.onEnd?this.onEnd(b):this.trigger("end",{origEvent:b});this.active=!1;this.interactMode=
"none";this.mouseWheelTimerId=null}.bind(this),500);b.preventDefault()}};c.MultiInteractor.CalcRotationMatrix=function(b,f,g,h,k){b=b||e.create();var m=d.scale(d.create(),h,.5),n=Math.min(m[0],m[1]);h=n*n;k=k||m;g=d.subtract(d.create(),k,g);f=d.subtract(d.create(),k,f);m=d.length(g);k=d.length(f);d.scale(g,g,Math.min(1,n/m));d.scale(f,f,Math.min(1,n/k));m=Math.min(m,n);k=Math.min(k,n);n=a.fromValues(g[0],g[1],Math.sqrt(Math.max(0,h-m*m)));f=a.fromValues(f[0],f[1],Math.sqrt(Math.max(0,h-k*k)));n=a.cross(a.create(),
n,f);f=a.length(n);if(1E-4>Math.abs(f))return e.identity(b),b;a.scale(n,n,-1/f);h=f/h;f=Math.sqrt(Math.max(0,1-h*h));h=Math.sqrt(Math.max(0,(1-f)/2));f=Math.sqrt(Math.max(0,(1+f)/2));k=n[0]*h;g=n[1]*h;h*=n[2];b[0]=f*f+k*k-g*g-h*h;b[1]=2*(k*g+f*h);b[2]=2*(k*h-f*g);b[3]=0;b[4]=2*(k*g-f*h);b[5]=f*f-k*k+g*g-h*h;b[6]=2*(g*h+f*k);b[7]=0;b[8]=2*(k*h+f*g);b[9]=2*(g*h-f*k);b[10]=f*f-k*k-g*g+h*h;b[11]=0;return b}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2;c.OpacityControl=function(a,e,b){this.graphAreaColor="#a0a0a0";this.toolsAreaColor="#c0c0c0";this.presets=b;this._buildUi(a,e,b);this.opacityCurve=b?c.OpacityCurve.FromString(b[0].opacityCurveStr):new c.OpacityCurve;this.activePtIndex=0;this.colorPicker.value=c.Color.ToHexString(this.opacityCurve.curvePts[this.activePtIndex]);this._drawGraph();this.graphInteractor=new c.Interactor(this.canvas,"opgraph",{btns:0,shift:t,ctrl:t,alt:!1});this.graphInteractor.addEventListener("start move end",
this._onGraphInteract.bind(this));this.canvas.addEventListener(c.Utils.isTouchDevice()?"touchend":"mouseup",this._onGraphClick.bind(this))};c.OpacityControl.prototype._buildUi=function(a,e,b){var f=c.Ui;this.mainDiv=f.CreateElement("div","opcontrol_maindiv",null,{width:a,height:e});e-=50;this.graphDiv=f.CreateElement("div","opcontrol_graphdiv",this.mainDiv,{width:a,height:e});this.toolsDiv=f.CreateElement("div","opcontrol_toolsdiv",this.mainDiv,{width:a-2,height:50,bottom:0,border:"1px solid #909090"});
this.canvas=f.CreateElement("canvas","opcontrol_canvas",this.graphDiv,{width:a,height:e},{width:a,height:e,borderWidth:6});this.canvas.addEventListener("contextmenu",function(g){g.preventDefault()});this.colorPicker=f.CreateElement("input","opcontrol_colorpicker",this.toolsDiv,{width:75,height:30,left:20,top:10},{type:"color",value:"#ffffff"});this.colorPicker.addEventListener("change",this._onColorSelected.bind(this));f.CreateElement("label","opcontrol_colorpicker_label",this.toolsDiv,{left:110,
top:16},{innerHTML:"Point color"});if(b){this.presetSelector=f.CreateElement("select","opcontrol_presetselector",this.toolsDiv,{width:140,height:30,right:80,top:10,fontSize:16},{val:"0"});for(a=0;a<b.length;a++)f.CreateElement("option","opcontrol_presetoption",this.presetSelector,{},{value:a.toString(),text:b[a].name});this.presetSelector.addEventListener("change",function(){this.trigger("preset-selected",{val:this.presetSelector.selectedIndex})}.bind(this));f.CreateElement("label","opcontrol_presetselector_label",
this.toolsDiv,{right:20,top:16},{innerHTML:"Preset"})}};c.OpacityControl.prototype.setOpacityCurve=function(a,e){this.opacityCurve.setControlPoints(a.controlPts);this._drawGraph();this.presets&&this._updatePresetSelector();e||this.trigger("opacity-change",{opCurve:this.opacityCurve})};c.OpacityControl.prototype.setPresets=function(a){for(;0<this.presetSelector.options.length;)this.presetSelector.remove(0);a.forEach(function(e,b){c.Ui.CreateElement("option","3dcon_presetoption",this.presetSelector,
{},{value:b.toString(),text:e.name})}.bind(this))};c.OpacityControl.prototype._updatePresetSelector=function(){if(this.presets){for(var a=this.opacityCurve.toString(),e=-1,b=0;b<this.presets.length;b++)if(this.presets[b].opacityCurveStr==a){e=b;break}this.presetSelector.selectedIndex!=e&&(this.presetSelector.selectedIndex=e)}};c.OpacityControl.prototype._onColorSelected=function(){if(null!==this.activePtIndex){var a=this.opacityCurve.curvePts[this.activePtIndex];if(a){var e=c.Color.FromHexString(this.colorPicker.value);
a.r=e.r;a.g=e.g;a.b=e.b;this.opacityCurve._updateControlPointsFromCurvePoints()}this._drawGraph();this.trigger("opacity-change",{opCurve:this.opacityCurve})}};c.OpacityControl.prototype._onGraphInteract=function(a){if("start"==a.type){if(c.Utils.isTouchDevice()||0===a.detail.origEvent.button){var e=this._hitTest(this.graphInteractor.currPoint);if(null!==e){this.activePtIndex=e;this.draggingCurve=!0;this.colorPicker.value=c.Color.ToHexString(this.opacityCurve.curvePts[this.activePtIndex]);this.alphaStart=
this.opacityCurve.curvePts[this.activePtIndex].a;for(this.leftPtIndex=this.indxStart=this.activePtIndex;0<this.leftPtIndex&&!this.opacityCurve.curvePts[this.leftPtIndex-1];)this.leftPtIndex--;for(this.rightPtIndex=this.activePtIndex;this.rightPtIndex<this.opacityCurve.numPoints()-1&&!this.opacityCurve.curvePts[this.rightPtIndex+1];)this.rightPtIndex++;this._drawGraph();this.trigger("opacity-change-start")}}}else if("move"==a.type){if(this.draggingCurve){e=d.create();if(a.detail.origEvent.ctrlKey||
a.detail.origEvent.metaKey){d.subtract(e,this._windowPointToCurvePoint(this.graphInteractor.currPoint),this._windowPointToCurvePoint(this.graphInteractor.prevPoint));a.detail.origEvent.shiftKey&&d.scale(e,e,.2);a=this.opacityCurve.controlPts;var b=a.length/2;if(3<b&&(e=Math.round(e[0]),e=0<e?Math.min(e,Math.max(0,c.OpacityCurve.NumPoints-1-a[2*b-4]-10)):Math.max(e,Math.min(0,-(a[2]-10))),0!=e)){for(let f=2;f<2*b-2;f+=2)a[f]+=e;this.opacityCurve.setControlPoints(a)}}else d.subtract(e,this._windowPointToCurvePoint(this.graphInteractor.currPoint),
this._windowPointToCurvePoint(this.graphInteractor.startPoint)),a.detail.origEvent.shiftKey&&d.scale(e,e,.2),a=this.opacityCurve.curvePts,a[this.activePtIndex].a=Math.max(0,Math.min(255,Math.round(this.alphaStart+e[1]))),0!==this.activePtIndex&&this.activePtIndex!==this.opacityCurve.numPoints()-1&&(e=Math.max(this.leftPtIndex,Math.min(this.rightPtIndex,Math.round(this.indxStart+e[0]))),e!=this.activePtIndex&&(a[e]=a[this.activePtIndex],a[this.activePtIndex]=null,this.activePtIndex=e));this.opacityCurve._updateControlPointsFromCurvePoints();
this._drawGraph();this.trigger("opacity-change",{opCurve:this.opacityCurve})}}else"end"==a.type&&this.draggingCurve&&(this.trigger("opacity-change-end"),this.draggingCurve=!1)};c.OpacityControl.prototype._onGraphClick=function(a){var e=c.Utils.isTouchDevice();if(e||2===a.button)if(!e||a.originalEvent&&a.originalEvent.targetTouches&&a.originalEvent.targetTouches.length){a.preventDefault();e=c.Interactor._getEventCoordinates(a);a=this.canvas.getBoundingClientRect();e=[e[0]-a.left,e[1]-a.top];a=this.opacityCurve.curvePts;
var b=this.opacityCurve.numPoints(),f=!1,g=this._hitTest(e);if(g&&g!=b-1)a[g]=null,this.activePtIndex=0,this.colorPicker.value=c.Color.ToHexString(a[0]),f=!0;else if(e=this._windowPointToCurvePoint(e),!a[e[0]]){f=0;for(b=e[0]-1;0<=b;b--)if(a[b]){f=a[b];break}f=new c.Color(f.r,f.g,f.b,e[1]);a[e[0]]=f;this.activePtIndex=e[0];this.colorPicker.value=c.Color.ToHexString(f);f=!0}f&&(this.opacityCurve._updateControlPointsFromCurvePoints(),this._drawGraph(),this.trigger("opacity-change",{opCurve:this.opacityCurve}))}};
c.OpacityControl.prototype._hitTest=function(a){a=this._windowPointToCurvePoint(a);for(var e=this.opacityCurve.curvePts,b=e.length,f=256/b*(this.canvas.width/this.canvas.height),g=Number.MAX_SAFE_INTEGER,h=-1,k=0;k<b;k++)if(e[k]){var m=(k-a[0])*f,n=e[k].a-a[1];m=m*m+n*n;m<g&&(g=m,h=k)}return 10>Math.sqrt(g)?h:null};c.OpacityControl.prototype._windowPointToCurvePoint=function(a){var e=this.canvas.borderWidth,b=this.canvas.width-2*e,f=this.canvas.height-2*e,g=this.opacityCurve.numPoints()-1;b=Math.round((a[0]-
e)*g/b);b=Math.max(0,Math.min(g,b));a=Math.round(255*(this.canvas.height-1-a[1]-e)/f);a=Math.max(0,Math.min(255,a));return[b,a]};c.OpacityControl.prototype._drawGraph=function(){var a=this.canvas.getContext("2d"),e=this.canvas.width,b=this.canvas.height,f=this.canvas.borderWidth,g=e-2*f,h=b-2*f;a.clearRect(0,0,e,b);a.beginPath();a.fillStyle=this.graphAreaColor;a.fillRect(0,0,e,b);a.beginPath();a.strokeStyle="#606060";a.rect(0,0,e,b);a.stroke();a.rect(f,f,e-2*f,b-2*f);a.stroke();e=this.opacityCurve.controlPts;
for(var k=c.OpacityCurve.NumPoints,m,n,l,p=0;p<e.length;p+=2){var r=e[p],q=e[p+1],u=c.Color.ToHexString(q),x=f+r/(k-1)*g;q=b-(f+q.a/255*h);r=r==this.activePtIndex?6:4;a.beginPath();a.arc(x,q,r,0,2*Math.PI,!0);a.fillStyle=u;a.fill();if(m||0===m)r=a.createLinearGradient(m,n,x,q),r.addColorStop(0,l),r.addColorStop(1,u),a.strokeStyle=r,a.beginPath(),a.moveTo(m,n),a.lineTo(x,q),a.stroke();m=x;n=q;l=u}};c.OpacityControl.prototype.addEventListener=function(a,e){c.Notifier.prototype.addEventListener.call(this,
a,e)};c.OpacityControl.prototype.removeEventListener=function(a,e){c.Notifier.prototype.removeEventListener.call(this,a,e)};c.OpacityControl.prototype.trigger=function(a,e){c.Notifier.prototype.trigger.call(this,a,e)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.OpacityCurve=function(d){var a=c.OpacityCurve.NumPoints;this.curvePts=Array(a);this.controlPts=[];d=d||[0,new c.Color(255,255,255,0),a/4,new c.Color(255,180,140,0),3*a/4,new c.Color(255,255,255,240),a-1,new c.Color(255,255,255,240)];this.setControlPoints(d);this.rgbaBuf=new Uint8Array(4*a)};c.OpacityCurve.NumPoints=1024;c.OpacityCurve.prototype.clone=function(){return new c.OpacityCurve(this.controlPts)};c.OpacityCurve.prototype.updateFrom=function(d){this.setControlPoints(d.controlPts)};
c.OpacityCurve.prototype.numPoints=function(){return this.curvePts.length};c.OpacityCurve.prototype.setControlPoints=function(d){this.controlPts=[];for(var a=0;a<this.curvePts.length;a++)this.curvePts[a]=null;for(a=0;a<d.length;a+=2)this.controlPts.push(d[a]),this.controlPts.push(c.Color.Clone(d[a+1])),this.curvePts[d[a]]=c.Color.Clone(d[a+1])};c.OpacityCurve.prototype.copyToTexture=function(d){if(d.width!=this.curvePts.length)c.Logger.Report("OpacityCurve.copyToTexture: Invalid texture size.",c.Logger.Severity.Error);
else{for(var a=this.curvePts,e=a.length,b=0,f=1,g=a[0]||new c.Color(0,0,0,0);f<e;){var h=a[f];h||f!=e-1||(h=new c.Color(0,0,0,0));if(h){for(var k=b;k<=f;k++){var m=(k-b)/(f-b);this.rgbaBuf[4*k]=Math.round(g.r+m*(h.r-g.r));this.rgbaBuf[4*k+1]=Math.round(g.g+m*(h.g-g.g));this.rgbaBuf[4*k+2]=Math.round(g.b+m*(h.b-g.b));this.rgbaBuf[4*k+3]=Math.round(g.a+m*(h.a-g.a))}b=f;g=h}f++}a=d.context.gl;d.bind();a.texSubImage2D(a.TEXTURE_2D,0,0,0,e,1,a.RGBA,a.UNSIGNED_BYTE,this.rgbaBuf);a.texSubImage2D(a.TEXTURE_2D,
0,0,1,e,1,a.RGBA,a.UNSIGNED_BYTE,this.rgbaBuf)}};c.OpacityCurve.prototype.toString=function(){for(var d="",a=this.controlPts,e=0;e<a.length;e+=2)d+="["+a[e].toString()+"]"+a[e+1].toString()+(e<a.length-2?"; ":"");return d};c.OpacityCurve.FromString=function(d){var a=null;try{var e=d.trim().split(";");d=[];for(var b=0;b<e.length;b++){var f=e[b],g=f.indexOf("["),h=f.indexOf("]"),k=parseInt(f.substring(g+1,h)),m=c.Color.FromString(f.substring(h+1));d.push(k,m)}a=new c.OpacityCurve(d)}catch(n){c.Logger.Report("OpacityCurve.FromString: Invalid input string",
c.Logger.Severity.Error)}return a};c.OpacityCurve.prototype._updateControlPointsFromCurvePoints=function(){this.controlPts=[];for(var d=0;d<this.curvePts.length;d++)this.curvePts[d]&&(this.controlPts.push(d),this.controlPts.push(c.Color.Clone(this.curvePts[d])))}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity,a=glMatrix.vec3,e=glMatrix.vec4;c.RenderEngine=function(b={}){this.canvas=b.canvas||c.Ui.CreateElement("canvas","renderengine_canvas",null,{width:100,height:100,background:"black"});this.options=structuredClone(b.options||{});this.ctx=new c.GLContext(this.canvas,b.options);this.auxVolume=this.volume=null;this.shaders={};this.frameBuffers={};this.vertexBuffers={};this.lutTexture=null;this.prevOpacityCurve="";this.loadingAuxData=this.loadingData=!1;this.shadowMapRez=
.5;this.baseRayStepSize=.01;this.viewport=[0,0,300,150];this.smViewport=[0,0,300,150];b=this.ctx;var f=b.gl;this.volume=new c.Volume(b,1);this.auxVolume=new c.Volume(b,2);this.volMask=new c.VolMask(b,3);this.frameBuffers.threed=new c.FrameBuffer(b,4,this.canvas.width,this.canvas.height,f.RGBA,f.LINEAR,!1);this.frameBuffers.shadows=new c.FrameBuffer(b,5,8,8,f.RGBA,f.LINEAR,!1);this.frameBuffers.gfx=new c.FrameBuffer(b,6,8,8,f.RGBA,f.LINEAR,!0);this.lutTexture=new c.Texture2D(b,7,c.OpacityCurve.NumPoints,
16,f.RGBA,f.LINEAR);this._createColorMapLuts();this.vertexBuffers.threed=b.createAttrBuffer(new c.Shapes3D.Cube(1,[.5,.5,.5]),3);this.vertexBuffers.twod=b.createAttrBuffer([-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0],3)};c.RenderEngine.prototype.destroy=function(){this.ctx&&(this.volume.destroy(),this.volume=null,this.auxVolume.destroy(),this.auxVolume=null,this.volMask.destroy(),this.volMask=null,this.lutTexture.destroy(),this.lutTexture=null,Object.values(this.frameBuffers).forEach(b=>{b&&b.destroy()}),
Object.values(this.vertexBuffers).forEach(b=>{b&&b.destroy()}),Object.values(this.shaders).forEach(b=>{b&&b.destroy()}),this.frameBuffers={},this.vertexBuffers={},this.shaders={},this.ctx=null)};c.RenderEngine.prototype.sizeRasterFor=function(b,f=1,g=!1){var h=Math.round(f*b[0]),k=Math.round(f*b[1]);this.viewport=[0,0,h,k];h=g?h:Math.max(this.canvas.width,h);k=g?k:Math.max(this.canvas.height,k);this.canvas.width!=h&&(this.canvas.width=h);this.canvas.height!=k&&(this.canvas.height=k);this.frameBuffers.threed.resize(h,
k);this.frameBuffers.gfx.resize(2*h,2*k);f=Math.min(this.shadowMapRez,f);var [m,n]=[Math.round(f*b[0]),Math.round(f*b[1])];this.smViewport=[0,0,m,n];b=this.frameBuffers.shadows;var [l,p]=[Math.round(f*h),Math.round(f*k)];b.resize(g?l:Math.max(b.width,l),g?2*p:Math.max(b.height,2*p))};c.RenderEngine.prototype.clearCanvas=function(b){b instanceof string&&(b=c.Color.FromHexString(b));this.ctx.clearCanvas(b||c.Color.Black())};c.RenderEngine.prototype.loadVolume=function(b={}){if(this.loadingData)return c.Logger.Report("RenderEngine ignored an overlapping load request.",
d.Warn),b.completionCb&&b.completionCb("RenderEngine ignored an overlapping load request.",null,this),"RenderEngine ignored an overlapping load request.";var f=this.loader=b.loader;f.clientData=f.clientData||{};f.clientData.renderEngineData={completionCb:b.completionCb};this.loadingData=!0;if(f=f.loadImagesIntoVolume(b.imgFiles,this.volume,this._onVolumeLoaded.bind(this),b.progressCb))return c.Logger.Report(f,d.Error),this.loadingData=!1,b.completionCb&&b.completionCb(f,null,this),this.loader=null,
f};c.RenderEngine.prototype.cancelLoading=function(){this.loadingData&&(this.loadingData=!1,this.loader&&this.loader.cancelLoading(),this.loader=null);this.loadingAuxData&&(this.loadingAuxData=!1,this.auxLoader&&this.auxLoader.cancelLoading(),this.auxLoader=null)};c.RenderEngine.prototype._onVolumeLoaded=function(b){this.loadingData=!1;var f=b.clientData.renderEngineData;if(b.errors)f.completionCb&&f.completionCb(b.errors,b.warnings,this);else{try{var g=this.frameBuffers.threed.width,h=this.frameBuffers.threed.height;
this.frameBuffers.shadows.resize(Math.round(this.shadowMapRez*g),2*Math.round(this.shadowMapRez*h));this.frameBuffers.gfx.resize(2*g,2*h);this.volMask.resize(...this.volume.dims);this.baseRayStepSize=1/Math.max(...this.volume.dims,64)}catch(k){g="RenderEngine exception: "+k.message;f.completionCb&&f.completionCb(g,b.warnings,this);return}f.completionCb&&f.completionCb("",b.warnings,this);this.loader=null}};c.RenderEngine.prototype.hasImageData=function(){return this.volume.loaded};c.RenderEngine.prototype.loadAuxVolume=
function(b={}){if(this.loadingAuxData)return c.Logger.Report("RenderEngine ignored an overlapping load request.",d.Error),b.completionCb&&b.completionCb("RenderEngine ignored an overlapping load request.",null,this),"RenderEngine ignored an overlapping load request.";var f=this.auxLoader=b.loader;f.clientData=f.clientData||{};f.clientData.renderEngineData={completionCb:b.completionCb};this.loadingAuxData=!0;if(f=f.loadImagesIntoVolume(b.imgFiles,this.auxVolume,this._onAuxVolumeLoaded.bind(this),b.progressCb))return c.Logger.Report(f,
d.Error),this.loadingAuxData=!1,b.completionCb&&b.completionCb(f,null,this),this.auxLoader=null,f};c.RenderEngine.prototype._onAuxVolumeLoaded=function(b){this.loadingAuxData=!1;var f=b.clientData.renderEngineData;b.errors?f.completionCb&&f.completionCb(b.errors,b.warnings,this):(f.completionCb&&f.completionCb("",b.warnings,this),this.auxLoader=null)};c.RenderEngine.prototype.animate=function(b,f){if(this.isAnimating())c.Logger.Report("RenderEngine: Overlapping animate request ignored.",d.Warn);else{var g=
0<b?1E3/b:0,h=performance.now(),k=function(){if(0>=g)f();else{var m=performance.now();m-h>g&&(h=m,f())}this.animId=c.Utils.requestAnimFrame(k)}.bind(this);this.animId=c.Utils.requestAnimFrame(k)}};c.RenderEngine.prototype.stopAnimation=function(){this.isAnimating()&&(c.Utils.cancelAnimFrame(this.animId),this.animId=null)};c.RenderEngine.prototype.isAnimating=function(){return!!this.animId};c.RenderEngine.prototype.render=function(b,f,g={}){var h=this.volume;if(h.loaded&&!this.loadingData){h.setInterpType(b.interpType);
this.sizeRasterFor(f.viewportDims,b.rasterDownsamp);var k=this._getCurrentVolShaderNames(b);h=k.vol;k=g.pickPointV?null:k.shadow;this.ctx.gl.enable(this.ctx.gl.CULL_FACE);var m=b.slab?b.slab.getVerticesTx().map(p=>[...p]).flat():Array(24).fill(0),n=b.renderType==c.RenderType.VR,l=b.renderType==c.RenderType.XRAY;if(n||l)l=b.opacityCurve.toString(),l!=this.prevOpacityCurve&&(b.opacityCurve.copyToTexture(this.lutTexture),this.prevOpacityCurve=l);k&&this._renderShadowMaps(k,m,b,f);n&&!g.pickPointV&&b.showGraphics&&
this._renderGraphics(b,f);this._renderVolToFramebuffer(h,m,b,f,g.pickPointV);g.pickPointV||(this._renderFramebufferToCanvas(b,f,g.overlayLines),Object.values(this.frameBuffers).forEach(p=>{p&&p.invalidate()}))}};c.RenderEngine.prototype.doPointPicking=function(b,f,g){if(!this.volume.loaded||!g)return null;this.render(b,f,{pickPointV:g});f=this.ctx.gl;b=new Uint8Array(4);f.readPixels(Math.floor(g[0]),Math.floor(g[1]),1,1,f.RGBA,f.UNSIGNED_BYTE,b);g=null;0===b[3]%2&&(g=a.fromValues((8*b[0]+Math.floor(b[1]/
32))/1023,(b[1]%32*32+Math.floor(b[2]/8))/1023,(b[2]%8*128+Math.floor(b[3]/2))/1023));return g};c.RenderEngine.prototype._renderShadowMaps=function(b,f,g,h){var k=this.volume,m=k.getOpacityRange();b=this._useShader(b);b.setUniform("uBitsPerPixel",k.bpp);b.setUniform("uVolShape",k.shape);b.setUniform("uOpacityRange",[m[0],1/m[1]]);b.setUniform("uRayStepSize",this.baseRayStepSize);b.setUniform("uMaxSkip",Math.max(1,g.maxRaySkip));b.setUniform("uApplyVolMask",g.applyVolMask);b.setUniform("uUseAuxVol",
g.useAuxVol);b.setUniform("uSlabInfo",f);b.setUniform("uVolNumImages",k.dims[2]);b.setUniform("uAuxVolColorMap",g.auxVolColorMap.flat());b.setAttribute("aPosition",this.vertexBuffers.threed);f=this.frameBuffers.shadows;for(k=0;k<g.lightSet.dirLights.length;k++)0<g.lightSet.dirLights[k].shadowDarkness&&(b.setUniform("uShadowMvpTransform",h.shadowMvp[k]),b.setUniform("uShadowMvpInvTransform",h.shadowMvpInv[k]),b.draw({target:f,clearColor:c.Color.White(),viewport:[0,k*f.height/2,this.smViewport[2],this.smViewport[3]]}))};
c.RenderEngine.prototype._renderGraphics=function(b,f){var g=this.volume;if(g.loaded&&!this.loadingData&&0!=g.meshManager?.numVisibleMeshes()){var h=this._useShader("gfx");h.setUniform("uMvpTransform",f.mvp);h.setUniform("uMvpInvTransform",f.mvpInv);h.setUniform("uRotMatrix",b.rotMatrix);b=this.ctx.gl;b.bindFramebuffer(b.FRAMEBUFFER,this.frameBuffers.gfx.glFrameBuffer);b.clearColor(1,1,1,1);b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);b.enable(b.DEPTH_TEST);f=b.drawingBufferWidth;for(var k=b.drawingBufferHeight,
m=this.viewport[2],n=this.viewport[3],l=0;2>l;l++){var p=g.meshManager?.numVisibleVertices(l)||0;0<p&&(g.meshManager.activateMeshes(l,h),h.setUniform("uRenderDepthMap",!1),h.draw({numVertices:p,target:this.frameBuffers.gfx,clear:!1,viewport:[0,l*k,m,n]}),h.setUniform("uRenderDepthMap",!0),h.draw({numVertices:p,target:this.frameBuffers.gfx,clear:!1,viewport:[f,l*k,m,n]}))}b.disable(b.DEPTH_TEST)}};c.RenderEngine.prototype._renderVolToFramebuffer=function(b,f,g,h,k=null){var m=this.volume;if(m.loaded&&
!this.loadingData){b=this._useShader(b);var n=g.renderType==c.RenderType.VR,l=g.renderType==c.RenderType.MIP;l=(n||l)&&!!k;b.setUniform("uModelTransform",h.model);b.setUniform("uViewTransform",h.view);b.setUniform("uMvpTransform",h.mvp);b.setUniform("uMvpInvTransform",h.mvpInv);b.setUniform("uRayStepSize",this.baseRayStepSize/g.rayOversamp);b.setUniform("uMaxSkip",Math.max(1,g.maxRaySkip));b.setUniform("uMarkerLoc",g.markerLoc);b.setUniform("uMarkerSize",g.markerSize);b.setUniform("uShowMarker",l?
!1:g.showMarker);b.setUniform("uApplyVolMask",g.applyVolMask);b.setUniform("uUseAuxVol",g.useAuxVol);b.setUniform("uPickMode",l);b.setUniform("uSlabInfo",f);b.setUniform("uVolShape",m.shape);b.setUniform("uVolNumImages",m.dims[2]);b.setUniform("uBitsPerPixel",m.bpp);b.setAttribute("aPosition",this.vertexBuffers.threed);b.setUniform("uAuxVolColorMap",g.auxVolColorMap.flat());l&&b.setUniform("uPickPoint",[k[0],h.viewportDims[1]-k[1]]);if(n){if(f=this.frameBuffers.shadows,m=m.getOpacityRange(),b.setUniform("uAntiAlias",
g.antiAlias?1:0),b.setUniform("uGfxBlendWeight",g.gfxBlendWeight),b.setUniform("uMarkerColor",c.Color.ScaleTo1(g.markerColor)),b.setUniform("uOpacityRange",[m[0],1/m[1]]),b.setUniform("uOutVpSize",[this.viewport[2],this.viewport[3]]),b.setUniform("uSealBorders",g.sealBorders),b.setUniform("uShadowTxScale",[this.smViewport[2]/f.width,2*this.smViewport[3]/f.height]),b.setUniform("uVrBackColor",c.Color.ScaleTo1(g.vrBackColor).slice(0,3)),!l)for(b.setUniform("uAmbientLight",g.lightSet.ambientLight),m=
0;m<g.lightSet.dirLights.length;m++)k=g.lightSet.dirLights[m],f="uLights["+m.toString()+"].",b.setUniform(f+"diffuse",k.diffuse),b.setUniform(f+"specStrength",k.specStrength),b.setUniform(f+"specExp",k.specExp),b.setUniform(f+"shadowDarkness",k.shadowDarkness),b.setUniform(f+"shadowSoftness",k.shadowSoftness),b.setUniform(f+"shadowMvp",h.shadowMvp[m]),k=e.fromValues(k.dir[0],k.dir[1],k.dir[2],0),e.normalize(k,e.transformMat4(k,k,h.mvpInv)),b.setUniform(f+"dir",a.fromValues(k[0],k[1],k[2]))}else g.renderType==
c.RenderType.XRAY&&(m=m.getOpacityRange(),b.setUniform("uOpacityRange",[m[0],1/m[1]]),b.setUniform("uUseLut",g.useXrayLut));g=n?g.vrBackColor||c.Color.Black():c.Color.Black();b.draw({target:this.frameBuffers.threed,clearColor:g,viewport:this.viewport})}};c.RenderEngine.prototype._renderFramebufferToCanvas=function(b,f,g){if(this.volume.loaded&&!this.loadingData){var h=this.ctx.gl,k=this._useShader("winLevel");k.setUniform("uWinWidth",b.winWidth);k.setUniform("uWinLevel",b.winLevel);k.setUniform("uMarkerColor",
c.Color.ScaleTo1(b.markerColor));k.setUniform("uPassThruMode",b.renderType==c.RenderType.VR?1:0);k.setUniform("uColorMapIndex",b.colorMapIndex);k.setAttribute("aPosition",this.vertexBuffers.twod);k.draw();g&&(b=this._useShader("slab"),b.setUniform("uMvpTransform",f.mvp),b.setAttribute("aPosition",g.vertexBuffer),b.setAttribute("aColor",g.attrBuffer),b.draw({clear:!1,drawMode:h.LINES,numVertices:2*g.numLines,viewport:this.viewport}))}};c.RenderEngine.prototype._getCurrentVolShaderNames=function(b){var f=
this.volume;if(f.loaded&&!this.loadingData){var g=b.renderType==c.RenderType.VR,h=b.renderType==c.RenderType.XRAY,k=g?"vr":h?"xray":"mip",m=b.clipToSlab?"_slab":"";f=!h&&b.showGraphics&&0<f.meshManager?.numVisibleMeshes()?"_gfx":"";b=g&&b.lightSet.shadowsEnabled()?"_shadows":"";return{vol:k+m+f+b,shadow:g?"shadows"+m:""}}};c.RenderEngine.prototype._useShader=function(b){b=this.shaders[b]||this._createShader(b);this.ctx.setCurrentProgram(b);return b};c.RenderEngine.prototype._createShader=function(b){var f=
b.split("_")[0],g=c.ShaderCode[f+"_vert_2"],h=c.ShaderCode[f+"_frag_2"],k="";-1!==b.indexOf("_slab")&&(k+="\n#define CLIP_TO_SLAB");-1!==b.indexOf("_gfx")&&(k+="\n#define RENDER_GRAPHICS");-1!==b.indexOf("_shadows")&&(k+="\n#define RENDER_SHADOWS");if("vr"==f||"shadows"==f||"xray"==f||"winLevel"==f){var m=1/this.lutTexture.height;k+="\n#define LUT_TX_YOFFSET "+m.toString()+(0==m%1?".0":"")}"winLevel"==f&&(f=256/this.lutTexture.width,m=2/this.lutTexture.height,k+="\n#define LUT_TX_XSCALE "+f.toString()+
(0==f%1?".0":""),k+="\n#define LUT_TX_YSCALE "+m.toString()+(0==m%1?".0":""));k={"//<<SYMBOL_DEFS>>//":k};g=new c.ShaderProgram(this.ctx,b,g,h,k,k,!0);this.shaders[b]=g;g.setInputTexture("uVolumeSampler",this.volume.texture);g.setInputTexture("uAuxVolumeSampler",this.auxVolume.texture);g.setInputTexture("uVolMaskSampler",this.volMask.texture);g.setInputTexture("uWLSampler",this.frameBuffers.threed.texture);g.setInputTexture("uShadowSampler",this.frameBuffers.shadows.texture);g.setInputTexture("uGfxSampler",
this.frameBuffers.gfx.texture);g.setInputTexture("uLutSampler",this.lutTexture);return g};c.RenderEngine.prototype._createColorMapLuts=function(){var b=Math.min(257,this.lutTexture.width),f=this.lutTexture.context.gl,g=new Uint8Array(4*b);this.lutTexture.bind();var h=[];h.push([0,0,0,255]);h.push([1,1,171,255]);h.push([1,1,224,255]);h.push([0,110,255,255]);h.push([1,171,254,255]);h.push([1,224,254,255]);h.push([1,254,1,255]);h.push([190,255,0,255]);h.push([255,255,0,255]);h.push([255,224,0,255]);
h.push([255,141,0,255]);h.push([250,94,0,255]);h.push([245,0,0,255]);h.push([245,0,197,255]);h.push([222,180,222,255]);h.push([255,255,255,255]);h.push([255,255,255,255]);for(let m=0;m<b;m++){var k=h[Math.floor(m/16)];for(let n=0;4>n;n++)g[4*m+n]=k[n]}f.texSubImage2D(f.TEXTURE_2D,0,0,2,b,1,f.RGBA,f.UNSIGNED_BYTE,g);f.texSubImage2D(f.TEXTURE_2D,0,0,3,b,1,f.RGBA,f.UNSIGNED_BYTE,g)}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.mat4;c.RenderParams=function(b){this.antiAlias=!1;this.gfxBlendWeight=.5;this.interpType=c.Interp3D.TriLinear;this.lightSet=new c.LightSet;this.markerColor=c.Color.FromName("green");this.markerLoc=a.fromValues(.5,.5,.5);this.markerSize=.0075;this.opacityCurve=new c.OpacityCurve;this.pan=d.fromValues(0,0);this.persp=.5;this.rasterDownsamp=this.maxRaySkip=this.rayOversamp=1;this.renderType=c.RenderType.VR;this.rotMatrix=e.create();this.sealBorders=
!1;this.clipToSlab=this.showSlab=this.showMarker=this.showGraphics=!0;this.slab=null;this.useAuxVol=this.applyVolMask=!1;this.colorMapIndex=0;this.useXrayLut=!1;this.vrBackColor=new c.Color(18,9,57);this.winLevel=0;this.zoom=this.winWidth=1;this.auxVolColorMap=[];for(let f=0;24>f;f++)this.auxVolColorMap.push([-1,1,-1,-1]);b&&this.updateFrom(b)};c.RenderParams.prototype.updateFrom=function(b){Object.hasOwn(b,"antiAlias")&&(this.antiAlias=b.antiAlias);Object.hasOwn(b,"clipToSlab")&&(this.clipToSlab=
b.clipToSlab);Object.hasOwn(b,"gfxBlendWeight")&&(this.gfxBlendWeight=b.gfxBlendWeight);Object.hasOwn(b,"interpType")&&(this.interpType=b.interpType);Object.hasOwn(b,"lightSet")&&this.lightSet.updateFrom(b.lightSet);Object.hasOwn(b,"markerColor")&&(this.markerColor=c.Color.Clone(b.markerColor));Object.hasOwn(b,"markerLoc")&&a.copy(this.markerLoc,b.markerLoc);Object.hasOwn(b,"markerSize")&&(this.markerSize=b.markerSize);Object.hasOwn(b,"pan")&&d.copy(this.pan,b.pan);Object.hasOwn(b,"persp")&&(this.persp=
b.persp);Object.hasOwn(b,"rayOversamp")&&(this.rayOversamp=b.rayOversamp);Object.hasOwn(b,"maxRaySkip")&&(this.maxRaySkip=b.maxRaySkip);Object.hasOwn(b,"rasterDownsamp")&&(this.rasterDownsamp=b.rasterDownsamp);Object.hasOwn(b,"renderType")&&(this.renderType=b.renderType);Object.hasOwn(b,"rotMatrix")&&e.copy(this.rotMatrix,b.rotMatrix);Object.hasOwn(b,"sealBorders")&&(this.sealBorders=b.sealBorders);Object.hasOwn(b,"showGraphics")&&(this.showGraphics=b.showGraphics);Object.hasOwn(b,"showMarker")&&
(this.showMarker=b.showMarker);Object.hasOwn(b,"showSlab")&&(this.showSlab=b.showSlab);Object.hasOwn(b,"applyVolMask")&&(this.applyVolMask=b.applyVolMask);Object.hasOwn(b,"useAuxVol")&&(this.useAuxVol=b.useAuxVol);Object.hasOwn(b,"useXrayLut")&&(this.useXrayLut=b.useXrayLut);Object.hasOwn(b,"colorMapIndex")&&(this.colorMapIndex=b.colorMapIndex);Object.hasOwn(b,"vrBackColor")&&(this.vrBackColor=c.Color.Clone(b.vrBackColor));Object.hasOwn(b,"winLevel")&&(this.winLevel=b.winLevel);Object.hasOwn(b,"winWidth")&&
(this.winWidth=b.winWidth);Object.hasOwn(b,"auxVolColorMap")&&(this.auxVolColorMap=structuredClone(b.auxVolColorMap));Object.hasOwn(b,"opacityCurveStr")?this.opacityCurve.updateFrom(c.OpacityCurve.FromString(b.opacityCurveStr)):Object.hasOwn(b,"opacityCurve")&&this.opacityCurve.updateFrom(b.opacityCurve);Object.hasOwn(b,"slab")&&(this.slab?this.slab.updateFrom(b.slab):this.slab=b.slab.clone());Object.hasOwn(b,"zoom")&&(Array.isArray(b.zoom)?Array.isArray(this.zoom)?d.copy(this.zoom,b.zoom):this.zoom=
d.clone(b.zoom):Array.isArray(this.zoom)?d.set(this.zoom,b.zoom,b.zoom):this.zoom=b.zoom)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Settings=function(d){this.antiAlias=!1;this.interpType=c.Interp3D.TriLinear;this.lightSet=new c.LightSet;this.opacityCurveStr=(new c.OpacityCurve).toString();this.useXrayLut=!1;this.persp=this.colorMapIndex=0;this.rayOversamp=1;this.renderType=c.RenderType.VR;this.sealBorders=!1;this.vrBackColor=new c.Color(18,9,57);d&&this.updateFrom(d)};c.Settings.prototype.updateFrom=function(d){Object.hasOwn(d,"antiAlias")&&(this.antiAlias=d.antiAlias);Object.hasOwn(d,"interpType")&&(this.interpType=
d.interpType);Object.hasOwn(d,"lightSet")&&this.lightSet.updateFrom(d.lightSet);Object.hasOwn(d,"useXrayLut")&&(this.useXrayLut=d.useXrayLut);Object.hasOwn(d,"colorMapIndex")&&(this.colorMapIndex=d.colorMapIndex);Object.hasOwn(d,"persp")&&(this.persp=d.persp);Object.hasOwn(d,"rayOversamp")&&(this.rayOversamp=d.rayOversamp);Object.hasOwn(d,"renderType")&&(this.renderType=d.renderType);Object.hasOwn(d,"sealBorders")&&(this.sealBorders=d.sealBorders);Object.hasOwn(d,"vrBackColor")&&(this.vrBackColor=
c.Color.Clone(d.vrBackColor));Object.hasOwn(d,"opacityCurveStr")?this.opacityCurveStr=d.opacityCurveStr:Object.hasOwn(d,"opacityCurve")&&(this.opacityCurveStr=d.opacityCurve.toString())};c.Settings.prototype.matches=function(d){return this.antiAlias==d.antiAlias&&this.interpType==d.interpType&&this.lightSet.valueEquals(d.lightSet)&&this.opacityCurveStr==d.opacityCurve.toString()&&this.useXrayLut==d.useXrayLut&&this.colorMapIndex==d.colorMapIndex&&this.persp==d.persp&&this.rayOversamp==d.rayOversamp&&
this.renderType==d.renderType&&this.sealBorders==d.sealBorders&&c.Color.AreEqual(this.vrBackColor,d.vrBackColor)?!0:!1};c.Settings.prototype.toJsonString=function(){return JSON.stringify(this,function(d,a){return a.toFixed?Number(a.toFixed(8)):a},4)};c.Settings.FromJsonString=function(d){d=JSON.parse(d);var a=new c.Settings;a.updateFrom(d);a.name=d.name;return a}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Shader=function(d,a,e,b,f,g){this.context=d;this.type=a;this.name=e||"";this.code="";this.glShader=null;this.isCompiled=!1;if(f)for(var h in f)f.hasOwnProperty(h)&&(b=b.split(h).join(f[h]));this.code=b;this.glShader=d.gl.createShader(this.type);d.gl.shaderSource(this.glShader,this.code);("undefined"===typeof g||g)&&this.compile()};c.Shader.prototype.destroy=function(){this.context&&(this.glShader&&this.context.gl.deleteShader(this.glShader),this.context=null,this.code="",this.glShader=
null,this.isCompiled=!1)};c.Shader.prototype.compile=function(){if(!this.isCompiled){var d=this.context.gl;d.compileShader(this.glShader);d.getShaderParameter(this.glShader,d.COMPILE_STATUS)||d.isContextLost()?this.isCompiled=!0:c.Logger.Report("Shader.compile: "+this.name+" compilation error(s):\n"+d.getShaderInfoLog(this.glShader),c.Logger.Severity.Error)}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.ShaderProgram=function(a,e,b,f,g,h,k){this.context=a;this.name=e||"";this.glProgram=this.fShader=this.vShader=null;this.uniforms={};this.attributes={};this.numVertices=t;this.indexBuffer=null;this.isCompiled=!1;e=this.context.gl;this.vShader=new c.Shader(a,e.VERTEX_SHADER,this.name+"_vshader",b,g,k);this.fShader=new c.Shader(a,e.FRAGMENT_SHADER,this.name+"_fshader",f,h,k);this.glProgram=e.createProgram();e.attachShader(this.glProgram,this.vShader.glShader);
e.attachShader(this.glProgram,this.fShader.glShader);("undefined"===typeof k||k)&&this.compile()};c.ShaderProgram.prototype.destroy=function(){this.context&&(this.glProgram&&this.context.gl.deleteProgram(this.glProgram),this.vShader&&this.vShader.destroy(),this.fShader&&this.fShader.destroy(),this.fShader=this.vShader=this.glProgram=null,this.uniforms={},this.attributes={},this.context=null)};c.ShaderProgram.prototype.compile=function(){if(!this.isCompiled){this.vShader.compile();this.fShader.compile();
var a=this.context.gl,e=this.glProgram;a.linkProgram(e);if(a.getProgramParameter(e,a.LINK_STATUS)||a.isContextLost()){var b,f=a.getProgramParameter(e,a.ACTIVE_UNIFORMS);for(b=0;b<f;++b){var g=a.getActiveUniform(e,b),h=g.name.lastIndexOf("[0]")==g.name.length-3?g.name.slice(0,-3):g.name;this.uniforms[h]={index:b,type:g.type,size:g.size,loc:a.getUniformLocation(e,g.name)}}f=a.getProgramParameter(e,a.ACTIVE_ATTRIBUTES);for(b=0;b<f;++b)g=a.getActiveAttrib(e,b),this.attributes[g.name]={index:b,type:g.type,
size:g.size,loc:a.getAttribLocation(e,g.name),attrBuffer:null,bufferOffset:0};this.isCompiled=!0;a.detachShader(e,this.vShader.glShader);a.detachShader(e,this.fShader.glShader);a.deleteShader(this.vShader.glShader);a.deleteShader(this.fShader.glShader);this.vShader.glShader=null;this.fShader.glShader=null}else c.Logger.Report("ShaderProgram.compile: "+this.name+" link error(s):\n"+a.getProgramInfoLog(e),d.Error)}};c.ShaderProgram.prototype.setUniform=function(a,e,b){this.context.setCurrentProgram(this);
a.lastIndexOf("[0]")==a.length-3&&(a=a.slice(0,-3));var f=this.uniforms[a];f?(a=f.loc,f=this.context.uniformSetters[f.type],a&&f&&f(a,e)):"undefined"===typeof b||b||c.Logger.Report("ShaderProgram.setUniform: Unrecognized uniform: "+a,d.Warn)};c.ShaderProgram.prototype.setUniforms=function(a,e){for(var b in a)a.hasOwnProperty(b)&&this.setUniform(b,a[b],e)};c.ShaderProgram.prototype.getUniform=function(a,e){this.context.setCurrentProgram(this);var b=this.context.gl,f=this.uniforms[a];return f?e===t?
b.getUniform(this.glProgram,f.loc):(a=b.getUniformLocation(this.glProgram,a+"["+e.toString()+"]"))?b.getUniform(this.glProgram,a):null:null};c.ShaderProgram.prototype.hasUniform=function(a){a.lastIndexOf("[0]")==a.length-3&&(a=a.slice(0,-3));return this.uniforms.hasOwnProperty(a)};c.ShaderProgram.prototype.setAttribute=function(a,e,b=!0,f=0){this.attributes[a]?(this.attributes[a].attrBuffer=e,this.attributes[a].bufferOffset=f,this.numVertices=(e.numBytes-f)/e.bytesPerVertex,b&&this.bindAttributes([a])):
c.Logger.Report("ShaderProgram.setAttribute: Unrecognized attribute: "+a,d.Error)};c.ShaderProgram.prototype.bindAttributes=function(a=[]){a=a||[];var e=this.context.gl,b;for(b in this.attributes)if(this.hasAttribute(b)&&(0===a.length||0<=a.indexOf(b))){var f=this.attributes[b];f.attrBuffer&&(e.bindBuffer(e.ARRAY_BUFFER,f.attrBuffer.glBuffer),e.enableVertexAttribArray(f.loc),e.vertexAttribPointer(f.loc,f.attrBuffer.attrDim,f.attrBuffer.dataType,f.attrBuffer.normalizeValues,0,f.bufferOffset))}};c.ShaderProgram.prototype.hasAttribute=
function(a){return this.attributes.hasOwnProperty(a)};c.ShaderProgram.prototype.setIndexBuffer=function(a){this.indexBuffer=a};c.ShaderProgram.prototype.setInputTexture=function(a,e){e&&(e.bind(),this.setUniform(a,e.txIndex))};c.ShaderProgram.prototype.draw=function(a){var e=this.context.gl,b=this.indexBuffer?this.indexBuffer.numIndices:this.numVertices,f=0,g=!0,h=[0,0,0,1],k=e.TRIANGLES,m=null,n=[0,0,e.drawingBufferWidth,e.drawingBufferHeight];a&&("undefined"!==typeof a.numVertices&&(b=a.numVertices),
"undefined"!==typeof a.firstVertex&&(f=a.firstVertex),"undefined"!==typeof a.clear&&(g=a.clear),"undefined"!==typeof a.clearColor&&(h=c.Color.ScaleTo1(a.clearColor)),"undefined"!==typeof a.drawMode&&(k=a.drawMode),"undefined"!==typeof a.target&&(m=a.target),"undefined"!==typeof a.viewport&&(n=a.viewport));e.bindFramebuffer(e.FRAMEBUFFER,m?m.glFrameBuffer:null);this.context.setCurrentProgram(this);e.viewport(n[0],n[1],n[2],n[3]);g&&(e.clearColor(h[0],h[1],h[2],h[3]),e.clear(e.COLOR_BUFFER_BIT));this.indexBuffer?
(this.indexBuffer.bind(),e.drawElements(k,b,this.indexBuffer.dataType,f*this.indexBuffer.elemSize)):e.drawArrays(k,f,b)}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Shapes3D=function(){};c.Shapes3D.Cube=function(d,a,e){a=a||[0,0,0];d/=2;d=[-d,-d,-d,-d,+d,-d,+d,-d,-d,-d,+d,-d,+d,+d,-d,+d,-d,-d,+d,-d,-d,+d,+d,-d,+d,-d,+d,+d,+d,-d,+d,+d,+d,+d,-d,+d,-d,+d,-d,-d,+d,+d,+d,+d,-d,-d,+d,+d,+d,+d,+d,+d,+d,-d,-d,-d,+d,+d,-d,+d,-d,+d,+d,-d,+d,+d,+d,-d,+d,+d,+d,+d,-d,-d,-d,-d,-d,+d,-d,+d,-d,-d,+d,-d,-d,-d,+d,-d,+d,+d,-d,-d,-d,+d,-d,-d,-d,-d,+d,-d,-d,+d,+d,-d,-d,+d,-d,+d];for(var b=0;b<d.length;b++)d[b]+=a[b%3];if(!e||!e.length)return d;a=[];for(b=0;6>b;b++){var f=
e[b%e.length];"string"==typeof f&&(f=c.Color.FromName(f,!0));for(var g=0;18>g;g++)a.push(f[g%3])}return{vertices:d,colors:a}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec3,a=glMatrix.mat4;c.Slab=function(e,b,f,g){this.vol=e;this.center=b?d.clone(b):d.scale(d.create(),e.shape,.5);this.shape=f?d.clone(f):d.clone(e.shape);this.orient=g?a.clone(g):a.create()};c.Slab.prototype.clone=function(){return new c.Slab(this.vol,this.center,this.shape,this.orient)};c.Slab.prototype.updateFrom=function(e){d.copy(this.center,e.center);d.copy(this.shape,e.shape);a.copy(this.orient,e.orient)};c.Slab.prototype.reset=function(){d.scale(this.center,this.vol.shape,
.5);d.copy(this.shape,this.vol.shape);a.identity(this.orient)};c.Slab.prototype.getVerticesTx=function(){var [e,b,f]=this.shape,g=[e/2,b/2,f/2];return[[0,0,0],[e,0,0],[0,b,0],[e,b,0],[0,0,f],[e,0,f],[0,b,f],[e,b,f]].map(function(h){var k=d.create();d.subtract(k,h,g);d.transformMat4(k,k,this.orient);d.add(k,k,this.center);return d.divide(k,k,this.vol.shape)}.bind(this))};c.Slab.prototype.getFaces=function(){return[[0,1,3,2],[1,5,7,3],[2,3,7,6],[4,0,2,6],[4,5,1,0],[5,4,6,7]]};c.Slab.prototype.intersectWithPlane=
function(e,b){for(var f=this.getVerticesTx(),g=this.getFaces(),h=[null,null,null,null,null,null],k=0;6>k;k++){var m=g[k],[n,l,p,r]=[f[m[0]],f[m[1]],f[m[2]],f[m[3]]];m=[[n,l],[l,p],[p,r],[r,n]];for(var q=[],u=0;4>u;u++){var x=m[u],E=d.subtract(d.create(),x[1],x[0]),y=d.dot(e,d.subtract(d.create(),b,x[0]))/d.dot(e,E);0<=y&&1>=y&&q.push(d.add(d.create(),x[0],d.scale(d.create(),E,y)))}2==q.length&&(h[k]=q)}return h}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.Texture2D=function(a,e,b,f,g,h){this.context=a;this.txIndex=e;this.width=Math.round(b);this.height=Math.round(f);this.pixelType=g;this.interpType=h;this.glTexture=null;this.is3D=!1;a=this.context.gl;0>e||e>=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)?c.Logger.Report("Texture2D.ctor: Invalid texture index.",d.Error):0>=this.width||0>=this.height?c.Logger.Report("Texture2D.ctor: Texture size cannot be zero.",d.Error):(e=this.context.GlMaxTextureSize,this.width>
e||this.height>e?c.Logger.Report("Texture2D.ctor: The requested texture size is too large.",d.Error):(this.glTexture=a.createTexture(),this.bind(),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.interpType),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,this.interpType),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,this.pixelType,this.width,this.height,0,this.pixelType,a.UNSIGNED_BYTE,
null)))};c.Texture2D.prototype.destroy=function(){if(this.context){var a=this.context.gl;this.bind();a.texImage2D(a.TEXTURE_2D,0,this.pixelType,1,1,0,this.pixelType,a.UNSIGNED_BYTE,null);this.unbind();a.deleteTexture(this.glTexture);this.context=this.glTexture=null}};c.Texture2D.prototype.bind=function(){this.context.bindTexture(this)};c.Texture2D.prototype.unbind=function(){this.context.unbindTexture(this)};c.Texture2D.prototype.setInterpType=function(a){if(this.interpType!=a){this.bind();var e=
this.context.gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,a);this.interpType=a}};c.Texture2D.prototype.sizeEquals=function(a,e){return this.width==a&&this.height==e};c.Texture2D.prototype.resize=function(a,e){a=Math.round(a);e=Math.round(e);if(0>=a||0>=e)c.Logger.Report("Texture2D.resize: Texture size cannot be zero.",d.Error);else{var b=this.context.GlMaxTextureSize;a>b||e>b?c.Logger.Report("Texture2D.resize: Requested texture size is not supported on this device.",
d.Error):(b=this.context.gl,this.bind(),b.texImage2D(b.TEXTURE_2D,0,this.pixelType,a,e,0,this.pixelType,b.UNSIGNED_BYTE,null),this.width=a,this.height=e)}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=c.Logger.Severity;c.Texture3D=function(a,e,b,f,g,h,k,m){this.context=a;this.txIndex=e;this.width=Math.round(b);this.height=Math.round(f);this.depth=Math.round(g);this.pixelType=h;this.pixelFormat=k;this.interpType=m;this.glTexture=null;this.is3D=!0;0>=this.width||0>=this.height||0>=this.depth?c.Logger.Report("Texture3D.ctor: Invalid dimensions.",d.Error):(a=this.context.gl,0>e||e>=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)?c.Logger.Report("Texture3D.ctor: Invalid texture index.",
d.Error):(this.glTexture=a.createTexture(),this.bind(),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MIN_FILTER,this.interpType),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MAG_FILTER,this.interpType),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_R,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage3D(a.TEXTURE_3D,0,this.pixelType,this.width,this.height,this.depth,0,this.pixelFormat,a.UNSIGNED_BYTE,null)))};c.Texture3D.prototype.destroy=
function(){if(this.context){var a=this.context.gl;this.unbind();a.deleteTexture(this.glTexture);this.context=this.glTexture=null}};c.Texture3D.prototype.resize=function(a,e,b,f=0,g=0){a=Math.round(a);e=Math.round(e);b=Math.round(b);if(0>=a||0>=e||0>=b)c.Logger.Report("Texture3D.resize: Texture size cannot be zero.",d.Error);else{var h=this.context.GlMax3DTextureSize;a>h||e>h||b>h?c.Logger.Report("Texture3D.resize: Requested texture size is not supported on this device.",d.Error):(this.pixelType=f||
this.pixelType,this.pixelFormat=g||this.pixelFormat,f=this.context.gl,this.bind(),f.texImage3D(f.TEXTURE_3D,0,this.pixelType,a,e,b,0,this.pixelFormat,f.UNSIGNED_BYTE,null),this.width=a,this.height=e,this.depth=b)}};c.Texture3D.prototype.bind=function(){this.context.bindTexture(this)};c.Texture3D.prototype.unbind=function(){this.context.unbindTexture(this)};c.Texture3D.prototype.setInterpType=function(a){if(this.interpType!=a){this.interpType=a;this.bind();var e=this.context.gl;e.texParameteri(e.TEXTURE_3D,
e.TEXTURE_MIN_FILTER,a);e.texParameteri(e.TEXTURE_3D,e.TEXTURE_MAG_FILTER,a)}};c.Texture3D.prototype.sizeEquals=function(a,e,b){return this.width==a&&this.height==e&&this.depth==b};c.Texture3D.prototype.fill=function(a,e=!1){var b=this.context.gl,f=b.createBuffer();b.bindBuffer(b.PIXEL_UNPACK_BUFFER,f);var g=this.pixelType==b.R8?new Uint8Array(this.width*this.height):new Uint16Array(this.width*this.height);g.fill(a);g=g.buffer;e&&c.Loader3D._SwapByteOrder(g);b.bufferData(b.PIXEL_UNPACK_BUFFER,g,b.DYNAMIC_COPY);
this.bind();for(a=0;a<this.depth;a++)b.texSubImage3D(b.TEXTURE_3D,0,0,0,a,this.width,this.height,1,this.pixelFormat,b.UNSIGNED_BYTE,0);b.bindBuffer(b.PIXEL_UNPACK_BUFFER,null);b.deleteBuffer(f)}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2;c.ThreeDOverlayInteractor=function(a,e={}){var b=e.drag||{btns:2,shift:!1,ctrl:!0,alt:!1},f=e.rot||{btns:0,shift:!0,ctrl:!0,alt:!1};e=e.pick||{btns:1,shift:!1,ctrl:!1,alt:!1};this.dragEventTypes=Array.isArray(b)?b:[b];this.rotEventTypes=Array.isArray(f)?f:[f];this.pickEventTypes=Array.isArray(e)?e:[e];c.Interactor.call(this,a.canvas,"overlay",[].concat(this.dragEventTypes,this.rotEventTypes,this.pickEventTypes));this.viewer=a;this.pickEnabled=this.rotEnabled=this.dragEnabled=
!0;this.translateEnabled=!1};c.ThreeDOverlayInteractor.prototype=Object.create(c.Interactor.prototype);c.ThreeDOverlayInteractor.prototype.constructor=c.ThreeDOverlayInteractor;c.ThreeDOverlayInteractor.prototype.setEventTypes=function(a,e){e=Array.isArray(e)?e:[e];switch(a){case "drag":this.dragEventTypes=e;break;case "rot":this.rotEventTypes=e;break;case "pick":this.pickEventTypes=e}this.eventTypes=[].concat(this.dragEventTypes,this.rotEventTypes,this.pickEventTypes)};c.ThreeDOverlayInteractor.prototype._onStart=
function(a){this.pinching||(c.Interactor.MouseEventMatches(a,this.dragEventTypes)?this.hitTestResult=this.dragEnabled?this._hitTest(this.currPoint,"drag"):{interactMode:"none"}:c.Interactor.MouseEventMatches(a,this.rotEventTypes)?this.hitTestResult=this.rotEnabled?this._hitTest(this.currPoint,"rot"):{interactMode:"none"}:c.Interactor.MouseEventMatches(a,this.pickEventTypes)&&(this.hitTestResult=this.pickEnabled?{interactMode:"pick"}:{interactMode:"none"}));this.interactMode=this.hitTestResult.interactMode;
"none"!=this.interactMode&&"pick"!=this.interactMode&&this.trigger("start",{interactMode:this.interactMode})};c.ThreeDOverlayInteractor.prototype._onMove=function(a){"rotClipBox"==this.interactMode?(a=this.viewer.canvas.getBoundingClientRect(),a=c.MultiInteractor.CalcRotationMatrix(null,this.prevPoint,this.currPoint,[a.width,a.height]),this.trigger("move",{interactMode:this.interactMode,deltaRot:a})):"extrudeClipBox"==this.interactMode?this.trigger("move",{interactMode:this.interactMode,extrudeFace:this.hitTestResult.extrudeFace,
delta:this.deltaPrev}):"dragClipBox"==this.interactMode&&this.trigger("move",{interactMode:this.interactMode,deltaPosV:this.deltaPrev})};c.ThreeDOverlayInteractor.prototype._onEnd=function(a){a="pick"==this.interactMode&&10>d.length(this.deltaStart)?this.currPoint:t;this.trigger("end",{interactMode:this.interactMode,pickPointV:a})};c.ThreeDOverlayInteractor.prototype._hitTest=function(a,e){var b=this.viewer;if(!b.renderParams.showSlab)return{interactMode:"none"};var f=b.renderParams.slab.getVerticesTx().map(r=>
b.transforms.txToViewport(r)),g=c.Geometry.convexHull(f),h=c.Utils.PointInPolygon(a,g),k="none",m=null;if("drag"==e)if(this.translateEnabled)if(h)k="dragClipBox";else{var n=Number.MAX_VALUE,l=null;for(e=0;e<g.length;e++){h=[g[e],g[(e+1)%g.length]];var p=c.Utils.SquaredDistanceToLineSegment(a,h[0],h[1]);p<n&&(n=p,l=h)}if(100>n){k="extrudeClipBox";for(const r of b.getForwardFacingSlabFaces())if(g=r.map(q=>f[q]),g.some(q=>d.equals(q,l[0]))&&g.some(q=>d.equals(q,l[1]))){m=r;break}}}else for(n of b.getForwardFacingSlabFaces()){if(g=
n.map(r=>f[r]),c.Utils.PointInPolygon(a,g)){m=n;k="extrudeClipBox";break}}else"rot"==e&&(k="rotClipBox");return{interactMode:k,extrudeFace:m}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.vec4,b=glMatrix.mat4;c.ThreeDViewer=function(f={}){this.site=f.site;this.autoResize="undefined"===typeof f.autoResize?!0:!!f.autoResize;this.canvas=c.Ui.CreateElement("canvas","threedviewer_canvas",this.site,{width:"100%",height:"100%",backgroundColor:"#000000"});this.canvas.addEventListener("contextmenu",function(h){h.preventDefault()});this.renderEngine=f.renderEngine?f.renderEngine:new c.RenderEngine({options:f.engineOptions});this.ownsEngine=
!f.renderEngine;this.renderParams=new c.RenderParams;this.renderParams.slab=new c.Slab(this.renderEngine.volume);this.renderParams.persp=.5;this.defaultOrient=c.Utils.GetRotMatrix([1,0,0],[0,0,-1]);this.fastDrawDownsamp=.5;this.renderCallbacks=[];this.resizeTimerId=null;this.transforms=new c.Transforms(this.renderEngine.volume,this.renderParams,this.canvas);var g=this.renderEngine.ctx;this.slabLinesInfo={vertexBuffer:g.createAttrBuffer(new Float32Array(144),3,{drawMode:g.gl.DYNAMIC_DRAW}),attrBuffer:g.createAttrBuffer(new Float32Array(192),
4,{drawMode:g.gl.STATIC_DRAW}),numLines:0};this.slabLinesInfo.attrBuffer.setData(Array.from({length:96},(h,k)=>0==k%2?0:1));f.omitInteractors||(this.multiInteractor=new c.MultiInteractor(this.canvas),this.multiEventHandler=this._onMultiInteractorEvent.bind(this),this.multiInteractor.addEventListener("start move end",this.multiEventHandler),this.overlayInteractor=new c.ThreeDOverlayInteractor(this),this.overlayEventHandler=this._onOverlayInteractorEvent.bind(this),this.overlayInteractor.addEventListener("start move end",
this.overlayEventHandler),this.overlayInteractor.enabled=!1);this.resizeListener=this.onResize.bind(this);window.addEventListener("resize",this.resizeListener);this.onResize()};c.ThreeDViewer.prototype.destroy=function(){this.renderEngine&&(clearTimeout(this.resizeTimerId),window.removeEventListener("resize",this.resizeListener),c.Utils.cancelAnimFrame(this.rafId),this.multiInteractor&&(this.multiInteractor.stopListening(),this.multiInteractor=null),this.overlayInteractor&&(this.overlayInteractor.stopListening(),
this.overlayInteractor=null),this.ownsEngine&&this.renderEngine.destroy(),this.renderEngine=null,this.canvas.remove())};c.ThreeDViewer.prototype.setController=function(f){(this.controller=f)&&f.addEventListener("AllEvents",this._onControllerEvent.bind(this))};c.ThreeDViewer.prototype.setInteractionMode=function(f){if(this.multiInteractor){var g={pose:!1,winlevel:!1,overlay:!1};g.hasOwnProperty(f)&&(g[f]=!0);this.overlayInteractor&&(this.overlayInteractor.enabled=g.overlay);this.multiInteractor&&(this.multiInteractor.enabled=
g.pose||g.winlevel,this.multiInteractor.wlEnabled=g.winlevel,this.multiInteractor.panEnabled=this.multiInteractor.zoomEnabled=this.multiInteractor.rotEnabled=g.pose,this.multiInteractor.mouseWheelZoomEnabled=g.pose||g.winlevel||g.overlay)}};c.ThreeDViewer.prototype.onResize=function(f){if(this.autoResize){var g=this.canvas.getBoundingClientRect();this.canvas.width=Math.round(g.width);this.canvas.height=Math.round(g.height);this.rafId=c.Utils.requestAnimFrame(this.render.bind(this));f?this.resizeTimerId=
null:(this.resizeTimerId&&clearTimeout(this.resizeTimerId),this.resizeTimerId=setTimeout(function(){this.onResize(!0)}.bind(this),300))}};c.ThreeDViewer.prototype.clearDisplay=function(){var f=this.canvas.getContext("2d");f.fillStyle=this.renderParams.vrBackColor.toHexString();f.fillRect(0,0,this.canvas.width,this.canvas.height)};c.ThreeDViewer.prototype.loadVolume=function(f,g,h,k){var m=function(n,l){n||c.Utils.SafeInvoke(this.onNewVolumeLoaded.bind(this));c.Utils.SafeInvoke(h,[n,l,this])}.bind(this);
this.renderEngine.loadVolume({imgFiles:f,loader:g,completionCb:m,progressCb:k})};c.ThreeDViewer.prototype.loadAuxVolume=function(f,g,h,k){var m=function(n,l){c.Utils.SafeInvoke(h,[n,l,this])}.bind(this);this.renderEngine.loadAuxVolume({imgFiles:f,loader:g,completionCb:m,progressCb:k})};c.ThreeDViewer.prototype.cancelLoading=function(){this.renderEngine.cancelLoading()};c.ThreeDViewer.prototype.onNewVolumeLoaded=function(){this.resetPan();this.resetZoom();this.resetOrientation();this.resetWinLevel();
this.resetSlab()};c.ThreeDViewer.prototype.render=function(){const f=this.renderEngine;if(f.hasImageData()){var [g,h]=[this.canvas.width,this.canvas.height];this.transforms.update(this.renderParams,f.volume.dims,[g,h]);this.renderParams.rasterDownsamp=f.isAnimating()?this.fastDrawDownsamp:1;this.renderParams.maxRaySkip=1>this.renderParams.rasterDownsamp?2:1;f.render(this.renderParams,this.transforms,{overlayLines:this.calcSlabLines()});var k=this.canvas.getContext("2d"),m=f.canvas.height,[n,l]=[f.viewport[2],
f.viewport[3]];k.clearRect(0,0,g,h);k.drawImage(f.canvas,0,m-l,n,l,0,0,g,h);this.renderCallbacks.forEach(p=>{p(this)})}};c.ThreeDViewer.prototype._onMultiInteractorEvent=function(f){var g=this.renderEngine,h=this.renderParams,k=this.multiInteractor;if("start"==f.type)k.setInitialValues({zoom:h.zoom,pan:h.pan,rot:h.rotMatrix,lighting:{ambient:h.lightSet.ambientLight,shadow:h.lightSet.dirLights[0].shadowDarkness},wwl:{width:h.winWidth,level:h.winLevel,levelRange:g.volume.getAutoWinLevel()[0]}}),g.animate(15,
this.render.bind(this));else if("move"==f.type)switch(k.interactMode){case "zoom":case "wheelzoom":h.zoom=k.currentZoom;break;case "pan":d.copy(h.pan,k.currentPan);break;case "panzoom":h.zoom=k.currentZoom;d.copy(h.pan,k.currentPan);break;case "rotate":b.copy(h.rotMatrix,k.currentRot);break;case "light":h.renderType==c.RenderType.VR?(h.lightSet.ambientLight=k.ambient,h.lightSet.dirLights[0].shadowDarkness=k.shadow,this.controller&&this.controller.syncWith(this)):(h.winWidth=k.winWidth,h.winLevel=
k.winLevel)}else"end"==f.type&&(g.stopAnimation(),this.render())};c.ThreeDViewer.prototype._onControllerEvent=function(f){const g=this.renderParams,h=this.renderEngine;switch(f.type){case "change-start":case "opacity-change-start":h.animate(5,this.render.bind(this));break;case "change-end":case "opacity-change-end":h.stopAnimation(),this.render();case "change":this.renderEngine.isAnimating()||this.render();break;case "opacity-change":g.opacityCurve=f.detail.opCurve;this.renderEngine.isAnimating()||
this.render();break;case "mode-change":g.renderType=f.detail.newMode;this.render();break;case "show-marker-change":g.showMarker=f.detail.val;this.render();break;case "show-slab-change":g.showSlab=f.detail.val;this.render();break;case "clip-to-slab-change":g.clipToSlab=f.detail.val;this.render();break;case "apply-mask-change":g.applyVolMask=f.detail.val;this.render();break;case "antialias-change":g.antiAlias=f.detail.val;this.render();break;case "persp-change":g.persp=f.detail.val;this.render();break;
case "ambientLight":g.lightSet.ambientLight=f.detail.val;this.render();break;case "diffuse":g.lightSet.dirLights[f.detail.idx].diffuse=f.detail.val;this.render();break;case "specStrength":g.lightSet.dirLights[f.detail.idx].specStrength=f.detail.val;this.render();break;case "specExp":g.lightSet.dirLights[f.detail.idx].specExp=f.detail.val;this.render();break;case "shadowDarkness":g.lightSet.dirLights[f.detail.idx].shadowDarkness=f.detail.val;this.render();break;case "lightDir":a.copy(g.lightSet.dirLights[f.detail.idx].dir,
f.detail.val);this.render();break;case "iqual-change":this.fastDrawDownsamp=parseFloat(f.detail.val);break;case "speedtest-toggle":this.speedTestToggle(f.detail.stateChangeCb,f.detail.fpsChangeCb);break;case "settings-file-loaded":this.loadSettings(f.detail.settings);break;case "save-settings-request":this.saveSettings(f.detail.fileHandle)}};c.ThreeDViewer.prototype._onOverlayInteractorEvent=function(f){var g=this.renderEngine;if("start"==f.type)g.animate(15,this.render.bind(this));else if("move"==
f.type){g=this.renderParams.slab;var h=this.transforms,k=this.renderParams.rotMatrix;switch(f.detail.interactMode){case "dragClipBox":var m=h.viewportDeltaToTx(f.detail.deltaPosV);a.multiply(m,m,this.renderEngine.volume.shape);a.add(g.center,g.center,m);break;case "rotClipBox":m=b.transpose(b.create(),this.renderParams.rotMatrix);f=f.detail.deltaRot;m=b.multiply(b.create(),b.multiply(b.create(),m,f),k);b.multiply(g.orient,m,g.orient);break;case "extrudeClipBox":m=g.getFaces();for(var n=0;n<m.length;n++)if(e.equals(m[n],
f.detail.extrudeFace)){m=1==n||3==n?0:2==n||4==n?1:2;n=0==n||3==n||4==n?-1:1;var l=[g.orient[4*m],g.orient[4*m+1],g.orient[4*m+2]];h=a.length(a.mul(a.create(),h.viewportDeltaToTx([1,1]),this.renderEngine.volume.dims));k=d.normalize(d.create(),a.transformMat4(a.create(),l,k));f=d.dot(f.detail.delta,k)*h;k=g.shape[m];f=Math.max(1,g.shape[m]+n*f);k=a.add(a.create(),g.center,a.scale(a.create(),l,n*(f-k)/2));this.overlayInteractor.rotEnabled||this.overlayInteractor.translateEnabled?(g.shape[m]=f,a.copy(g.center,
k)):(n=this.renderEngine.volume.dims[m],0<=k[m]-f/2&&k[m]+f/2<=n&&(g.shape[m]=f,a.copy(g.center,k)));break}}}else"end"==f.type&&(g.stopAnimation(),this.render())};c.ThreeDViewer.prototype.setDefaultOrientation=function(f){b.copy(this.defaultOrient,f)};c.ThreeDViewer.prototype.resetOrientation=function(){b.copy(this.renderParams.rotMatrix,this.defaultOrient)};c.ThreeDViewer.prototype.resetZoom=function(){this.renderParams.zoom=.95*this.calcDefaultOrthoZoom()};c.ThreeDViewer.prototype.resetPan=function(){d.copy(this.renderParams.pan,
[0,0])};c.ThreeDViewer.prototype.resetWinLevel=function(){const f=this.renderEngine.volume.getAutoWinLevel();[this.renderParams.winWidth,this.renderParams.winLevel]=[.65*f[0],f[1]+.5*f[0]]};c.ThreeDViewer.prototype.resetSlab=function(){this.renderParams.slab.reset()};c.ThreeDViewer.prototype.calcDefaultOrthoZoom=function(){var f=1;if(this.renderEngine.hasImageData()){f=this.renderEngine.volume;var g=[this.defaultOrient[1],this.defaultOrient[5],this.defaultOrient[9]],h=[this.defaultOrient[0],this.defaultOrient[4],
this.defaultOrient[8]].reduce((m,n,l,p)=>Math.abs(n)>Math.abs(p[m])?l:m,0);g=g.reduce((m,n,l,p)=>Math.abs(n)>Math.abs(p[m])?l:m,0);var k=this.canvas.width/this.canvas.height;f=f.shape[h]/f.shape[g]>k?f.diagSize/f.shape[h]*Math.max(1,k):f.diagSize/f.shape[g]*Math.max(1,1/k)}return f};c.ThreeDViewer.prototype.calcSlabLines=function(){var f=this.renderParams.slab;if(!f||!this.renderParams.showSlab)return null;var g=f.getVerticesTx(),h=new Float32Array(144),k=[],m=0;this.getForwardFacingSlabFaces().forEach(function(n){n=
[[n[0],n[1]],[n[0],n[3]],[n[2],n[1]],[n[2],n[3]]];for(var l of n)n=10*Math.max(...l)+Math.min(...l),k.includes(n)||(k.push(n),h.set(g[l[0]],m),h.set(g[l[1]],m+3),m+=6)});this.slabLinesInfo.vertexBuffer.setData(h);this.slabLinesInfo.numLines=m/6;return this.slabLinesInfo};c.ThreeDViewer.prototype.getForwardFacingSlabFaces=function(){var f=[],g=this.renderParams.slab,h=this.transforms.mvp,k=g.getVerticesTx().map(function(n){return a.transformMat4(a.create(),n,h)});for(const n of g.getFaces()){g=a.subtract(a.create(),
k[n[1]],k[n[0]]);a.normalize(g,g);var m=a.subtract(a.create(),k[n[3]],k[n[0]]);a.normalize(m,m);1E-4<g[1]*m[0]-g[0]*m[1]&&f.push(n)}return f};c.ThreeDViewer.prototype.saveSettings=function(f){if(f)try{const g=(new c.Settings(this.renderParams)).toJsonString(),h=new Blob([g],{type:"text/plain"});f.createWritable().then(function(k){k.write(h).then(function(){k.close()})}).catch(k=>{c.Logger.Report("Failed to save Settings file",c.Logger.Severity.Warn,!0)})}catch(g){c.Logger.Report("Failed to save Settings file",
c.Logger.Severity.Warn,!0)}};c.ThreeDViewer.prototype.loadSettings=function(f){try{this.renderParams.updateFrom(f),this.controller&&this.controller.syncWith(this),this.render()}catch(g){c.Logger.Report("Failed to read settings file",c.Logger.Severity.Warn,!0)}};c.ThreeDViewer.prototype.speedTestToggle=function(f,g){var h=this.renderEngine,k=this.renderParams;if(h.hasImageData()){var m=a.fromValues(0,0,1);if(this.doingSpeedTest)h.stopAnimation(),this.doingSpeedTest=!1,this.render(),f&&f("stopped");
else{this.doingSpeedTest=!0;var n=0;f&&f("started");g&&g(0);var l=performance.now();h.animate(-1,function(){b.rotate(k.rotMatrix,k.rotMatrix,.01,m);this.render();n++;if(0===n%30){var p=3E4/(performance.now()-l);g&&g(p);n=0;l=performance.now()}}.bind(this))}}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec3;c.TiffLoader3D=function(a={}){c.Loader3D.call(this);this.imgBufferArray=null;this.fileList=[];this.extraAttrs=a.extraAttrs;this.reverseSort=!!a.reverseSort};c.TiffLoader3D.prototype=Object.create(c.Loader3D.prototype);c.TiffLoader3D.prototype.constructor=c.TiffLoader3D;c.TiffLoader3D.prototype.getImageDims=async function(a){return new Promise((e,b)=>{try{var f=new FileReader;f.onload=()=>{try{var g=UTIF.decode(f.result);e([g[0].t256[0],g[0].t257[0]])}catch(h){b(h)}};
f.onerror=g=>{b(g)};a instanceof FileSystemFileHandle?a.getFile().then(function(g){f.readAsArrayBuffer(g)}).catch(function(g){b(g)}):f.readAsArrayBuffer(a)}catch(g){b(g)}})};c.TiffLoader3D.prototype.loadImagesIntoVolume=function(a,e,b,f){this.fileList=[];Array.prototype.push.apply(this.fileList,a);this.vol=e;this.warnings=this.errors=null;this.done=!1;this.loadCompleteCb=b;this.loadProgressCb=f;if(this.fileList&&this.fileList.length)if(this.fileList.some(h=>!(h instanceof FileSystemFileHandle)&&!(h instanceof
File)))this.done=!0,this.errors="TiffLoader3D: Invalid item in file list.",c.Utils.SafeInvoke(this.loadCompleteCb,[this]);else{var g=new FileReader;g.onload=function(){this._onInitialImageLoaded(g)}.bind(this);g.onerror=function(){this._onImageLoadingError(g)}.bind(this);(a=this.fileList.find(h=>!h.name.toLowerCase().startsWith("slicegap")))?(c.Utils.SafeInvoke(this.loadProgressCb,[0,this.fileList.length]),a instanceof FileSystemFileHandle?a.getFile().then(function(h){g.readAsArrayBuffer(h)}).catch(function(h){this._onImageLoadingError(g)}.bind(this)):
g.readAsArrayBuffer(a)):this.done||(this.done=!0,this.errors="No tiff files were specified.",c.Utils.SafeInvoke(this.loadCompleteCb,[this]))}else this.done=!0,this.warnings="TiffLoader3D: No files were loaded, because the supplied file list was empty.",c.Utils.SafeInvoke(this.loadCompleteCb,[this])};c.TiffLoader3D.prototype._onInitialImageLoaded=function(a){if(!this.cancelled)try{var e=UTIF.decode(a.result);if(1<e.length)this._handleMultiImageTiff(a.result,e);else{UTIF.decodeImage(a.result,e[0]);
var b=e[0].isLE?"little":"big",f=e[0].width,g=e[0].height,h=e[0].t258[0],k=1,m=!1,n=this.fileList.find(r=>r.name.toLowerCase().startsWith("slicegap"));if(n)try{k=parseFloat(n.name.substring(8)),0>k&&(m=!0),k=Math.abs(k)}catch(r){c.Logger.Report("Failed to read slice gap. Defaulting to 1.0.",c.Logger.Severity.Warn)}this.fileList=this.fileList.filter(r=>!r.name.toLowerCase().startsWith("slicegap"));this.fileList=m!=this.reverseSort?this.fileList.sort((r,q)=>q.name.localeCompare(r.name)):this.fileList.sort((r,
q)=>r.name.localeCompare(q.name));if(this.errors=this.vol.loadBegin([f,g,this.fileList.length],h,b))this.done=!0,c.Utils.SafeInvoke(this.loadCompleteCb,[this]);else{this.vol.setAttr("modality","Tiff");this.vol.setAttr("rescaleSlope",1);this.vol.setAttr("rescaleIntercept",0);this.vol.setAttr("dataOffset",0);this.vol.setAttr("sliceGap",k);this.vol.setAttr("rowDir",d.fromValues(1,0,0));this.vol.setAttr("colDir",d.fromValues(0,1,0));this.vol.calcNearLphAxes();try{if(this.extraAttrs)for(var l of this.extraAttrs){var p=
e[0]["t"+l[0].toString()];Array.isArray(p)&&(p=p[0]);p||0===p||(p="");this.vol.setAttr(l[1],p.toString())}}catch(r){}this.imgBufferArray=Array(4);this._loadNextBatch(0)}}}catch(r){this._onImageLoadingError(a)}};c.TiffLoader3D.prototype._loadNextBatch=function(a){var e=8==this.vol.bpp?4:2;e=Math.min(e,this.vol.dims[2]-a);for(var b={startIndex:a,endIndex:a+e,numLeftToLoad:e,imgBuffers:this.imgBufferArray},f=0;f<e;f++)this._loadSingleImage(a+f,b)};c.TiffLoader3D.prototype._loadSingleImage=function(a,
e){var b=new FileReader;b.fileName=this.fileList[a].name;b.batchInfo=e;b.onload=function(){this._onImageLoaded(a,b)}.bind(this);b.onerror=function(){this._onImageLoadingError(b)}.bind(this);e=this.fileList[a];if(e instanceof FileSystemFileHandle)try{e.getFile().then(function(f){b.readAsArrayBuffer(f)})}catch(f){this._onImageLoadingError(b)}else b.readAsArrayBuffer(e)};c.TiffLoader3D.prototype._onImageLoadingError=function(a){this.cancelled||this.done||(this.done=!0,this.errors=a instanceof FileReader?
"Error loading image "+(a?a.fileName||"":""):a.message?a.message:"Error loading image.",c.Utils.SafeInvoke(this.loadCompleteCb,[this]))};c.TiffLoader3D.prototype._onImageLoaded=function(a,e){if(!this.done&&!this.cancelled)try{var b=UTIF.decode(e.result);UTIF.decodeImage(e.result,b[0]);var f=e.batchInfo;f.imgBuffers[a-f.startIndex]=16==this.vol.bpp?new Uint16Array(b[0].data.buffer):new Uint8Array(b[0].data.buffer);f.numLeftToLoad--;c.Utils.SafeInvoke(this.loadProgressCb,[f.endIndex-f.numLeftToLoad,
this.vol.dims[2]]);0===f.numLeftToLoad&&(this._copyImagesToTexture(f),f.endIndex<this.vol.dims[2]?this._loadNextBatch(f.endIndex):this.done||(this.vol.loadEnd(),this.done=!0,c.Utils.SafeInvoke(this.loadCompleteCb,[this])))}catch(g){this._onImageLoadingError(e)}};c.TiffLoader3D.prototype._handleMultiImageTiff=async function(a,e){try{UTIF.decodeImage(a,e[0]);var b=e[0].isLE?"little":"big",f=e[0].width,g=e[0].height,h=e.length,k=e[0].t258[0],m=1,n=this.fileList.find(x=>x.name.toLowerCase().startsWith("slicegap"));
if(n)try{m=parseFloat(n.name.substring(8))}catch(x){Lib3D.MiscUtils.reportMessage("Failed to read slice gap. Defaulting to 1.0")}if(this.errors=this.vol.loadBegin([f,g,h],k,b))this.done=!0,c.Utils.SafeInvoke(this.loadCompleteCb,[this]);else{this.vol.setAttr("modality","Tiff");this.vol.setAttr("rescaleSlope",1);this.vol.setAttr("rescaleIntercept",0);this.vol.setAttr("dataOffset",0);this.vol.setAttr("sliceGap",m);this.vol.setAttr("rowDir",d.fromValues(1,0,0));this.vol.setAttr("colDir",d.fromValues(0,
1,0));this.vol.calcNearLphAxes();try{if(this.extraAttrs)for(var l of this.extraAttrs){var p=e[0]["t"+l[0].toString()];Array.isArray(p)&&(p=p[0]);p||0===p||(p="");this.vol.setAttr(l[1],p.toString())}}catch(x){}this.imgBufferArray=Array(4);var r=8==this.vol.bpp?4:2;for(b=0;b<h;){r=Math.min(r,h-b);var q={startIndex:b,endIndex:b+r,numLeftToLoad:r,imgBuffers:this.imgBufferArray};for(f=0;f<r;f++){var u=q.startIndex+f;0<u&&(e[u-1].data=null);UTIF.decodeImage(a,e[u]);q.imgBuffers[f]=16==this.vol.bpp?new Uint16Array(e[u].data.buffer):
new Uint8Array(e[u].data.buffer);q.numLeftToLoad--;if(0===q.numLeftToLoad&&(this._copyImagesToTexture(q),q.endIndex==h&&!this.done)){this.vol.loadEnd();this.done=!0;c.Utils.SafeInvoke(this.loadCompleteCb,[this]);return}}if(this.loadProgressCb&&(c.Utils.SafeInvoke(this.loadProgressCb,[q.endIndex-q.numLeftToLoad,this.vol.dims[2]]),await new Promise(x=>setTimeout(x,5)),this.cancelled))break;b+=r}}}catch(x){this._onImageLoadingError(x)}}})(window.BigLime=window.BigLime||{});
(function(c,t){var d=glMatrix.vec2,a=glMatrix.vec3,e=glMatrix.vec4,b=glMatrix.mat4;c.Transforms=function(){this.model=b.create();this.view=b.create();this.mvp=b.create();this.mvpInv=b.create();this.mvpv=b.create();this.mvpvInv=b.create();this.shadowMvp=[b.create(),b.create()];this.shadowMvpInv=[b.create(),b.create()];this.viewportDims=[1,1]};c.Transforms.prototype.update=function(f,g,h){var k=b.create(),m=b.create(),n=b.fromTranslation(k,[-.5,-.5,-.5]);g=a.normalize(a.create(),g);g=b.fromScaling(m,
a.scale(g,g,2));b.multiply(this.model,g,n);n=f.pan||[0,0];n=b.fromTranslation(k,[n[0],n[1],0]);g=f.zoom?Array.isArray(f.zoom)?f.zoom:[f.zoom,f.zoom]:[1,1];g=b.fromScaling(m,[g[0],g[1],1]);b.multiply(this.view,g,b.multiply(b.create(),n,f.rotMatrix));d.copy(this.viewportDims,h);g=h[1]/h[0];n=b.create();n[0]=Math.min(g,1);n[5]=-Math.min(1/g,1);n[10]=n[15]=f.persp+1;n[11]=n[14]=f.persp;g=b.multiply(m,this.view,this.model);b.multiply(this.mvp,n,g);b.invert(this.mvpInv,this.mvp);var l=b.identity(m);l[0]=
l[12]=h[0]/2;l[5]=-h[1]/2;l[13]=h[1]/2;b.multiply(this.mvpv,l,this.mvp);b.invert(this.mvpvInv,this.mvpv);if(f.renderType==c.RenderType.VR&&f.lightSet.shadowsEnabled())for(h=0;h<f.lightSet.dirLights.length;h++)if(l=f.lightSet.dirLights[h],0<l.shadowDarkness){l=a.cross(a.create(),l.dir,[0,0,1]);var p=Math.asin(Math.min(1,a.length(l)));l=b.fromRotation(k,p,l);l=b.multiply(m,l,f.rotMatrix);b.multiply(g,l,this.model);n[10]=n[15]=1;n[11]=n[14]=0;b.multiply(this.shadowMvp[h],n,g);b.invert(this.shadowMvpInv[h],
this.shadowMvp[h])}};c.Transforms.prototype.txToViewport=function(f){return a.transformMat4(a.create(),f,this.mvpv)};c.Transforms.prototype.viewportToTx=function(f){return a.transformMat4(a.create(),[f[0],f[1],f[2]||0],this.mvpvInv)};c.Transforms.prototype.viewportDeltaToTx=function(f){f=e.transformMat4(e.create(),[f[0],f[1],0,0],this.mvpvInv);return[f[0],f[1],f[2]]}})(window.BigLime=window.BigLime||{});
(function(c,t){c.VolMask=function(d,a,e,b,f){this.context=d;this.width=Math.round(e)||8;this.height=Math.round(b)||8;this.depth=Math.round(f)||16;b=this.context.gl;e=Math.ceil(this.depth/16);this.texture=new c.Texture3D(d,a,this.width,this.height,e,b.RG8,b.RG,b.NEAREST);this.planes16=[];this.planes8=[];for(d=0;d<e;d++)a=new Uint16Array(this.width*this.height),a.fill(65535),this.planes16.push(a),a=new Uint8Array(a.buffer),this.planes8.push(a);this.copyDataToTexture()};c.VolMask.prototype.destroy=function(){this.context&&
(this.texture.destroy(),this.context=this.texture=null)};c.VolMask.prototype.resize=function(d,a,e){if(this.width!=d||this.height!=a||this.depth!=e)for(this.width=Math.round(d),this.height=Math.round(a),this.depth=Math.round(e),d=Math.ceil(this.depth/16),this.texture.resize(this.width,this.height,d),this.planes16=[],this.planes8=[],a=0;a<d;a++)e=new Uint16Array(this.width*this.height),e.fill(65535),this.planes16.push(e),e=new Uint8Array(e.buffer),this.planes8.push(e)};c.VolMask.prototype.getValue=
function(d,a,e,b=!0,f=!0){b&&(d=Math.floor(d),a=Math.floor(a),e=Math.floor(e));return f&&(0>e||e>=this.depth||0>d||d>=this.width||0>a||a>=this.height)?!1:0!=(this.planes16[Math.floor(e/16)][a*this.width+d]&1<<e%16)};c.VolMask.prototype.setValue=function(d,a,e,b,f=!0,g=!0){f&&(d=Math.floor(d),a=Math.floor(a),e=Math.floor(e));g&&(0>a||a>=this.height||0>e||e>=this.depth||0>d||d>=this.width)||(f=this.planes16[Math.floor(e/16)],d+=a*this.width,f[d]=b?f[d]|1<<e%16:f[d]&~(1<<e%16))};c.VolMask.prototype.copyDataToTexture=
function(){const d=this.context.gl,a=this.texture,e=this.planes8.length;a.bind();for(let b=0;b<e;b++)d.texSubImage3D(d.TEXTURE_3D,0,0,0,b,a.width,a.height,1,d.RG,d.UNSIGNED_BYTE,this.planes8[b])}})(window.BigLime=window.BigLime||{});
(function(c,t){c.Volume=function(d,a){this.context=d;this.txIndex=a;this.dims=[8,8,8];this.sliceGap=1;this.bpp=8;this.bigEndian=!1;this.sizeInBytes=0;this.shape=[8,8,8];this.diagSize=Math.sqrt(3);this.aspect=[1,1,1];this.attrs={};this.texture=null;this.interpType=c.Interp3D.TriLinear;this.histogram=new c.Histogram3D(65536);this.loaded=!1;this.autoWinLevel=this.opacityRange=null;this.meshManager=c.MeshManager?new c.MeshManager(this):null;d=this.context.gl;this.texture=new c.Texture3D(this.context,
this.txIndex,8,8,8,d.R8,d.RED,d.LINEAR);this.setInterpType(this.interpType);this.calcNearLphAxes()};c.Volume.prototype.destroy=function(){this.context&&(this.texture&&(this.texture.destroy(),this.texture=null),this.context=this.nearLphAxes=this.attrs=this.dims=null)};c.Volume.prototype.setInterpType=function(d){if(this.interpType!=d){var a=this.context.gl;this.interpType=d;this.texture.setInterpType(d==c.Interp3D.NN?a.NEAREST:a.LINEAR)}};c.Volume.prototype.addMesh=function(d){this.meshManager.addMesh(d)};
c.Volume.prototype.removeMesh=function(d){return this.meshManager.removeMesh(d)};c.Volume.prototype.removeAllMeshes=function(){return this.meshManager.removeAllMeshes()};c.Volume.prototype.containsMesh=function(d){return this.meshManager.contains(d)};c.Volume.prototype.loadBegin=function(d,a,e){this.loaded=!1;this.histogram.clear();this.autoWinLevel=this.opacityRange=null;this.sliceGap=1;this.meshManager?.removeAllMeshes();if(8!=a&&16!=a)return"Unsupported bits-per-pixel.";try{var b=this.context.gl;
if(!this.texture.sizeEquals(...d)||a!=this.bpp){var f=8==a?b.R8:b.RG8,g=8==a?b.RED:b.RG;this.texture.resize(...d,f,g);this.setInterpType(this.interpType)}this.dims=[...d];this.bpp=a;this.bigEndian=e.toLowerCase().startsWith("b");this.sizeInBytes=a/8*d[1]*d[2]*d[0]}catch(h){return"Error configuring volume\n\n"+h.message}};c.Volume.prototype.loadEnd=function(){this.loaded=!0;this.shape=[this.dims[0],this.dims[1],this.dims[2]*this.sliceGap];this.diagSize=glMatrix.vec3.length(this.shape);glMatrix.vec3.scale(this.aspect,
this.shape,1/Math.max(...this.shape))};c.Volume.prototype.setAttr=function(d,a){d=d.toLowerCase();this.attrs[d]=a;"slicegap"==d&&(this.sliceGap=Number(a))};c.Volume.prototype.getAttr=function(d,a){d=this.attrs[d.toLowerCase()];if("undefined"===typeof d||null===d)d=a;return d};c.Volume.prototype.fill=function(d,a=!1){this.texture.fill(d,a)};c.Volume.prototype.modality=function(){return this.getAttr("modality","").toUpperCase()};c.Volume.prototype.getOpacityRange=function(){if(this.opacityRange)return this.opacityRange;
if("CT"==this.modality()){var d=this.getAttr("rescaleSlope",1);var a=(-1024-this.getAttr("rescaleIntercept",0))/d-this.getAttr("dataOffset",0);d=4096/d}else d=this.histogram.getThreshedMinMax(.5),a=d[0],d=Math.max(d[1]-d[0],1E-4);return this.opacityRange=[a,d]};c.Volume.prototype.getAutoWinLevel=function(){if(this.autoWinLevel)return this.autoWinLevel;if(!this.loaded)return[2048,1024];if("CT"==this.modality()){var d=this.getAttr("rescaleSlope",1);var a=(-1024-this.getAttr("rescaleIntercept",0)+640)/
d-this.getAttr("dataOffset",0);d=1024/d}else d=this.histogram.getThreshedMinMax(.5),a=d[0],d=Math.max(d[1]-d[0],1E-4);return this.autoWinLevel=[d,a+d/2]};c.Volume.prototype.calcNearLphAxes=function(){var d=glMatrix.vec3;this.nearLphAxes={};var a=this.getAttr("rowDir"),e=this.getAttr("colDir");if(a&&e){var b=[0,0,0];d.cross(b,a,e);b=[a,e,b];var f=-1,g=0;for(a=0;3>a;a++)e=b[a][0],Math.abs(e)>Math.abs(g)&&(g=e,f=a);this.nearLphAxes.L=[0,0,0];this.nearLphAxes.L[f]=Math.sign(g);this.nearLphAxes.R=[0,0,
0];d.negate(this.nearLphAxes.R,this.nearLphAxes.L);var h=-1;for(a=g=0;3>a;a++)a!=f&&(e=b[a][1],Math.abs(e)>Math.abs(g)&&(g=e,h=a));this.nearLphAxes.P=[0,0,0];this.nearLphAxes.P[h]=Math.sign(g);this.nearLphAxes.A=[0,0,0];d.negate(this.nearLphAxes.A,this.nearLphAxes.P);this.nearLphAxes.H=[0,0,0];d.cross(this.nearLphAxes.H,this.nearLphAxes.L,this.nearLphAxes.P);this.nearLphAxes.F=[0,0,0];d.negate(this.nearLphAxes.F,this.nearLphAxes.H);return this.nearLphAxes}this.nearLphAxes.L=[1,0,0];this.nearLphAxes.R=
[-1,0,0];this.nearLphAxes.P=[0,1,0];this.nearLphAxes.A=[0,-1,0];this.nearLphAxes.H=[0,0,1];this.nearLphAxes.F=[0,0,-1]}})(window.BigLime=window.BigLime||{});
(function(c,t){c.ShaderCode2=c.ShaderCode2||{};c.ShaderCode2.Common=c.ShaderCode2.Common||{};c.ShaderCode2.Common.encodeVec3="\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Encodes the components of a vec3 in an rgba color.\n//\n///////////////////////////////////////////////////////////////////////////////\nvec4 encodeVec3(vec3 loc)\n{\n\tif ( any(lessThan(loc,Zeros)) || any(greaterThan(loc,Ones)) ) \n\t{\n\t\t// We indicate an invalid value by setting the rightmost bit\n\t\treturn vec4(0.0, 0.0, 0.0, 1.0);\n\t}\t\n\n\t// Use 10 bits for each coordinate\n\tint xi = min(1023, int(loc.x*1023.0 + 0.5));\n\tint yi = min(1023, int(loc.y*1023.0 + 0.5));\n\tint zi = min(1023, int(loc.z*1023.0 + 0.5));\n\n\tint zLo = zi - (zi/128) * 128;\n\tint zHi = (zi - zLo)/128;\n\n\tint yLo = yi - (yi/32) * 32;\n\tint yHi = (yi - yLo)/32;\n\n\tint xLo = xi - (xi/8) * 8;\n\tint xHi = (xi - xLo)/8;\n\n\tfloat a = float(zLo*2)/255.0;\n\tfloat b = float(zHi + 8*yLo)/255.0;\n\tfloat g = float(yHi + 32*xLo)/255.0;\n\tfloat r = float(xHi)/255.0;\n\n\treturn vec4(r, g, b, a);\n}\n\t\n";c.ShaderCode2.Common.isMasked=
"\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Determines whether a given volume point is masked.\n//\n///////////////////////////////////////////////////////////////////////////////\nbool isMasked(vec3 pos)\n{\n\tvec4 maskSamp = texture(uVolMaskSampler, vec3(pos.x, pos.y, pos.z*MaskZScale));\n\tint maskVal = int( round(255.0*(maskSamp.r + 256.0*maskSamp.g)) );\n\n\tint zi = int( floor(pos.z * uVolShape[2]) );\n\tint bitIndex = zi - 16*(zi/16);\n\n    return (maskVal & (1 << bitIndex)) == 0;\n}\n\n";
c.ShaderCode2.Common.initializeSlabInfo="\n#ifdef CLIP_TO_SLAB\n///////////////////////////////////////////////////////////////////////////////\n//\n// Initializes slab-related variables.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid initializeSlabInfo(vec3 rayDir, vec3 rayStart, out float slabOffset)\n{\n\t// Get the corner points in volume coordinates\n\tvec3 p0 = vec3(uSlabInfo[0],  uSlabInfo[1],  uSlabInfo[2] );\n\tvec3 p1 = vec3(uSlabInfo[3],  uSlabInfo[4],  uSlabInfo[5] );\n\tvec3 p2 = vec3(uSlabInfo[6],  uSlabInfo[7],  uSlabInfo[8] );\n\tvec3 p3 = vec3(uSlabInfo[9],  uSlabInfo[10], uSlabInfo[11]);\n\tvec3 p4 = vec3(uSlabInfo[12], uSlabInfo[13], uSlabInfo[14]);\n\tvec3 p5 = vec3(uSlabInfo[15], uSlabInfo[16], uSlabInfo[17]);\n\tvec3 p6 = vec3(uSlabInfo[18], uSlabInfo[19], uSlabInfo[20]);\n\tvec3 p7 = vec3(uSlabInfo[21], uSlabInfo[22], uSlabInfo[23]);\n\n\tslabOffset = min( \n\t\tmin( min(dot(rayDir, p0), dot(rayDir, p1)), min(dot(rayDir, p2), dot(rayDir, p3)) ),\n\t\tmin( min(dot(rayDir, p4), dot(rayDir, p5)), min(dot(rayDir, p6), dot(rayDir, p7)) ) \n\t);\n\tslabOffset -= dot(rayStart, rayDir);\n\n\t// Get the slab axes and center\n\tp0 *= VolAspect;\n\tp1 *= VolAspect;\n\tp2 *= VolAspect;\n\tp4 *= VolAspect;\n\tp7 *= VolAspect;\n\tSlabAxes[0] = normalize(p1 - p0);\n\tSlabAxes[1] = normalize(p2 - p0);\n\tSlabAxes[2] = normalize(p4 - p0);\n\tvec3 slabCtr = (p0 + p7) / 2.0;\n\n\tSlabRadii = vec3(length(p1-p0)/2.0, length(p2-p0)/2.0, length(p4-p0)/2.0);\n\n\t// Construct the transformation matrix from texture coordinates to slab coordinates\n\tSlabXfrm = mat4(\n\t\tVolAspect.x*SlabAxes[0].x,  VolAspect.x*SlabAxes[1].x,  VolAspect.x*SlabAxes[2].x,  0.0,\n\t\tVolAspect.y*SlabAxes[0].y,  VolAspect.y*SlabAxes[1].y,  VolAspect.y*SlabAxes[2].y,  0.0,\n\t\tVolAspect.z*SlabAxes[0].z,  VolAspect.z*SlabAxes[1].z,  VolAspect.z*SlabAxes[2].z,  0.0,\n       -dot(slabCtr, SlabAxes[0]), -dot(slabCtr, SlabAxes[1]), -dot(slabCtr, SlabAxes[2]),  1.0\n\t);\n}\n#endif\n"})(window.BigLime=
window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.gfx_vert_2="#version 300 es\n// gfx_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; \nprecision highp int;\n\nin vec4 aPosition;\nin vec3 aNormal;\nin vec4 aColor;\nin vec4 aMaterial;\n\nuniform mat4 uMvpTransform;\nuniform mat4 uRotMatrix;\n\nout vec4 vPosition;\nout vec3 vNormal;\nout vec4 vColor;\nout vec4 vMaterial;\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Transform the input vertex from world-space to clip-space. \n    gl_Position = uMvpTransform * aPosition; \n\n    // Transform the normal as well\n    vNormal = mat3(uRotMatrix) * aNormal; \n\n    // Set varying values\n    vPosition = gl_Position;\n    vMaterial = aMaterial;\n    vColor = aColor;\n}\n";c.ShaderCode.gfx_frag_2=
"#version 300 es\n// gfx_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; \nprecision highp int;\n\n// Uniforms and varyings\nuniform bool  uRenderDepthMap;\nin vec4       vPosition;\nin vec3       vNormal;\nin vec4       vColor;\nin vec4       vMaterial;\nout vec4      outColor;\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    if (uRenderDepthMap) \n    {\n        // Encode the depth in the b and a channels of the output color\n        float depth = 65535.0*clamp((vPosition.z+1.0)/2.0, 0.0, 1.0);\n        float dHigh = floor(depth/256.0);\n        float dLo = (depth - dHigh*256.0);\n        outColor = vec4(0.0, 0.0, dHigh/255.0, dLo/255.0);\n    }\n    else\n    {\n        // Apply lighting to the fragment color\n        float mAmbient      = vMaterial.r * 2.0;\n        float mDiffuse      = vMaterial.g * 2.0;\n        float mSpecStrength = vMaterial.b * 2.0;\n        float mSpecPower    = vMaterial.a * 255.0;\n\n        vec3 lightDir = vec3(0.0, 0.0, 1.0);\n        float cdot = clamp(-dot(normalize(vNormal), lightDir), 0.0, 1.0);\n        float diffuse = mDiffuse*(cdot - 0.6);\n        float specular = (mSpecStrength == 0.0) ? 0.0 : mSpecStrength * pow(cdot,mSpecPower);\n        \n        float light = max(0.0, mAmbient + diffuse + specular );   \n        outColor = vec4(vColor.rgb*light, vColor.a);\n    }\n}\n"})(window.BigLime=
window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.mip_vert_2="#version 300 es\n// mip_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\n\nuniform mat4  uMvpTransform;\nuniform mat4  uMvpInvTransform;\nin vec4       aPosition;\nout vec3      vRayStartT;\nout vec3      vRayDirT;\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Transform the input vertex from world-space to clip-space. \n    gl_Position = uMvpTransform * aPosition;\n\n\t// Pass the ray's starting point and direction vector (in texture coordinates) to the fragment shader.\n\tvRayStartT = aPosition.xyz;\n\tvec4 rayPrevT = uMvpInvTransform * (gl_Position - vec4(0.0, 0.0, 1.0, 0.0));\n\tvRayDirT = vRayStartT - rayPrevT.xyz/rayPrevT.w;\n}\n";c.ShaderCode.mip_frag_2=
"#version 300 es\n// mip_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\nprecision highp sampler3D;\n\n// Uniforms and varyings\nuniform sampler3D  uVolumeSampler;\nuniform sampler3D  uVolMaskSampler;\nuniform bool       uApplyVolMask;\nuniform int    uBitsPerPixel;\nuniform float  uRayStepSize;\nuniform vec3   uVolShape;\nuniform float  uSlabInfo[24];\nuniform bool   uPickMode;\nuniform vec2   uPickPoint;\nuniform bool   uShowMarker;\nuniform vec3   uMarkerLoc;\nuniform float  uMarkerSize;\nin  vec3 vRayStartT;\nin  vec3 vRayDirT;\nout vec4 outColor;\n\n// Constants\nconst float BBoxTol = 0.002; \nconst vec3 BboxMin  = vec3(-BBoxTol);\nconst vec3 BboxMax  = vec3(1.0 + BBoxTol);\nconst vec3 Zeros    = vec3(0.0);\nconst vec3 Ones     = vec3(1.0);\n\n// Globals\nvec2 PixConvert;\nvec3 VolAspect;\nfloat MaskZScale;\n#ifdef CLIP_TO_SLAB\nvec3 SlabRadii, SlabAxes[3];\nmat4 SlabXfrm;\n#endif\n\n// Function prototypes\nbool calcMipValue(vec3);\nbool calcPickLocation(vec3);\nvec4 encodeVec3(vec3);\nbool isMasked(vec3);\n#ifdef CLIP_TO_SLAB\nvoid  initializeSlabInfo(vec3, vec3, out float);\n#endif\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n\t// Initialize globals\n\tPixConvert = vec2(1.0, 256.0*float(uBitsPerPixel > 8));\n\tMaskZScale = uVolShape.z / ( 16.0 * ceil((uVolShape.z - 0.0001)/16.0) );\n\n    // Perform ray casting\n\tvec3 rayDir = normalize(vRayDirT);\t\n\tbool stat = calcPickLocation(rayDir) || calcMipValue(rayDir);\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the maximum intensity along a ray.\n//\n///////////////////////////////////////////////////////////////////////////////\nbool calcMipValue(vec3 rayDir)\n{\n\tVolAspect = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\n\t// Initialize the ray\n\tvec3 pos = vRayStartT;\n\tvec3 rayStep = rayDir*uRayStepSize;\n\tfloat rayToMarkerDist = 10.0;\n\n\t// Initialize slab variables\n\t#ifdef CLIP_TO_SLAB\n\tbool enteredSlab = false;\n\tfloat slabOffset;\n\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t#endif\t\n\n\t// Walk along the ray\n\tfloat maxPixVal = 0.0;\n\tint NumSteps = int(sqrt(3.0)/uRayStepSize + 0.5);\n\tfor (int i = 0; i < NumSteps; i++)\n\t{\t\t\n\t\t// Check whether the ray has exited the volume\n\t\tif ( any(lessThan(pos,BboxMin)) || any(greaterThan(pos,BboxMax)) ) { break; }\t\t\n\n\t\t// Honor any slab constraints\n\t\t#ifdef CLIP_TO_SLAB\n\t\tvec3 pos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\tif ( enteredSlab ) { break; }\n\t\t\tpos += rayStep;\n\t\t\tcontinue;\n\t\t}\n\t\tenteredSlab = true;\n\t\t#endif\n\t\t\n\t\t// Get the current pixel value and compare it with the maximum\n\t\tif (!uApplyVolMask || !isMasked(pos)) { \n\t\t\tvec4 samp = texture(uVolumeSampler, pos);\n\t\t\tfloat pixVal = dot(samp.rg, PixConvert);\t\t\t\n\t\t\tmaxPixVal = max( maxPixVal, pixVal );\n\t\t}\t\n\t\t\t\n\t\t// Check whether to display a marker\n\t\trayToMarkerDist = min(rayToMarkerDist, length((pos-uMarkerLoc)*VolAspect));\t\n\n\t\tpos += rayStep;\n\t}\n\n\t// Encode the 16-bit pixel value in two 8-bit color channels\t\n\tmaxPixVal *= 255.0;\n\tmaxPixVal = max(maxPixVal, 1.0); // Don't allow zero, as we use zero to indicate background\n\tfloat highByte = floor(maxPixVal/256.0);\n\tfloat lowByte = maxPixVal - 256.0*highByte;\n\tfloat b = float(uShowMarker) * max(0.0, 1.0-rayToMarkerDist/uMarkerSize);\n\toutColor = vec4(lowByte/255.0, highByte/255.0, b, 1.0);\n\treturn true;\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the location of the maximum intensity point along a ray.\n//\n///////////////////////////////////////////////////////////////////////////////\nbool calcPickLocation(vec3 rayDir)\n{\n    if (!uPickMode) { return false; }\n\n\tfloat tol = 1.0; // NB: Units here are pixels, not fractional texture coordinates\n\tif ( (abs(gl_FragCoord.x - uPickPoint.x) > tol) ||  (abs(gl_FragCoord.y - uPickPoint.y) > tol) ) \n\t{\n\t\t// Skip the computation if this is not the target fragment\n\t\toutColor = vec4(0.0, 0.0, 0.0, 0.0);\n\t}\n\telse\n\t{\t\n\t\tVolAspect = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\n\t\t// Initialize the ray\n\t\tvec3 pos = vRayStartT;\n\t\tvec3 rayStep = rayDir*uRayStepSize;\n\n\t\t// Initialize slab variables\n\t\t#ifdef CLIP_TO_SLAB\n\t\tbool enteredSlab = false;\n\t\tfloat slabOffset;\n\t\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\t\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t\t#endif\t\n\n\t\t// Initialize max info\n\t\tfloat maxPixVal = 0.0;\n\t\tvec3 maxLoc = vec3(-1.0);\n\n\t\t// Walk along the ray\n\t\tint NumSteps = int(sqrt(3.0)/uRayStepSize + 0.5);\n\t\tfor (int i = 0; i < NumSteps; i++)\n\t\t{\t\t\n\t\t\t// Check whether the ray has exited the volume\n\t\t\tif ( any(lessThan(pos,BboxMin)) || any(greaterThan(pos,BboxMax)) ) { break; }\t\t\n\n\t\t\t// Honor any slab constraints\n\t\t\t#ifdef CLIP_TO_SLAB\n\t\t\tvec3 pos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\t\tif ( enteredSlab ) { break; }\n\t\t\t\tpos += rayStep;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tenteredSlab = true;\n\t\t\t#endif\n\t\t\t\n\t\t\t// Get the current pixel value and compare it with the maximum\n\t\t\tif (!uApplyVolMask || !isMasked(pos)) { \n\t\t\t\tvec4 samp = texture(uVolumeSampler, pos);\n\t\t\t\tfloat pixVal = dot(samp.rg, PixConvert);\t\t\t\n\t\t\t\tif (pixVal > maxPixVal) {\n\t\t\t\t\tmaxPixVal = pixVal;\n\t\t\t\t\tmaxLoc = pos;\t\n\t\t\t\t}\n\t\t\t}\t\n\t\t\tpos += rayStep;\n\t\t}\n\n\t\t// Encode the max location in the output color\t\n\t\toutColor = encodeVec3(maxLoc);\n\t}\n\treturn true;\n}\n"+
c.ShaderCode2.Common.initializeSlabInfo+c.ShaderCode2.Common.isMasked+c.ShaderCode2.Common.encodeVec3})(window.BigLime=window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.shadows_vert_2="#version 300 es\n// shadows_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\n\nuniform mat4 uShadowMvpTransform;\nuniform mat4 uShadowMvpInvTransform;\nin vec4      aPosition;\nout vec3     vRayStartT;\nout vec3     vRayDirT;\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Transform the input vertex from world-space to clip-space\n    gl_Position = uShadowMvpTransform * aPosition; \n\n\t// Pass the ray's starting point and direction vector (in texture coordinates) to the fragment shader.\n\tvRayStartT = aPosition.xyz;\n\tvec4 rayPrevT = uShadowMvpInvTransform * (gl_Position - vec4(0.0, 0.0, 1.0, 0.0));\n\tvRayDirT = vRayStartT - rayPrevT.xyz/rayPrevT.w;\n}\n";c.ShaderCode.shadows_frag_2=
"#version 300 es\n// shadows_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\nprecision highp sampler3D;\n\n// Uniforms and varyings\nuniform sampler3D  uVolumeSampler;\nuniform sampler3D  uAuxVolumeSampler;\nuniform sampler3D  uVolMaskSampler;\nuniform sampler2D  uLutSampler;\nuniform bool       uUseAuxVol;\nuniform bool       uApplyVolMask;\nuniform vec3       uVolShape;\nuniform int        uBitsPerPixel;\nuniform float      uRayStepSize;\nuniform float      uOpacityRange[2];\nuniform float      uSlabInfo[24];\nuniform mat4       uShadowMvpTransform;\nuniform vec4       uAuxVolColorMap[24];\n\nin  vec3 vRayStartT;\nin  vec3 vRayDirT;\nout vec4 outColor;\n\n// Constants\nconst vec3 Ones             = vec3(1.0);\nconst vec3 Zeros            = vec3(0.0);\nconst float BBoxTol         = 0.002; \nconst vec3 BboxMin          = vec3(-BBoxTol);\nconst vec3 BboxMax          = vec3(1.0+BBoxTol);\nconst float TransparencySat = 0.02; // Saturation value\n\n// Globals\nvec3 VolAspect;\nvec2 PixConvert;\nfloat PixScale, PixOffset;\nfloat MaskZScale;\n#ifdef CLIP_TO_SLAB\nvec3 SlabRadii, SlabAxes[3];\nmat4 SlabXfrm;\n#endif\n\n// Function prototypes\nvec4 renderShadowMap(vec3);\nfloat getNormalizedPixVal(vec3);\nvec4 encodeFloat(float);\nbool isMasked(vec3);\n#ifdef CLIP_TO_SLAB\nvoid  initializeSlabInfo(vec3, vec3, out float);\n#endif\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n\t// Initialize globals\n\tPixConvert = vec2(1.0, 256.0*float(uBitsPerPixel > 8));\n\tPixScale   = 255.0 * uOpacityRange[1];\n\tPixOffset  = uOpacityRange[0] * uOpacityRange[1];\n\tMaskZScale = uVolShape.z / ( 16.0 * ceil((uVolShape.z - 0.0001)/16.0) );\n\n\t// Compute the shadow map\n    outColor = renderShadowMap( normalize(vRayDirT) );\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the shadow map.\n//\n///////////////////////////////////////////////////////////////////////////////\nvec4 renderShadowMap(vec3 rayDir)\n{\n\tVolAspect = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\n\t// Initialize locals\n\tfloat stepSize   = uRayStepSize;\n\tvec3  rayStep    = stepSize * rayDir;\n\tfloat opacityExp = stepSize * 128.0;\n\tfloat bestDelta  = -1.0; \n\tfloat bestDepth  =  1.0;\n\tvec4 shadowMvp   = vec4(uShadowMvpTransform[0][2], uShadowMvpTransform[1][2], uShadowMvpTransform[2][2], uShadowMvpTransform[3][2]);\n\n\t// Initialize the ray\n\tvec3 pos        = vRayStartT;\n\tfloat tTot      = 1.0;\n\tfloat tBase     = 1.0;\n\tbool climbing   = false;\n\t\n\t// Initialize slab variables\n\t#ifdef CLIP_TO_SLAB\n\tbool enteredSlab = false;\n\tfloat slabOffset;\n\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t#endif\n\n\t// Walk along the ray, looking for the largest jump in opacity\n\tint NumSteps = int(4.0/uRayStepSize); // We'll break out of the loop before hitting NumSteps\n\tfor (int i = 0; i < NumSteps; i++)\n\t{\t\t\n\t\t// Honor any slab constraints\n\t\t#ifdef CLIP_TO_SLAB\n\t\tvec3 pos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\tif ( enteredSlab ) { break; }\n\t\t\tstepSize = 2.0*uRayStepSize;\n\t\t\trayStep = stepSize*rayDir;\t\t\t\n\t\t\tpos += rayStep; \n\t\t\tcontinue;\n\t\t}\n\t\tenteredSlab = true;\n\t\t#endif\n\n\t\t// Maybe check the mask\n\t\tif (uApplyVolMask && isMasked(pos)) { \n\t\t\tpos += rayStep; \n\t\t\tcontinue; \n\t\t}\n\n\t\t// Get the current voxel's opacity \n\t\tfloat opac;\n\t\tif (uUseAuxVol) {\n\t\t\tint auxPixVal = int( round(255.0*texture(uAuxVolumeSampler, pos).r) );\n\t\t\tvec4 auxVolColor = uAuxVolColorMap[auxPixVal];\n\t\t\tif (auxVolColor.a == 0.0) { \n\t\t\t\tpos += rayStep; \n\t\t\t\tcontinue; \n\t\t\t}\n\t\t\topac = (auxVolColor.a > 0.0) ? auxVolColor.a : texture( uLutSampler, vec2(getNormalizedPixVal(pos), LUT_TX_YOFFSET)).a;\t\n\t\t}\n\t\telse {\n\t\t\topac = texture( uLutSampler, vec2(getNormalizedPixVal(pos), LUT_TX_YOFFSET)).a;\n\t\t}\n\n\t\tif (opac == 0.0)\n\t\t{\n\t\t\t// We have entered an empty-space region, so increase the stepsize\n\t\t\tstepSize = 2.0*uRayStepSize;\n\t\t\trayStep = stepSize*rayDir;\n\t\t}\n\t\telse if (stepSize > 1.5*uRayStepSize) \n\t\t{\n\t\t\t// Revert to normal-size steps, and back-up a bit\n\t\t\tstepSize = uRayStepSize;\n\t\t\trayStep = stepSize*rayDir;\n\t\t\tpos -= rayStep;\n\t\t\topac = texture( uLutSampler, vec2(getNormalizedPixVal(pos), LUT_TX_YOFFSET)).a;\n\t\t}\n\n\t\t// Update the accumulated transparency\n\t\tfloat t = pow(max(0.0, 1.0-opac), opacityExp);\n\t\ttBase = mix(tBase, tTot, float(!climbing));\n\t\ttTot *= t;\n\t\tclimbing = climbing || (t < 0.99);\n\n\t\t// Check whether we are ending a climb, or maybe even the whole ray\n\t\tvec3 nextPos = pos + rayStep;\n\t\tbool terminateRay = (tTot < TransparencySat) || any(lessThan(nextPos, BboxMin)) || any(greaterThan(nextPos, BboxMax));\n\t\tif ( climbing && ((t >= 0.99) || terminateRay) ) // We are ending a climb\n\t\t{\n\t\t\tclimbing = false;\n\t\t\tfloat delta = tBase - tTot; \n\t\t\tfloat improved = float(delta > bestDelta);\n\t\t\tbestDelta = mix(bestDelta, delta, improved);\n\t\t\tbestDepth = mix(bestDepth, dot(shadowMvp, vec4(pos, 1.0)), improved);\n\t\t\tterminateRay = terminateRay || (bestDelta >= tTot);  \t\t\t\t\n\t\t}\n\t\tif (terminateRay) { break; }\n\n\t\tpos = nextPos;\n\t}\n\t\n\t// Return the best depth estimate\n\tfloat d = (bestDepth + 1.0)/2.0; // Ranges between 0.0 and 1.0\n\treturn encodeFloat(d);\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Gets the pixel value at a given volume point, normalized to the\n//   range [0,1].\n//\n///////////////////////////////////////////////////////////////////////////////\nfloat getNormalizedPixVal(vec3 pos)\n{\t\n\t// Sample the volume\n\tvec4 samp = texture(uVolumeSampler, pos);\n\n\t// Combine color channels to decode the pixel value\n\tbool inBounds = all(lessThanEqual(pos,Ones)) && all(greaterThanEqual(pos,Zeros));\n\tfloat pixVal = dot(samp.rg, PixConvert) * float(inBounds);\t\n\n\t// Normalize\n\treturn clamp(pixVal*PixScale - PixOffset, 0.0, 1.0);\t\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Encodes a float value in the first two components of a vec4.\n//\n///////////////////////////////////////////////////////////////////////////////\nvec4 encodeFloat(float val)\n{\n\tfloat cVal = 65535.0 * clamp(val, 0.0, 1.0);\n\tfloat dHi = floor(cVal/256.0);\n\tfloat dLo = cVal - dHi*256.0;\n\treturn vec4(dHi/255.0, dLo/255.0, 0.0, 1.0);\n}\n\t\n"+
c.ShaderCode2.Common.initializeSlabInfo+c.ShaderCode2.Common.isMasked})(window.BigLime=window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.slab_vert_2="#version 300 es\n// slab_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float;\nprecision highp int;\n\nin vec4       aPosition;\nin vec4       aColor;\nout vec4      vColor;\nuniform mat4  uMvpTransform;\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    gl_Position = uMvpTransform * aPosition;\n    vColor = aColor;\n}\n";c.ShaderCode.slab_frag_2=
"#version 300 es\n// slab_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; \nprecision highp int;\nin vec4 vColor;\nout vec4 outColor;\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    outColor = vColor;\n}\n"})(window.BigLime=window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.vr_vert_2="#version 300 es\n// vr_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\n\nin vec4       aPosition;\nuniform mat4  uMvpTransform;\nuniform mat4  uMvpInvTransform;\nout vec3      vRayStartT;\nout vec3      vRayDirT;\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Transform the input vertex from world-space to clip-space. \n    gl_Position = uMvpTransform * aPosition;\n\n\t// Pass the ray's starting point and direction vector (in texture coordinates) to the fragment shader.\n\tvRayStartT = aPosition.xyz;\n\tvec4 rayPrevT = uMvpInvTransform * (gl_Position - vec4(0.0, 0.0, 1.0, 0.0));\n\tvRayDirT = vRayStartT - rayPrevT.xyz/rayPrevT.w;\n}\n";c.ShaderCode.vr_frag_2=
"#version 300 es\n// vr_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\nprecision highp sampler3D;\n\n// Uniforms and varyings\nuniform sampler3D  uVolumeSampler;\nuniform sampler3D  uAuxVolumeSampler;\nuniform sampler3D  uVolMaskSampler;\nuniform sampler2D  uLutSampler;\nuniform bool   uUseAuxVol;\nuniform bool   uApplyVolMask;\nuniform vec3   uVrBackColor;\nuniform vec3   uVolShape;\nuniform int    uBitsPerPixel;\nuniform float  uRayStepSize;\nuniform vec2   uOutVpSize;\nuniform float  uOpacityRange[2];\nuniform int    uAntiAlias;\nuniform float  uMaxSkip;\nuniform float  uSlabInfo[24];\nuniform bool   uSealBorders;\nuniform bool   uPickMode;\nuniform vec2   uPickPoint;\nuniform bool   uShowMarker;\nuniform vec3   uMarkerLoc;\nuniform float  uMarkerSize;\nuniform vec4   uMarkerColor;\nuniform mat4   uModelTransform;\nuniform mat4   uViewTransform;\nuniform float  uAmbientLight;\nstruct Light {\n\tfloat diffuse;\n\tfloat specStrength;\n\tfloat specExp;\n\tfloat shadowDarkness;\n\tfloat shadowSoftness;\n\tvec3  dir;\n\tmat4  shadowMvp;\n};\nuniform Light uLights[2];\nuniform vec4 uAuxVolColorMap[24];\n\n#ifdef RENDER_GRAPHICS\nuniform sampler2D uGfxSampler;\nuniform float uGfxBlendWeight;\n#endif\n#ifdef RENDER_SHADOWS\nuniform sampler2D uShadowSampler;\nuniform vec2 uShadowTxScale;\n#endif\n\nin  vec3 vRayStartT;\nin  vec3 vRayDirT;\nout vec4 outColor;\n\n \n// Constants\nconst vec3 UnitVectors[3]   = vec3[3]( vec3(1.0, 0.0, 0.0), vec3(0.0, 1.0, 0.0), vec3(0.0, 0.0, 1.0) );\nconst vec3 Ones             = vec3(1.0);\nconst vec3 Zeros            = vec3(0.0);\nconst float BBoxTol         = 0.002; \nconst vec3 BboxMin          = vec3(-BBoxTol);\nconst vec3 BboxMax          = vec3(1.0 + BBoxTol);\nconst float TransparencySat = 0.02; // Saturation value\nconst vec2 ToFloat16        = vec2(256.0, 1.0)/257.0; // For converting a pair of bytes to a float \n\n\n// Globals\nvec3 VolAspect, BorderNormal, GradOffset;\nfloat BorderNormalWeight, BorderReflectanceWt;\nvec2 PixConvert;\nfloat PixScale, PixOffset;\nfloat MaskZScale;\n#ifdef CLIP_TO_SLAB\nvec3 SlabRadii, SlabAxes[3];\nmat4 SlabXfrm;\n#endif\n\n\n// Function prototypes\nbool  calcVrValue(vec3);\nbool  calcPickLocation(vec3);\nfloat getNormalizedPixVal(vec3);\nvoid  getBorderInfo(vec3, vec3, vec3, float, vec3);\nfloat rand(vec2);\nvec4  encodeVec3(vec3);\nbool isMasked(vec3);\n\n#ifdef CLIP_TO_SLAB\nvoid  initializeSlabInfo(vec3, vec3, out float);\n#endif\n#ifdef RENDER_SHADOWS\nfloat calcShadowWeight(vec3, int);\n#endif\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n\t// Initialize globals\n\tPixConvert = vec2(1.0, 256.0*float(uBitsPerPixel > 8));\n\tPixScale   = 255.0 * uOpacityRange[1];\n\tPixOffset  = uOpacityRange[0] * uOpacityRange[1];\n\tMaskZScale = uVolShape.z / ( 16.0 * ceil((uVolShape.z - 0.0001)/16.0) );\n\n\t// Perform ray casting\n\tvec3 rayDir = normalize(vRayDirT);\n    bool stat = calcPickLocation(rayDir) || calcVrValue(rayDir);\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the integrated color and opacity along a ray.\n//\n///////////////////////////////////////////////////////////////////////////////\nbool calcVrValue(vec3 rayDir)\n{\n\t// Initializations\n\tVolAspect           = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\tvec3 gdx            = vec3(1.0/uVolShape[0], 0.0, 0.0);      // Offset for computing grad.x\n\tvec3 gdy            = vec3(0.0, 1.0/uVolShape[1], 0.0);      // Offset for computing grad.y\n\tvec3 gdz            = vec3(0.0, 0.0, 1.0/uVolShape[2]);      // Offset for computing grad.z\n\tvec3 gradDelta      = 1.5 * vec3(gdx.x, gdy.y, gdz.z);       // Offsets for computing gradients near borders\n\tfloat stepSize      = uRayStepSize;                          // The step-size for raycasting\n\tvec3 rayStep        = uRayStepSize * rayDir;                 // The ray increment\n\tfloat opacityExp    = uRayStepSize * 128.0;                  // For scaling the opacity to the ray step size\n\tfloat borderThresh  = uRayStepSize * 5.0;                    // Distance threshold for shading border surfaces \n\tfloat random        = rand(gl_FragCoord.xy);                 // For antialiasing\n\tint randIndex       = int(10.0*random + 1.0);\n\tfloat randRayOffset = float(uAntiAlias) * uRayStepSize * (random - 0.5); \n\n\t// Default border values\n\tBorderNormal = vec3(1.0, 0.0, 0.0);\n\tBorderNormalWeight = 0.0;\n\tBorderReflectanceWt = 1.0;\n\tGradOffset = vec3(0.0);\n\n\t// Initialize the ray\n\tfloat tTot            = 1.0;                                 // Accumulated transparency\n\tvec3 cTot             = vec3(0.0);                           // Accumulated color\n\tvec3 pos              = vRayStartT;                          // Current ray position\n\tvec3 pos_s            = vec3(0.0);                           // Current ray position in slab coordinates\n\tfloat currPixVal      = getNormalizedPixVal(pos);\n\tfloat prevPixVal      = 0.0;\n\tfloat nextPixVal      = 0.0;\n\tvec3 prevGrad         = vec3(0.0);\t\n\tfloat perpMarkerDist  = length( cross( (pos-uMarkerLoc)*VolAspect, normalize(rayDir*VolAspect) ) );\n\tbool omitMarkerTest   = !uShowMarker || (perpMarkerDist > uMarkerSize);\n\t\n\t#ifdef RENDER_GRAPHICS\n\tvec2 fragCoord = 0.5*gl_FragCoord.xy/uOutVpSize;\n\tvec4 gfxColor0 = texture(uGfxSampler, vec2(fragCoord.x,       fragCoord.y      ));\n\tvec4 gfxDepth0 = texture(uGfxSampler, vec2(fragCoord.x + 0.5, fragCoord.y      ));\n\tvec4 gfxColor1 = texture(uGfxSampler, vec2(fragCoord.x,       fragCoord.y + 0.5));\n\tvec4 gfxDepth1 = texture(uGfxSampler, vec2(fragCoord.x + 0.5, fragCoord.y + 0.5));\n\tfloat depth0 = 2.0* dot(gfxDepth0.ba, ToFloat16) - 1.0;\n\tfloat depth1 = 2.0* dot(gfxDepth1.ba, ToFloat16) - 1.0;\n\tbool omitG0Test = (depth0 > 0.999);\n\tbool omitG1Test = (depth1 > 0.999);\n\tmat4 mvTransform = uViewTransform * uModelTransform;\n\tvec4 mvTransformZ = vec4(mvTransform[0][2], mvTransform[1][2], mvTransform[2][2], mvTransform[3][2]);\n\t#endif\n\n\tfloat prevShadowWeight0 = -1.0;\n\tfloat prevShadowWeight1 = -1.0;\n\tfloat sh0 = uLights[0].shadowDarkness;\n\tfloat sh1 = uLights[1].shadowDarkness;\n\tfloat drel0 = (uLights[0].diffuse == uLights[1].diffuse) ? 0.5 : uLights[0].diffuse/(uLights[0].diffuse + uLights[1].diffuse + 0.0001);\n\tfloat drel1 = 1.0 - drel0;\n\n\t// Initialize slab variables\n\t#ifdef CLIP_TO_SLAB\n\tbool enteredSlab = false;\n\tfloat slabOffset;\n\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t#endif\n\n\t// Walk along the ray\n\tint NumSteps = int(4.0/uRayStepSize); // We'll break out of the loop before hitting NumSteps\n\tfor (int i = 0; i < NumSteps; i++)\n\t{\t\t\n\t\t// We're done if the ray has exited the volume, or if the opacity threshold is exceeded\n\t\tif ( (tTot < TransparencySat) || any(lessThan(pos,BboxMin)) || any(greaterThan(pos,BboxMax)) ) { break; }\n\n\t\t// Does the current ray position intersect the marker?\n\t\tif (!omitMarkerTest)\n\t\t{\t\n\t\t\tvec3 pmVec = (pos - uMarkerLoc)*VolAspect;\t\n\t\t\tif ( length(pmVec) <= uMarkerSize ) {\n\t\t\t\tfloat pmPerpDist = length( cross(pmVec, normalize(rayDir*VolAspect)) );\n\t\t\t\tfloat shade = mix(1.0 - pmPerpDist/uMarkerSize, 1.0, 0.4);\n\t\t\t\tcTot += shade * uMarkerColor.rgb * uMarkerColor.a * tTot;\n\t\t\t\ttTot *= 1.0 - uMarkerColor.a;\n\t\t\t\tomitMarkerTest = true;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\t\t\t\t\n\t\t// Apply random ray offset for antialiasing\n\t\tpos += (float(i == randIndex) * randRayOffset) * rayDir;\n\n\t\t#ifdef RENDER_GRAPHICS\t\t\n\t\tif ( !omitG0Test || !omitG1Test )\n\t\t{\t\n\t\t\tfloat gPosZ = dot(mvTransformZ, vec4(pos, 1.0));\n\t\t\tif ((!omitG1Test) && (gPosZ > depth1)) {\n\t\t\t\tcTot += gfxColor1.rgb * gfxColor1.a * tTot;\n\t\t\t\tcTot = mix(cTot, gfxColor1.rgb, uGfxBlendWeight);\n\t\t\t\ttTot *= 1.0 - gfxColor1.a;\n\t\t\t\tomitG1Test = true;\n\t\t\t\tcontinue;\t\t\t\n\t\t\t}\n\t\t\tif ((!omitG0Test) && (gPosZ > depth0)) {\n\t\t\t\tcTot += gfxColor0.rgb * gfxColor0.a * tTot;\n\t\t\t\tcTot = mix(cTot, gfxColor0.rgb, uGfxBlendWeight);\n\t\t\t\ttTot *= 1.0 - gfxColor0.a;\n\t\t\t\tomitG0Test = true;\n\t\t\t\tcontinue;\t\t\t\n\t\t\t}\n\t\t}\n\t\t#endif\t\t\n\n\t\t// Honor any slab constraints\n\t\t#ifdef CLIP_TO_SLAB\n\t\tpos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\tif ( enteredSlab ) { break; }\n\t\t\tprevPixVal = 0.0;  currPixVal = 0.0;\n\t\t\tstepSize = uMaxSkip*uRayStepSize;\n\t\t\trayStep = stepSize*rayDir;\t\t\t\n\t\t\tpos += rayStep;  \n\t\t\tcontinue;\n\t\t}\n\t\tenteredSlab = true;\n\t\t#endif\n\n\t\t// Get the pixel value. Use 3-point averaging along the ray\n\t\tnextPixVal = getNormalizedPixVal(pos + rayStep);\n\t\tfloat pixVal = 0.25*( prevPixVal + 2.0*currPixVal + nextPixVal );\n\t\tprevPixVal = currPixVal;  currPixVal = nextPixVal;\n\n\t\tvec4 lutVal;\n\t\tvec4 auxVolColor = vec4(0.0);\n\t\tif (uApplyVolMask && isMasked(pos)) {\n\t\t\tlutVal = vec4(0.0); // The voxel is masked\n\t\t} else {\n\t\t\t// Maybe apply the aux volume\n\t\t\tif (uUseAuxVol) {\n\t\t\t\tint auxPixVal = int( round(255.0*texture(uAuxVolumeSampler, pos).r) );\n\t\t\t\tauxVolColor = uAuxVolColorMap[auxPixVal];\n\t\t\t\tlutVal = (auxVolColor.a >= 0.0) ? auxVolColor : texture(uLutSampler, vec2(pixVal, LUT_TX_YOFFSET));\n\t\t\t} else {\n\t\t\t\tlutVal = texture(uLutSampler, vec2(pixVal, LUT_TX_YOFFSET));\n\t\t\t}\n\t\t}\n\n\t\tif (lutVal.a == 0.0)\n\t\t{\n\t\t\t// We have entered an empty-space region, so increase the stepsize\n\t\t\tstepSize = uMaxSkip*uRayStepSize;\n\t\t\trayStep = stepSize*rayDir;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tif (stepSize > uRayStepSize) {\n\t\t\t\t// Revert to normal-size steps, and back-up\n\t\t\t\tstepSize    = uRayStepSize;\n\t\t\t\trayStep     = stepSize*rayDir;\n\t\t\t\tpos        -= (uMaxSkip - 1.0)*rayStep;\n\t\t\t\t#ifdef CLIP_TO_SLAB\n\t\t\t\tenteredSlab = !any(greaterThan(abs((SlabXfrm * vec4(pos, 1.0)).xyz), SlabRadii));\n\t\t\t\t#endif\n\t\t\t\tcurrPixVal  = getNormalizedPixVal(pos);\n\t\t\t\tprevPixVal  = getNormalizedPixVal(pos - rayStep);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Check whether we are near a border\n\t\t\tif (uSealBorders) {\n\t\t\t\tgetBorderInfo(pos, rayDir, pos_s, borderThresh, gradDelta);\n\t\t\t}\n\n\t\t\t// Compute the intensity gradient\n\t\t\tvec3 gpos = pos + GradOffset;\n\t\t\tvec3 grad = (uUseAuxVol && (auxVolColor.a >= 0.0)) ? vec3(0.0) : vec3( \n\t\t\t\tgetNormalizedPixVal(gpos + gdx) - getNormalizedPixVal(gpos - gdx),\n\t\t\t\tgetNormalizedPixVal(gpos + gdy) - getNormalizedPixVal(gpos - gdy),\n\t\t\t\tgetNormalizedPixVal(gpos + gdz) - getNormalizedPixVal(gpos - gdz) );\t\n\n\t\t\t// Modify the gradient near borders\n\t\t\tgrad = mix(grad, BorderNormal, BorderNormalWeight);\n\t\t\tgrad = mix(grad, prevGrad, 0.5);\n\t\t\tprevGrad = grad;\n\t\t\tfloat gradMag = length(grad);\n\n\t\t\t// Compute the lighting factors\n\t\t\tvec3 N = gradMag > 0.0 ? grad/gradMag : grad;\n\t\t\tvec3 L0 = uLights[0].dir;\n\t\t\tvec3 L1 = uLights[1].dir;\n\t\t\tvec3 R0 = reflect(-1.0*L0, N); // Assumes that L0, L1 are normalized\n\t\t\tvec3 R1 = reflect(-1.0*L1, N);\n\n\t\t\tfloat diffuse0 = 2.0 * uLights[0].diffuse * max(0.0, dot(N,L0));\n\t\t\tfloat diffuse1 = 2.0 * uLights[1].diffuse * max(0.0, dot(N,L1));\n\n\t\t\tfloat sdot0 = max(0.0, dot(R0, rayDir));\n\t\t\tfloat sdot1 = max(0.0, dot(R1, rayDir));\n\t\t\tfloat specular0 = 2.0 * uLights[0].specStrength * pow(sdot0, uLights[0].specExp);\n\t\t\tfloat specular1 = 2.0 * uLights[1].specStrength * pow(sdot1, uLights[1].specExp);\n\n\t\t\tfloat dsFactor = float(gradMag > 0.001)*BorderReflectanceWt;\n\t\t\tfloat light0 = uAmbientLight*drel0 + (diffuse0 + specular0)*dsFactor; \n\t\t\tfloat light1 = uAmbientLight*drel1 + (diffuse1 + specular1)*dsFactor; \n\n\t\t\t// Maybe draw shadows\n\t\t\t#ifdef RENDER_SHADOWS\n\t\t\tif (sh0 > 0.0) { \n\t\t\t\tfloat shadowWeight0 = ((prevShadowWeight0 < 0.0) || (tTot > 0.10)) ? calcShadowWeight(pos,0) : prevShadowWeight0;\n\t\t\t\tlight0 *= max(0.0, 1.0-sh0*shadowWeight0);\n\t\t\t\tprevShadowWeight0 = shadowWeight0;\n\t\t\t}\n\t\t\tif (sh1 > 0.0) {\n\t\t\t\tfloat shadowWeight1 = ((prevShadowWeight1 < 0.0) || (tTot > 0.10)) ? calcShadowWeight(pos,1) : prevShadowWeight1;\n\t\t\t\tlight1 *= max(0.0, 1.0-sh1*shadowWeight1); \n\t\t\t\tprevShadowWeight1 = shadowWeight1;\n\t\t\t}\n\t\t\t#endif // RENDER_SHADOWS\n\n\t\t\t// Update the total color\n\t\t\tfloat light = light0 + light1;\n\n\t\t\tfloat t = pow(max(0.0, 1.0-lutVal.a), opacityExp);\n\t\t\tvec3 c = lutVal.rgb * (1.0 - t) * light;\n\t\t\tcTot += c*tTot;\n\t\t\ttTot *= t;\n\t\t}\n\t\t\t\n\t\tpos += rayStep;\n\t}\n\t\n\tcTot += uVrBackColor*tTot;\n\toutColor = vec4(cTot, 1.0);\n\treturn true;\n}\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the location of the most salient point along a ray.\n//\n///////////////////////////////////////////////////////////////////////////////\nbool calcPickLocation(vec3 rayDir)\n{\n    if (!uPickMode) { return false; }\n\n\tfloat tol = 1.0; // NB: Units here are pixels, not fractional texture coordinates\n\tif ( (abs(gl_FragCoord.x - uPickPoint.x) > tol) ||  (abs(gl_FragCoord.y - uPickPoint.y) > tol) ) \n\t{\n\t\t// Skip the computation if this is not the target fragment\n\t\toutColor = vec4(0.0, 0.0, 0.0, 0.0);\n\t}\n\telse\n\t{\n\t\t// Initializations\n\t\tVolAspect            = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\t\tvec3 rayStep         = uRayStepSize * rayDir;\n\t\tfloat opacityExp     = uRayStepSize * 128.0;\n\t\tvec3 maxLoc          = vec3(-1.0);\n\t\tvec3 runStart        = vec3(-1.0);\n\t\tfloat bestDelta      = -1.0; \n\n\t\t// Initialize the ray\n\t\tvec3 pos = vRayStartT;\n\t\tfloat tTot = 1.0;\n\t\tfloat tBase = -1.0;\n\t\t\n\t\t// Initialize slab variables\n\t\t#ifdef CLIP_TO_SLAB\n\t\tfloat slabOffset;\n\t\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\t\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t\t#endif\n\n\t\t// Walk along the ray\n\t\tint NumSteps = int(4.0/uRayStepSize); // We'll break out of the loop before hitting NumSteps\n\t\tfor (int i = 0; i < NumSteps; i++)\n\t\t{\t\t\n\t\t\t// Honor any slab constraints\n\t\t\t#ifdef CLIP_TO_SLAB\n\t\t\tvec3 pos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\t\tpos += rayStep;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t#endif\n\n\t\t\tvec4 lutVal;\n\t\t\tif (uApplyVolMask && isMasked(pos)) {\n\t\t\t\tlutVal = vec4(0.0); // The voxel is masked\n\t\t\t} else {\n\t\t\t\t// Maybe apply the aux volume\n\t\t\t\tif (uUseAuxVol) {\n\t\t\t\t\tint auxPixVal = int( round(255.0*texture(uAuxVolumeSampler, pos).r) );\n\t\t\t\t\tvec4 auxVolColor = uAuxVolColorMap[auxPixVal];\n\t\t\t\t\tlutVal = (auxVolColor.a >= 0.0) ? auxVolColor : texture(uLutSampler, vec2(getNormalizedPixVal(pos), LUT_TX_YOFFSET));\n\t\t\t\t} else {\n\t\t\t\t\tlutVal = texture(uLutSampler, vec2(getNormalizedPixVal(pos), LUT_TX_YOFFSET));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update the accumulated transparency\n\t\t\tfloat t = pow( max(0.0, 1.0-lutVal.a), opacityExp);\n\t\t\ttTot *= t;\n\n\t\t\t// Check whether the transparency is strictly decreasing\n\t\t\tif ( (t < 0.99) && (runStart.x < 0.0) )  \n\t\t\t{ \n\t\t\t\trunStart = pos; // The voxel has some opacity, so we are starting a new run\n\t\t\t\ttBase = tTot;\n\t\t\t}\n\n\t\t\tvec3 nextPos = pos + rayStep;\n\t\t\tbool terminateRay = (tTot < TransparencySat) || any(lessThan(nextPos, BboxMin)) || any(greaterThan(nextPos, BboxMax));\n\t\t\tif ( (runStart.x >= 0.0) && ((t >= 0.99) || terminateRay) ) // We are ending a run\n\t\t\t{\n\t\t\t\tfloat delta = tBase - tTot; \n\t\t\t\tfloat improved = float(delta > bestDelta);\n\t\t\t\tbestDelta = mix(bestDelta, delta, improved);\n\t\t\t\tmaxLoc = mix(maxLoc, runStart, improved);\n\t\t\t\trunStart = vec3(-1.0); \t\n\t\t\t\tterminateRay = terminateRay || (bestDelta >= tTot);  \t\t\t\n\t\t\t}\n\t\t\tif (terminateRay) { break; }\t\t\n\n\t\t\tpos = nextPos;\n\t\t}\n\t\t\n\t\t// Encode the max location in the output color\t\n\t\toutColor = encodeVec3(maxLoc);\n\t}\n\treturn true;\n}\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Gets the pixel value at a given volume point, normalized to the\n//   range [0,1].\n//\n///////////////////////////////////////////////////////////////////////////////\nfloat getNormalizedPixVal(vec3 pos)\n{\n\t// Sample the volume\n\tvec4 samp = texture(uVolumeSampler, pos);\n\n\t// Combine color channels to decode the pixel value\n\tbool inBounds = all(lessThanEqual(pos,Ones)) && all(greaterThanEqual(pos,Zeros));\n\tfloat pixVal = dot(samp.rg, PixConvert) * float(inBounds);\t\n\n\t// Normalize\n\treturn clamp(pixVal*PixScale - PixOffset, 0.0, 1.0);\t\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Gets the distance to the nearest border, and the normal vector of\n//   that border.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid getBorderInfo(vec3 pos, vec3 rayDir, vec3 pos_s, float borderThresh, vec3 gradDelta)\n{\n\t// Check the volume borders\n\tfloat minDist = borderThresh + 1.0;\n\tbool isSlabBorder = false;\n\t\n\tfor (int i=0; i<3; i++)\n\t{\n\t\tfloat p = abs(pos[i]);\n\t\tif (p < minDist) { minDist = p;  BorderNormal = UnitVectors[i]; }\t\n\n\t\tp = abs(1.0 - pos[i]);\n\t\tif (p < minDist) { minDist = p;  BorderNormal = -1.0*UnitVectors[i]; }\t\n\n        #ifdef CLIP_TO_SLAB\t\n\t\tp = abs( SlabRadii[i] + pos_s[i] );\n\t\tif ( p < minDist ) { minDist = p;  BorderNormal = SlabAxes[i];  isSlabBorder = true; }\n\n\t\tp = abs( SlabRadii[i] - pos_s[i] );\n\t\tif ( p < minDist ) { minDist = p;  BorderNormal = -1.0*SlabAxes[i]; isSlabBorder = true; }\t\n        #endif\t\t\t\t\t\t\t\n\t}\t\n\n\tbool doBorderMod    = (minDist < borderThresh);\n\tfloat cosFactor     = max( 0.0, dot(normalize(BorderNormal),rayDir) );\n\tBorderNormalWeight  = doBorderMod ? (1.0 - minDist/borderThresh)*pow(cosFactor,0.25) : 0.0;\n\tBorderReflectanceWt = doBorderMod ? 1.0 - 0.75*pow(cosFactor,4.0) : 1.0;\n\tGradOffset          = (doBorderMod && !isSlabBorder ) ? BorderNormal*gradDelta : Zeros;\n}\n\n\n#ifdef RENDER_SHADOWS\n///////////////////////////////////////////////////////////////////////////////\n//\n// Implements percentage-closer filtering for soft shadow edges.\n//\n///////////////////////////////////////////////////////////////////////////////\nfloat calcShadowWeight(vec3 pos, int lightIndex)\n{\n\t// Initialize constants\n\tfloat step = uLights[lightIndex].shadowSoftness * 0.0054;\n\tfloat dx = step / max(1.0, uOutVpSize.x/uOutVpSize.y);\n\tfloat dy = step / max(1.0, uOutVpSize.y/uOutVpSize.x);\n\n\t// Get the shadow-map coordinates of the input point\n\tvec4 pt = 0.5*(uLights[lightIndex].shadowMvp * vec4(pos, 1.0) + 1.0);\n\n\t// Apply a random offset to reduce banding artifacts\n\tfloat px0 = pt.x + dx * 0.8*(rand(pos.xz) - 0.5); \n\tfloat py0 = pt.y + dy * 0.8*(rand(pos.yz) - 0.5);\n\t\t\n\t// Apply a small z-offset to prevent self-shadowing\t\n\tfloat pzd = pt.z - 1.0/uVolShape[0]; \n\n\tpx0 *= uShadowTxScale.x;\n\tpy0 *= uShadowTxScale.y;\n\tdx *= uShadowTxScale.x;\n\tdy *= uShadowTxScale.y;\n\n\t// Tabulate sampling points\n\tfloat pxp1 = px0  + dx;\n\tfloat pxm1 = px0  - dx;\n\tfloat pxp2 = pxp1 + dx;\n\tfloat pxm2 = pxm1 - dx;\n\tfloat pxp3 = pxp2 + dx;\n\tfloat pxm3 = pxm2 - dx;\n\tfloat pxp4 = pxp3 + dx;\n\tfloat pxm4 = pxm3 - dx;\n\n\tfloat pyp1 = py0  + dy;\n\tfloat pym1 = py0  - dy;\n\tfloat pyp2 = pyp1 + dy;\n\tfloat pym2 = pym1 - dy;\n\tfloat pyp3 = pyp2 + dy;\n\tfloat pym3 = pym2 - dy;\n\tfloat pyp4 = pyp3 + dy;\n\tfloat pym4 = pym3 - dy;\n\n\tfloat fL = float(lightIndex);\n\tpy0  = 0.5*(py0 + fL);\n\tpyp1 = 0.5*(pyp1 + fL);\n\tpym1 = 0.5*(pym1 + fL);\n\tpyp2 = 0.5*(pyp2 + fL);\n\tpym2 = 0.5*(pym2 + fL);\n\tpyp3 = 0.5*(pyp3 + fL);\n\tpym3 = 0.5*(pym3 + fL);\n\tpyp4 = 0.5*(pyp4 + fL);\n\tpym4 = 0.5*(pym4 + fL);\n\t \n\t// Unrolled loop for better performance:\n\tvec4 smTexVal = texture(uShadowSampler, vec2(px0, py0));\n\tfloat smDepth = dot(smTexVal.rg, ToFloat16);\n\tfloat wt = float(pzd > smDepth);\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pym4)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pym4)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pym4)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pym3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pym3)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pym2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pym2)).rg, ToFloat16 ));\t\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm4, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pym1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp4, pym1)).rg, ToFloat16 ));\n\t\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm4, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, py0)).rg, ToFloat16 ));\n\t//-------------------------------------------------------------------------------\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, py0)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp4, py0)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm4, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pyp1)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp4, pyp1)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pyp2)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pyp2)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm3, pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm2, pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp2, pyp3)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp3, pyp3)).rg, ToFloat16 ));\n\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxm1, pyp4)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(px0,  pyp4)).rg, ToFloat16 ));\n\twt += float(pzd > dot( texture(uShadowSampler, vec2(pxp1, pyp4)).rg, ToFloat16 ));\n\n\treturn wt/61.0;\t\t\n}\n#endif\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Gets a random number given a 2-component seed.\n//\n///////////////////////////////////////////////////////////////////////////////\nfloat rand(vec2 xy)\n{\n    return fract(sin(dot(xy, vec2(12.9898,78.233))) * 43758.5453);\n}\n"+
c.ShaderCode2.Common.initializeSlabInfo+c.ShaderCode2.Common.isMasked+c.ShaderCode2.Common.encodeVec3})(window.BigLime=window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.winLevel_vert_2="#version 300 es\n// winLevel_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float;\nprecision highp int;\n\nuniform float uWinWidth;\nuniform float uWinLevel;\nin vec4       aPosition;\nout float     vPixScale;\nout float     vPixOffset;\nout vec2      vTexCoord;\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Convert from clip space to texture coordinates\n    vTexCoord = (aPosition.xy + 1.0)*0.5;\n\n    // Compute the scale and offset factor for the window/level transform\n    float level = uWinLevel*(257.0/65535.0);\n    float width = uWinWidth*(257.0/65535.0);\n\tvPixScale = 1.0/(width + 0.001);\n\tvPixOffset = level - width/2.0;\n\n    gl_Position = aPosition;    \n}\n";c.ShaderCode.winLevel_frag_2=
"#version 300 es\n// winLevel_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float;\nprecision highp int;\n\nuniform sampler2D uWLSampler;\nuniform sampler2D uLutSampler;\nuniform int       uPassThruMode;\nuniform int       uColorMapIndex;\nuniform vec4      uMarkerColor;\nin float          vPixScale;\nin float          vPixOffset;\nin vec2           vTexCoord;\nout vec4          outColor;\n\nvoid main()\n{\n\t// Read the output from the renderer\n\tvec4 textureVal = texture(uWLSampler, vTexCoord);\n\n\tif (uPassThruMode > 0) \n\t{\n\t\t// Pass-thru mode means we don't modify the pixels\n\t\toutColor = textureVal;\n\t}\n\telse\n\t{\n\t\tif (textureVal.b != 0.0) \n\t\t{\n            // Just render the marker\n\t\t\toutColor = vec4( ((textureVal.b+2.0)/3.0) * uMarkerColor.rgb, uMarkerColor.a );\n\t    }\n\t\telse\n\t\t{\n\t\t    // Get the raw pixel value\n\t\t\tfloat rawPixVal = textureVal.r + 256.0*textureVal.g;\n\t\t\tif (rawPixVal == 0.0) \n\t\t\t{\n\t\t\t    // We're in the background\n\t\t\t\toutColor = vec4(0.0, 0.0, 0.0, 1.0); \n\t\t\t} \n\t\t\telse \n\t\t\t{\n\t\t\t    // Apply the window/level transform \n\t\t\t\tfloat wlPixVal = clamp( vPixScale*(rawPixVal - vPixOffset), 0.0, 1.0 );\n\t\t\t\tif (uColorMapIndex == 0) {\t\n\t\t\t\t\toutColor = vec4(wlPixVal, wlPixVal, wlPixVal, 1.0);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t    // Apply the lookup table\n\t\t\t\t\toutColor = texture(uLutSampler, vec2(LUT_TX_XSCALE*wlPixVal, LUT_TX_YOFFSET + float(uColorMapIndex)*LUT_TX_YSCALE));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\t// Recombine the R and G color channels into a 16-bit pixel value\n\t\tfloat rawPixVal = textureVal.r + 256.0*textureVal.g;\n\n\t\tif (textureVal.b == 0.0) {\n\t\t    // Apply the window/level transform\n\t\t\tif (uColorMapIndex == 0) {\n\t\t\t\tfloat wlPixVal = (rawPixVal == 0.0) ? 0.0 : clamp( vPixScale*(rawPixVal - vPixOffset), 0.0, 1.0 );\n\t\t\t\toutColor = vec4(wlPixVal, wlPixVal, wlPixVal, 1.0);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfloat wlPixVal = (rawPixVal == 0.0) ? 0.0 : clamp( vPixScale*(rawPixVal - vPixOffset), 0.0, 1.0 );\n\t\t\t\toutColor = texture(uLutSampler, vec2(LUT_TX_XSCALE*wlPixVal, LUT_TX_YOFFSET + float(uColorMapIndex)*LUT_TX_YSCALE));\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// Render the marker\n\t\t\toutColor = vec4( ((textureVal.b+2.0)/3.0) * uMarkerColor.rgb, uMarkerColor.a );\n\t\t}\n\t}\n}\n"})(window.BigLime=
window.BigLime||{});
(function(c,t){c.ShaderCode=c.ShaderCode||{};c.ShaderCode.xray_vert_2="#version 300 es\n// xray_vert_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\n\nuniform mat4  uMvpTransform;\nuniform mat4  uMvpInvTransform;\nin vec4       aPosition;\nout vec3      vRayStartT;\nout vec3      vRayDirT;\n\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n    // Transform the input vertex from world-space to clip-space. \n    gl_Position = uMvpTransform * aPosition;\n\n\t// Pass the ray's starting point and direction vector (in texture coordinates) to the fragment shader.\n\tvRayStartT = aPosition.xyz;\n\tvec4 rayPrevT = uMvpInvTransform * (gl_Position - vec4(0.0, 0.0, 1.0, 0.0));\n\tvRayDirT = vRayStartT - rayPrevT.xyz/rayPrevT.w;\n}\n";c.ShaderCode.xray_frag_2=
"#version 300 es\n// xray_frag_2\n\n//<<SYMBOL_DEFS>>//\n\nprecision highp float; // We need highp to accurately specify locations in large textures\nprecision highp int;\nprecision highp sampler3D;\n\n// Uniforms and varyings\nuniform sampler3D  uVolumeSampler;\nuniform sampler3D  uVolMaskSampler;\nuniform sampler2D  uLutSampler;\nuniform bool   uUseLut;\nuniform bool   uApplyVolMask;\nuniform float  uOpacityRange[2];\nuniform int    uBitsPerPixel;\nuniform float  uRayStepSize;\nuniform vec3   uVolShape;\nuniform float  uSlabInfo[24];\nin  vec3 vRayStartT;\nin  vec3 vRayDirT;\nout vec4 outColor;\n\n// Constants\nconst float BBoxTol = 0.002; \nconst vec3 BboxMin  = vec3(-BBoxTol);\nconst vec3 BboxMax  = vec3(1.0 + BBoxTol);\nconst vec3 Zeros    = vec3(0.0);\nconst vec3 Ones     = vec3(1.0);\n\n// Globals\nvec2 PixConvert;\nfloat PixScale, PixOffset;\nvec3 VolAspect;\n#ifdef CLIP_TO_SLAB\nvec3 SlabRadii, SlabAxes[3];\nmat4 SlabXfrm;\n#endif\n\n// Function prototypes\nvoid calcXrayValue(vec3);\nbool isMasked(vec3);\n#ifdef CLIP_TO_SLAB\nvoid  initializeSlabInfo(vec3, vec3, out float);\n#endif\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Program entry point.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid main()\n{\n\t// Initialize globals\n\tPixConvert = vec2(1.0, 256.0*float(uBitsPerPixel > 8));\n\tPixScale   = 255.0 * uOpacityRange[1];\n\tPixOffset  = uOpacityRange[0] * uOpacityRange[1];\n\t\t\n    // Perform ray casting\n\tvec3 rayDir = normalize(vRayDirT);\t\n    calcXrayValue(rayDir);\n}\n\n\n///////////////////////////////////////////////////////////////////////////////\n//\n// Computes the attenuated x-ray value along a ray.\n//\n///////////////////////////////////////////////////////////////////////////////\nvoid calcXrayValue(vec3 rayDir)\n{\n\tVolAspect = uVolShape/max(max(uVolShape.x, uVolShape.y), uVolShape.z);\n\n\t// Initialize the ray\n\tvec3 pos = vRayStartT;\n\tvec3 rayStep = rayDir*uRayStepSize;\n\n\t// Initialize slab variables\n\t#ifdef CLIP_TO_SLAB\n\tbool enteredSlab = false;\n\tfloat slabOffset;\n\tinitializeSlabInfo(rayDir, pos, slabOffset);\n\tif (slabOffset - 0.05 > 0.0) { pos += (slabOffset - 0.05)*rayDir; }\n\t#endif\t\n\n\t// Walk along the ray\n\tfloat totalAtten = 0.0;\n\tint NumSteps = int(sqrt(3.0)/uRayStepSize + 0.5);\n\tfor (int i = 0; i < NumSteps; i++)\n\t{\t\t\n\t\t// Check whether the ray has exited the volume\n\t\tif ( any(lessThan(pos,BboxMin)) || any(greaterThan(pos,BboxMax)) ) { break; }\t\t\n\n\t\t// Honor any slab constraints\n\t\t#ifdef CLIP_TO_SLAB\n\t\tvec3 pos_s = (SlabXfrm * vec4(pos, 1.0)).xyz;\n\t\tif ( any(greaterThan(abs(pos_s), SlabRadii)) ) {\n\t\t\tif ( enteredSlab ) { break; }\n\t\t\tpos += rayStep;\n\t\t\tcontinue;\n\t\t}\n\t\tenteredSlab = true;\n\t\t#endif\n\t\t\n\t\t// Add the current pixel value to the total\n\t\tif (!uApplyVolMask || !isMasked(pos)) {\n\t\t\tvec4 samp = texture(uVolumeSampler, pos);\n\t\t\tfloat pixVal = dot(samp.rg, PixConvert);\t\n\t\t\tif (uUseLut) {\n\t\t\t\tfloat lutArg = clamp(PixScale*pixVal - PixOffset, 0.0, 1.0);\t\n\t\t\t\tpixVal = 257.0 * texture(uLutSampler, vec2(lutArg, LUT_TX_YOFFSET)).a; \n\t\t\t}\n\t\t\ttotalAtten = min(255.0, totalAtten + uRayStepSize*pixVal );\t\n\t\t}\n\n\t\tpos += rayStep;\n\t}\n\n\t// Encode the 16-bit pixel value in two 8-bit color channels\t\n\ttotalAtten *= 255.0;\n\ttotalAtten = max(totalAtten, 1.0); // Do't allow zero, as we use zero to indicate background\n\tfloat highByte = floor(totalAtten/256.0);\n\tfloat lowByte = totalAtten - 256.0*highByte;\n\toutColor = vec4(lowByte/255.0, highByte/255.0, 0.0, 1.0);\n}\n"+
c.ShaderCode2.Common.initializeSlabInfo+c.ShaderCode2.Common.isMasked})(window.BigLime=window.BigLime||{});
